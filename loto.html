<!DOCTYPE html>
<html lang="fr">

<head>
  <!-- Projet sous licence MIT ‚Äì Voir fichier LICENSE.
	Simulation p√©dagogique et ind√©pendante, sans affiliation ni approbation de la Fran√ßaise des Jeux (FDJ).
	Aucune mise r√©elle, aucun gain, aucune collecte de donn√©es personnelles. -->
  <meta charset="UTF-8">
  <title>Simulateur Loto</title>
  <meta name="description"
    content="Simulateur p√©dagogique de Loto : jouez des grilles, suivez vos statistiques et visualisez les gains sans aucun enjeu r√©el.">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
  <script src="quiz-loto.js"></script>
  <link rel="shortcut icon" type="image/x-icon" href="favicon.ico">
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0px;
      padding-left: 30px;
      padding-right: 30px;
    }

    .main-container {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      flex-wrap: wrap;
      gap: 10px;
    }

    .left-column {
      flex: 1;
      max-width: 45%;
      text-align: left;
    }

    .right-column {
      flex: 1;
      max-width: 45%;
      text-align: left;
    }

    .form-group,
    .display,
    .compteur {
      font-size: 1.1em;
      margin: 10px 0;
    }

    input,
    button,
    select,
    textarea {
      padding: 6px 12px;
      font-size: 1em;
      margin: 5px;
    }

    .ticket {
      border: 1px solid #aaa;
      padding: 8px;
      margin: 5px 0;
      width: fit-content;
    }

    .winning {
      background-color: #cfc;
    }

    #chanceDisplay {
      font-weight: bold;
      margin: 10px 0;
    }

    #resultat {
      border: 2px solid #008ccd;
      padding: 10px;
      margin: 10px 0;
    }

    #statsContainer {
      margin-top: 20px;
    }

    #statsContainer ul {
      list-style: none;
      padding: 0;
    }

    #statsContainer li {
      margin: 5px 0;
    }

    #multichanceAndMyMillonContainer {
      display: flex;
      align-items: center;
    }

    .info-icon {
      display: inline-block;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background-color: #ccc;
      text-align: center;
      line-height: 16px;
      font-size: 12px;
      margin-left: 5px;
      cursor: help;
    }

    #speedControlGroup {
      display: flex;
      align-items: center;
      justify-content: flex-start;
      gap: 10px;
      margin: 10px 0;
    }

    #speedValueLabel {
      color: gray;
    }

    #fireworksContainer {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 9999;
    }

    .firework {
      position: absolute;
      width: 4px;
      height: 4px;
      background: radial-gradient(circle, var(--color) 0%, var(--color-dark) 70%);
      border-radius: 50%;
      opacity: 1;
      animation: firework 2.0s ease-out forwards;
      box-shadow: 0 0 15px var(--color);
    }

    @keyframes firework {
      0% {
        transform: scale(1);
        opacity: 1;
      }

      50% {
        opacity: 1;
      }

      100% {
        transform: translate(var(--tx), var(--ty)) scale(3);
        opacity: 0;
      }
    }

    .sound-toggle {
      cursor: pointer;
      margin-left: 0px;
      font-size: 24px;
      vertical-align: middle;
    }

    .sound-toggle span {
      display: inline-block;
    }

    .icons-bar {
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    #stopMyMillonWinGroup {
      margin-left: 22px;
      margin-top: 0;
      font-size: 0.95em;
      display: none;
    }

    .number-ball,
    .star-ball {
      display: inline-flex;
      justify-content: center;
      align-items: center;
      width: 30px;
      height: 30px;
      margin: 2px 0px;
      font-size: .85em;
      font-weight: bold;
      color: #fff;
      position: relative;
      vertical-align: middle;
      user-select: none;
    }

    .number-ball {
      background: #047dff;
      border-radius: 50%;
    }

    .star-ball {
      background: #e35050;
      border-radius: 50%;
    }

    .match {
      opacity: 1 !important;
    }

    .semi {
      opacity: 0.45;
    }

    #ticketsContainer {}

    #ticketsContainer .ticket {
      display: inline-block;
      margin: 6px 0;
      box-sizing: border-box;
    }

    #ticketsContainer.cols-2 {
      display: grid;
      grid-template-columns: repeat(2, minmax(320px, 1fr));
      gap: 12px;
    }

    #ticketsContainer.cols-2 .ticket {
      display: block;
      width: 100%;
      margin: 0;
    }

    #resultat,
    .ticket {
      word-break: break-word;
      white-space: normal;
    }

    .display-toggle {
      cursor: pointer;
      margin-left: 0px;
      font-size: 24px;
      user-select: none;
      vertical-align: middle;
    }

    body.plain-display .number-ball,
    body.plain-display .star-ball {
      background: none !important;
      color: #111 !important;
      font-family: inherit !important;
      font-size: inherit !important;
      font-weight: normal !important;
      letter-spacing: 0 !important;
      border-radius: 0 !important;
      box-shadow: none !important;
      width: auto !important;
      height: auto !important;
      padding: 0 2px !important;
      margin: 0 2px !important;
      opacity: 1 !important;
      vertical-align: baseline !important;
    }

    body.plain-display .number-ball.semi,
    body.plain-display .star-ball.semi {
      color: #111 !important;
      opacity: 1 !important;
    }

    body.plain-display .number-ball.match,
    body.plain-display .star-ball.match {
      color: #159f13 !important;
      font-weight: bold !important;
      opacity: 1 !important;
    }

    body.plain-display .star-ball::before {
      display: none !important;
    }

    body.plain-display .number-ball,
    body.plain-display .star-ball {
      font-family: inherit !important;
      font-size: inherit !important;
      margin-right: 0 !important;
      word-spacing: 0 !important;
    }

    body.plain-display .number-ball,
    body.plain-display .star-ball {
      display: inline-block !important;
    }

    body.plain-display .number-ball,
    body.plain-display .star-ball {
      letter-spacing: 0 !important;
    }

    body.plain-display .ticket span {
      font-family: inherit !important;
      font-size: inherit !important;
    }

    body.plain-display .ticket {
      font-family: inherit;
      font-size: inherit;
      word-spacing: 0 !important;
    }

    body.plain-display .number-ball.match,
    body.plain-display .star-ball.match,
    body.plain-display .match {
      color: #159f13 !important;
      font-weight: bold !important;
      opacity: 1 !important;
    }

    .compteur {
      white-space: nowrap;
    }

    @media (max-width: 785px) {
      .main-container {
        flex-direction: column;
      }

      .left-column,
      .right-column {
        max-width: 100%;
      }
    }

    #examplesModal ul li {
      margin-bottom: 0.7em;
    }

    #examplesModal ul {
      list-style: none;
      padding-left: 0;
    }

    #detailsList li:first-child {
      margin-bottom: .7em;
    }

    .hist-pos {
      background: #e6fae6;
      border-color: #159f13;
    }

    .hist-neg {
      background: #ffecec;
      border-color: #e53935;
    }

    .hist-pos .solde {
      color: #159f13;
    }

    .hist-neg .solde {
      color: #e53935;
    }

    .hist-jack {
      background: #e6fae6;
      border-color: #fdd835;
    }

    .hist-jack .solde {
      color: #159f13;
      font-weight: bold;
    }

    .history-advice {
      font-size: 0.78em;
      color: #888;
      margin: 8px 0 4px;
    }

    .wrench-icon {
      cursor: help;
      user-select: none;
      display: inline-block;
      line-height: 1;
      font-size: 1.25em;
    }

    #showCombinationNumber+label {
      margin-right: 31px;
    }

    #physicalRandomCheckbox+label {
      margin-right: 10px;
    }

    #frequencyContainer {
      display: none;
      margin-top: 60px;
    }

    .freq-label {
      margin: 6px 0 4px;
      color: #222;
    }

    .freq-grid {
      display: grid;
      grid-template-columns: repeat(10, minmax(36px, 1fr));
      gap: 6px;
      max-width: 440px;
    }

    .freq-item {
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .freq-count {
      font-size: .78em;
      color: #555;
      margin-top: 2px;
    }

    #frequencyContainer {
      display: none;
      margin-top: 60px;
    }

    .freq-label {
      margin: 6px 0 4px;
      color: #222;
    }

    .freq-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(42px, 1fr));
      gap: 8px;
      max-width: 580px;
    }

    .freq-item {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
	.number-ball.last-draw,
	.star-ball.last-draw {
	  outline: 3px solid #d4af37;
	  outline-offset: 0;
	}
	
	.quiz-correct { color:#159f13; font-weight:bold; }
    .quiz-wrong { color:#e53935; font-weight:bold; }
    .quiz-choice { text-align:left; }
    #quizChoices button { text-align:left; padding:6px 10px; }
	
	.quiz-choice { text-align:left; padding:6px 10px; border:1px solid #ccc; border-radius:6px; }
	.quiz-choice:disabled { opacity:1; cursor:default; }

	.quiz-choice--correct-picked { background:#dff6e1; border-color:#159f13; color:#0a6310; font-weight:600; }
	.quiz-choice--correct-true  { background:#eefceb; border-color:#5cb85c; color:#146c1b; font-weight:600; }
	.quiz-choice--wrong-picked  { background:#ffe1e1; border-color:#e53935; color:#a31414; font-weight:600; }

	
  </style>
</head>

<body>
  <div class="main-container">
    <div class="left-column">
      <h1>
        Simulation Loto
        <span class="icons-bar">
          <span id="soundToggle" class="sound-toggle">
          </span>

          <span id="displayToggle" class="display-toggle" title="Basculer l‚Äôaffichage des boules / affichage texte">
          </span>
        </span>
      </h1>

      <div class="section">
        <div class="form-group">
          <label for="modeSelect">Mode :</label>
          <select id="modeSelect">
            <option value="flash" selected>Flash (tickets al√©atoires)</option>
            <option value="custom">Personnalis√© (d√©finir mes propres grilles)</option>
			<option value="quiz">Quiz (QCM Loto)</option>
          </select>
        </div>
        <div class="form-group" id="flashSettings">
          <label for="ticketNumbersCount">Nombre de num√©ros (min 5, max 49) :</label>
          <input type="number" id="ticketNumbersCount" value="5" min="5" max="49"><br>
          <label for="ticketStarsCount">Nombre d'Chance (min 1, max 10) :</label>
          <input type="number" id="ticketStarsCount" value="1" min="1" max="10">
        </div>
        <div class="form-group" id="customSettings" style="display:none;">
          <label for="customGrids">
            Mes grilles personnalis√©es :<br>
            ‚Ä¢ Grille compl√®te : <em>1,2,3,4,5 ; 1</em><br>
            ‚Ä¢ Ou bien : identifiant unique, ex. <em>12345678</em>
          </label>
          <br>
          <textarea id="customGrids" rows="4" cols="42" placeholder="Une grille par ligne"></textarea>
          <div
            style="margin-top: 2px; display: flex; align-items: center; gap: 4px; font-size: 1em; padding-bottom: 6px;">
            <label for="nbGrillesAuto">G√©n√©rer x grilles :</label>
            <input type="number" id="nbGrillesAuto" value="3" min="1" max="100"
              style="width: 50px; padding: 3px 6px; font-size: 1em;">
            <button id="generateGridsBtn" style="padding: 4px 10px; font-size: 0.9em;">G√©n√©rer</button>
            <button id="clearCustomGridsBtn" style="padding: 4px 10px; font-size: 0.9em;">Clear</button>
			<span id="customPriceDisplay" style="color: gray; font-weight: normal; margin-left:6px;">
  Prix : -- ‚Ç¨
</span>
          </div>
        </div>
		<div class="form-group" id="quizSettings" style="display:none;">
		  <div id="quizContainer" style="border:1px solid #ccc; padding:10px; border-radius:8px; max-width:680px;">
			<div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:8px;">
			  <strong>Quiz Loto</strong>
			  <span id="quizScore" style="color:#555;">Score : 0 / 0</span>
			</div>
			<div id="quizQuestion" style="font-size:1.05em; margin-bottom:8px;">
			  Cliquez sur ¬´ Nouvelle question ¬ª pour commencer.
			</div>
			<div id="quizChoices" style="display:flex; flex-direction:column; gap:6px;"></div>
			<div id="quizFeedback" style="margin-top:8px; min-height:20px;"></div>
			<div style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap;">
			  <button id="quizNextBtn">Nouvelle question</button>
			  <a id="quizSuggestLink" href="#suggest" style="display:none;"></a>
			  <button id="quizRestartBtn" style="display:none;">Recommencer</button>
			</div>
		  </div>
		</div>

        <div class="form-group" id="ticketsCountGroup" style="display: flex; align-items: center; gap: 12px;">
          <label for="numTickets">Nombre de tickets par tirage :</label>
          <input type="number" id="numTickets" value="1" min="1" style="width: 60px;">
          <span id="priceDisplay" style="color: gray; font-weight: normal;">Prix : -- ‚Ç¨</span>
        </div>
        <div class="form-group" style="align-items: center; gap: 8px;">
          <label for="stopNumbers" style="margin-right: 6px;">
            Stopper si au moins&nbsp;X num√©ros corrects&nbsp;:
          </label>
          <input type="number" id="stopNumbers" value="5" min="0" max="5" style="width: 37px;">
          <input type="number" id="stopStars" value="1" min="0" max="1" style="width: 37px;">
        </div>
        <div class="form-group">
          <input type="checkbox" id="stopAfterYearsCheckbox">
          <label for="stopAfterYearsCheckbox">Stopper si on d√©passe X ann√©es :</label>
          <input type="number" id="stopAfterYearsInput" value="50" min="1" style="width:80px;">
        </div>
        <div class="form-group">
          <input type="checkbox" id="stopNegativeGainCheckbox">
          <label for="stopNegativeGainCheckbox">Stopper si le solde est √† :</label>
          <input type="number" id="stopNegativeGainThreshold" value="-10000" step="0.01" style="width:100px;"
            title="Pour un seuil positif, saisir +1000 ou 1000 ; pour un seuil n√©gatif, saisir -10000">
        </div>
        <div class="form-group" id="speedControlGroup">
          <label for="speedSlider">Vitesse :</label>
          <input type="range" id="speedSlider" min="1" max="100" value="50" list="tickmarks">
          <datalist id="tickmarks">
            <option value="50" label="50%"></option>
          </datalist>
          <span id="speedValueLabel">(Tirage = 1, D√©lai = 1000 ms)</span>
        </div>

        <div style="display: flex; align-items: center; gap: 20px; margin-bottom: 10px;">
          <div>
            <input type="checkbox" id="myMillonCheckbox" checked>
            <label for="myMillonCheckbox">
              Codes Loto <span class="info-icon" title="L'option Code Loto‚ÄØ: Chaque lundi, environ 2 millions de grilles sont jou√©es, 3 millions le mercredi, et 4 millions le samedi.
√Ä chaque tirage, 10 codes gagnants sont tir√©s au sort parmi toutes les grilles jou√©es.

Chaque code gagnant remporte 20.000‚ÄØ‚Ç¨‚ÄØ!">i</span>
            </label>
          </div>

          <div>
            <input type="checkbox" id="multichanceCheckbox">
            <label for="multichanceCheckbox">
              Multichance <span class="info-icon" title="L'option Multichance : Il permet de r√©duire votre mise en r√©partissant votre investissement sur plusieurs parts.
Cela diminue le co√ªt par ticket, mais r√©duit √©galement les gains proportionnellement au nombre de parts d√©tenues.
Cette option est utilis√©e seulement avec une dizaine de grilles multiples.

Exemple : 10 grilles multiples (6 num√©ros, 10 Chance), 1 √† 10 parts sur 200">i</span>
            </label>
          </div>

          <div>
            <input type="checkbox" id="smartDrawCheckbox">
		<label for="smartDrawCheckbox">
		  Type de ticket
		  <span class="info-icon" title="Active la s√©lection automatique des num√©ros selon diff√©rents crit√®res :

‚Ä¢ Les moins tomb√©s (depuis le d√©but) : privil√©gie les boules observ√©es comme les plus rares.
‚Ä¢ Les plus tomb√©s  (depuis le d√©but) : privil√©gie au contraire les num√©ros les plus fr√©quents.
‚Ä¢ Mixte (moiti√© moins tomb√©s et plus tomb√©s ) : combine raret√© et fr√©quence.
‚Ä¢ Anniversaire : limite les num√©ros possibles √† 1‚Äì31, comme des dates de naissance.
‚Ä¢ Pairs / Impairs √©quilibr√©s : impose un √©quilibre (ex. 2‚Äì3 ou 3‚Äì2).
‚Ä¢ Petits (1‚Äì25) / Grands (26‚Äì49) : r√©partit les num√©ros entre petites et grandes valeurs.
‚Ä¢ Avec suite (2‚Äì3 num√©ros cons√©cutifs) : force au moins une courte suite (p. ex. 12‚Äì13 ou 34‚Äì35‚Äì36).
‚Ä¢ Somme proche de la moyenne : favorise une somme totale autour de ~125 (pour 5 num√©ros).

üí° Ces approches modifient seulement la fa√ßon de choisir les num√©ros.
Chaque tirage reste ind√©pendant et tous les num√©ros gardent la m√™me probabilit√© de sortir.">i</span>
		</label>


          </div>
        </div>
        <div style="margin-top:8px; ">
          <input type="checkbox" id="showCombinationNumber">
          <label for="showCombinationNumber">
            Id unique
            <span class="info-icon" title="Afficher pour chaque grille ou tirage son identifiant unique.
Permet d‚Äôidentifier pr√©cis√©ment une combinaison parmi les 19‚ÄØ068‚ÄØ840 possibles au loto classique.

Utile pour analyser, comparer, et r√©aliser le nombre immense de combinaisons possibles.">
              i
            </span>
            </span>
          </label>
          <input type="checkbox" id="physicalRandomCheckbox">
          <label for="physicalRandomCheckbox">
            Hasard physique
            <span class="info-icon" title="Quand cette option est coch√©e :
‚Ä¢ Math.random() est remplac√© par une source de hasard cryptographiquement s√ªre (window.crypto).
‚Ä¢ Les boules sont tir√©es comme dans un tambour : au hasard, sans remise, via Fisher-Yates.
C‚Äôest ce qui se rapproche le plus d‚Äôun tirage physique dans un navigateur.

‚ö†Ô∏è Ce mode provoque des latences plus ou moins importantes si la vitesse
de tirage est beaucoup trop rapide.">i</span>
          </label>

          <input type="checkbox" id="showFrequenciesCheckbox">
          <label for="showFrequenciesCheckbox">
            Fr√©quence boules
            <span class="info-icon" title="Affiche depuis le d√©but de la simulation en cours
combien de fois chaque boule (1‚Äì49) et chaque Chance (1‚Äì10) a √©t√© tir√©e.">
              i
            </span>
          </label>
        </div>

        <div class="form-group" id="stopMyMillonWinGroup"
          style="margin-left: 0px; margin-bottom: 0px; margin-top: 5px;">
          <input type="checkbox" id="stopMyMillonWinCheckbox">
          <label for="stopMyMillonWinCheckbox">Stopper si on gagne un code loto</label>
        </div>

        <div id="smartDrawSettings" style="margin-left: 0px; margin-top: 12px; display: none;">
		  <label for="smartTypeSelect">Type de s√©lection :</label>
		  <select id="smartTypeSelect">
			<option value="frequence_total">Les moins tomb√©s (d√©but le d√©but)</option>
			<option value="frequence_total_plus">Les plus tomb√©s (d√©but le d√©but)</option>
			<option value="mixte">Mixte (moiti√© moins tomb√©s et plus tomb√©s)</option>
			<option value="anniversaire">Anniversaire (num√©ros 1 √† 31)</option>
			<option value="pair_impair">Pairs / Impairs √©quilibr√©s</option>
			<option value="petit_grand">Petits (1‚Äì25) / Grands (26‚Äì49)</option>
			<option value="consecutif">Avec suite (2‚Äì3 num√©ros cons√©cutifs)</option>
			<option value="moyenne">Somme proche de la moyenne</option>
		  </select>
		</div>

        <div class="form-group" id="multichancePartsContainer" style="display:none; margin-left:20px;">
          <label for="totalParts">Total de parts :</label>
          <input type="number" id="totalParts" value="200" min="1"><br>
          <label for="yourParts">Votre nombre de parts :</label>
          <input type="number" id="yourParts" value="1" min="1">
        </div>
        <div style="display: inline-flex; gap: 10px; margin-top: 10px;">
          <button id="startBtn">D√©marrer la simulation</button>
          <button id="stopBtn">Stop</button>
          <button id="resetBtn">Reset</button>
        </div>
        <div id="frequencyContainer">
          <div class="freq-label"><strong>Num√©ros (1‚Äì49)</strong></div>
          <div id="freqNumbers" class="freq-grid"></div>

          <div class="freq-label" style="margin-top:8px;"><strong>Chance (1‚Äì10)</strong></div>
          <div id="freqStars" class="freq-grid"></div>
		  <div id="freqControls" style="margin-top:18px; margin-bottom:12px; display:flex; align-items:center; gap:8px;">
		  <label for="freqSort" style="color:#222;">Tri :</label>
		  <select id="freqSort">
			<option value="natural">1 ‚Üí 49 (ordre naturel)</option>
			<option value="desc">Plus tomb√©es d‚Äôabord</option>
			<option value="asc">Moins tomb√©es d‚Äôabord</option>
		  </select>
		 </div>
        </div>
      </div>
    </div>
    <div class="right-column">
      <div id="chanceDisplay"></div>
      <div class="section display" id="resultat">
        <strong>Tirage :</strong><br>
        Num√©ros : --<br>
        Chance : --<br>
      </div>
      <div class="compteur" id="counter">Tirages : 0</div>
      <div class="compteur" id="timePassed">Temps √©coul√© : 0 jour</div>
      <div class="compteur" id="grillesPlayed">Grilles jou√©es : 0</div>
      <div class="compteur" id="gainDisplay">Solde : 0 ‚Ç¨</div>
      <div class="section display" id="ticketsContainer"></div>
      <canvas id="gainChart" height="150"></canvas>
      <div class="section display" id="statsContainer">
        <h3 style="margin-bottom: 0;">
          Statistiques de r√©sultats
          <span class="info-icon" title="Les gains par rang sont fixes et d√©termin√©s √† l‚Äôavance dans cette simulation. 
Il n‚Äôy a pas de partage avec d‚Äôautres joueurs, ni de cumul de jackpots etc.">i</span>
        </h3>
        <a href="#" id="editPrizesLink" style="color: #187ad2; font-size: 0.95em;">Modifier les gains par rang</a> |
        <a href="#" id="showDetails" style="color: #187ad2; font-size: 0.95em;">voir plus de d√©tails</a> |
        <a href="#" id="historyLink" style="color: #187ad2; font-size: 0.95em;">voir l'historique</a>
        <ul>
          <div id="gainLossSummary" style="margin:12px 0 8px 0;">
            <div>
              <span style="color:#222; font-weight:normal; margin-right:4px;">Bilan&nbsp;:</span>
              <span id="spentValue"></span>
              <span style="margin:0 4px; color:#888;">/</span>
              <span id="gainValue"></span>
              <span id="percentValue" style="margin-left:4px;"></span>
            </div>
            <div style="height:7px;"></div>
          </div>
          <li id="stats_myMillion" style="display: list-item;">
            Code loto : <span id="stats_myMillion_value">0</span>
            <span id="stats_myMillion_pct"></span>
            <span id="stats_myMillion_gain"></span>
          </li>
          <li>5 n¬∞ + 1 ‚óâ : <span id="stats_5_1">0</span></li>
          <li>5 n¬∞ + 0 ‚óâ : <span id="stats_5_0">0</span></li>
          <li>4 n¬∞ + 1 ‚óâ : <span id="stats_4_1">0</span></li>
          <li>4 n¬∞ + 0 ‚óâ : <span id="stats_4_0">0</span></li>
          <li>3 n¬∞ + 1 ‚óâ : <span id="stats_3_1">0</span></li>
          <li>3 n¬∞ + 0 ‚óâ : <span id="stats_3_0">0</span></li>
          <li>2 n¬∞ + 1 ‚óâ : <span id="stats_2_1">0</span></li>
          <li>2 n¬∞ + 0 ‚óâ : <span id="stats_2_0">0</span></li>
          <li>1 n¬∞ + 1 ‚óâ : <span id="stats_1_1">0</span></li>
          <li>1 n¬∞ + 0 ‚óâ : <span id="stats_1_0">0</span></li>
          <li>0 n¬∞ + 1 ‚óâ : <span id="stats_0_1">0</span></li>
          <li>0 n¬∞ + 0 ‚óâ : <span id="stats_0_0">0</span></li>
        </ul>
      </div>
    </div>
  </div>
  <div id="fireworksContainer"></div>
  <div id="prizesModal" style="display:none; position: fixed; top: 50%; left: 50%;
	transform: translate(-50%, -50%); background: white; padding: 20px;
	border: 2px solid #444; z-index: 10000; width: 360px; max-height: none;
	overflow-y: visible; box-shadow: 0 0 20px rgba(0,0,0,0.3);">
    <h3>Modifier les gains par rang</h3>
    <form id="prizesForm"></form>
    <div style="margin-top: 10px;">
      <button id="closePrizesBtn" type="button">‚ùå Fermer</button>
      <button id="resetPrizesBtn" type="button">üîÑ Reset</button>
    </div>
  </div>
  <div id="modalOverlay"
    style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.5); z-index: 9999;">
  </div>

  <div id="examplesModal" style="display:none; position:fixed; top:50%; left:50%;
				transform:translate(-50%,-50%); background:#fff; padding:20px;
				border:2px solid #444; box-shadow:0 0 20px rgba(0,0,0,.3);
				z-index:10000; width:500px; max-height:none; overflow-y:auto;">
    <div id="examplesContent"></div>

    <div style="margin-top:10px">
      <button id="closeExamplesBtn" type="button">‚ùå Fermer</button>
    </div>

  </div>


  <div id="historyModal"
    style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:9999;">
    <div
      style="background:#fff; max-width:450px; margin:80px auto; padding:20px; border-radius:8px; position:relative;">
      <h3>Historique de vos simulations</h3>
      <div id="historyTotals" style="font-weight:bold; margin:6px 0 10px 0; color:#333;">
      </div>
      <ul id="historyList" style="list-style:none; padding-left:0; margin:0; max-height:50vh; overflow:auto;">"></ul>
      <p id="historyEmptyMsg" style="color:#777; margin-top:6px; display:none;">
        (Aucun √©l√©ment pour le moment)
      </p>
      <p class="history-advice">
        Nous vous recommandons de rejouer <strong>strictement les m√™mes param√®tres</strong>
        √† chaque simulation.<br>
        Vous pourrez ainsi comparer les r√©sultats et estimer combien de personnes
        auraient gagn√© dans des conditions identiques.
      </p>
      <div style="margin-top:12px; text-align:right;">
        <button id="clearHistoryBtn">üóëÔ∏è Effacer l'historique</button>
        <button id="closeHistoryBtn">‚ùå Fermer</button>

      </div>
    </div>
  </div>

  <div id="detailsModal"
    style="display:none; position:fixed; top:50%; left:50%;
       transform:translate(-50%,-50%); background:#fff; padding:20px;
       border:2px solid #444; box-shadow:0 0 20px rgba(0,0,0,0.3); z-index:10001; width:400px; max-height:80vh; overflow-y:auto;">
    <h3>D√©tails des paliers obtenus</h3>
    <ul id="detailsList" style="padding-left:1em;"></ul>
    <button id="closeDetailsBtn" style="margin-top:10px;">‚ùå Fermer</button>
  </div>
  <div id="modalOverlayDetails" style="display:none; position:fixed; top:0; left:0;
       width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:10000;"></div>

  <script>

    let gainChart = null;
    let lastY;
    let lastOdds = Infinity;
    let firstOccurrence = {};
    let lastDetailsModalState = "";

    const HISTORY_KEY = 'loto_history';
    const HISTORY_MAX = 100;

    const DEFAULT_PRIZES = {
      "5_1": 3000000, "5_0": 100000,
      "4_1": 1000, "4_0": 500,
      "3_1": 50, "3_0": 20,
      "2_1": 10, "2_0": 4.4,
      "1_1": 2.2, "1_0": 0,
      "0_1": 2.2, "0_0": 0
    };

    let quizIndex = -1;
    let quizScore = 0;
    let quizTotal = 0;
	let quizAdvanceTimer = null;
	let quizAnswered = false; 
	
	window.lastSimMode = (document.getElementById("modeSelect")?.value === "custom") ? "custom" : "flash";
	function getEffectiveMode() {
	  const v = document.getElementById("modeSelect").value;
	  return (v === "quiz") ? (window.lastSimMode || "flash") : v;
	}

    function updateQuizScore() {
      const s = document.getElementById("quizScore");
      if (s) s.textContent = `Score : ${quizScore} / ${quizTotal}`;
    }

	function renderQuizQuestion(qItem) {
	  const qEl = document.getElementById("quizQuestion");
	  const cEl = document.getElementById("quizChoices");
	  const fEl = document.getElementById("quizFeedback");
	  if (!qEl || !cEl || !fEl) return;

	  if (quizAdvanceTimer) { clearTimeout(quizAdvanceTimer); quizAdvanceTimer = null; }

	  quizAnswered = false;

	  qEl.textContent = qItem.q;
	  fEl.textContent = "";
	  cEl.innerHTML = "";

	  qItem.choices.forEach((label, idx) => {
		const btn = document.createElement("button");
		btn.className = "quiz-choice";
		btn.textContent = `${String.fromCharCode(65 + idx)}. ${label}`;
		btn.addEventListener("click", () => {
		  quizAnswered = true;

		  quizTotal++;
		  const correct = (idx === qItem.answer);
		  const allBtns = [...cEl.querySelectorAll("button")];

		  if (correct) {
			quizScore++;
			fEl.textContent = "Bonne r√©ponse !";
			fEl.className = "quiz-correct";
			btn.classList.add("quiz-choice--correct-picked");
		  } else {
			fEl.textContent = `Mauvaise r√©ponse.`;
			fEl.className = "quiz-wrong";
			btn.classList.add("quiz-choice--wrong-picked");
			const goodBtn = allBtns[qItem.answer];
			if (goodBtn) goodBtn.classList.add("quiz-choice--correct-true");
		  }

		  updateQuizScore();
		  allBtns.forEach(b => b.disabled = true);

		  const delay = correct ? 2000 : 5000;
		  if (quizAdvanceTimer) clearTimeout(quizAdvanceTimer);
		  quizAdvanceTimer = setTimeout(nextQuizQuestion, delay);
		});

		cEl.appendChild(btn);
	  });
	  updateQuizScore();
	}

	let quizOrder = [];
	let quizUsedCount = 0;

	function shuffleInPlace(arr) {
	  for (let i = arr.length - 1; i > 0; i--) {
		const j = Math.floor(Math.random() * (i + 1));
		[arr[i], arr[j]] = [arr[j], arr[i]];
	  }
	  return arr;
	}

	function initQuizOrder() {
	  quizOrder = Array.from({ length: QUIZ_QUESTIONS.length }, (_, i) => i);
	  shuffleInPlace(quizOrder);
	  quizUsedCount = 0;
	}

	function nextQuizQuestion() {
	  const fEl = document.getElementById("quizFeedback");
	  const suggest = document.getElementById("quizSuggestLink");

	  if (quizIndex !== -1 && quizAnswered === false) {
		quizTotal++;
		if (fEl) { fEl.textContent = "Question pass√©e ‚Äî compt√©e faux."; fEl.className = "quiz-wrong"; }
		updateQuizScore();
	  }

		if (quizOrder.length === 0) {
		  const qEl = document.getElementById("quizQuestion");
		  const cEl = document.getElementById("quizChoices");
		  if (qEl) qEl.textContent = "";
		  if (cEl) cEl.innerHTML = "";

		  if (fEl) {
			fEl.innerHTML = "‚úÖ Toutes les questions ont √©t√© faites. "
			  + "Si vous voulez proposer de nouvelles questions, cliquez sur "
			  + "<strong>¬´ Faire une suggestion ¬ª</strong>.";
			fEl.className = "quiz-correct";
		  }

		  if (suggest) suggest.style.display = "inline";
		  const nextBtn = document.getElementById("quizNextBtn");
		  if (nextBtn) nextBtn.disabled = true;

		  const restartBtn = document.getElementById("quizRestartBtn");
		  if (restartBtn) restartBtn.style.display = "inline";

		  return;
		}

	  const newIndex = quizOrder.pop();
	  quizIndex = newIndex;
	  quizAnswered = false;
	  renderQuizQuestion(QUIZ_QUESTIONS[quizIndex]);

	  const nextBtn = document.getElementById("quizNextBtn");
	  if (nextBtn) nextBtn.disabled = false;
	  if (suggest) suggest.style.display = "none";
	  
	  const restartBtn = document.getElementById("quizRestartBtn");
	  if (restartBtn) restartBtn.style.display = "none";
	}

	function resetQuizScore() {
	  quizScore = 0;
	  quizTotal = 0;
	  if (quizAdvanceTimer) { clearTimeout(quizAdvanceTimer); quizAdvanceTimer = null; }
	  updateQuizScore();
	  const fEl = document.getElementById("quizFeedback");
	  if (fEl) { fEl.textContent = ""; fEl.className = ""; }
	}

	document.addEventListener("DOMContentLoaded", () => {
	  if (window.__quizInited) return;
	  window.__quizInited = true;

	  initQuizOrder();

	  const nextBtn = document.getElementById("quizNextBtn");
	  const restartBtn = document.getElementById("quizRestartBtn");
	  if (restartBtn) restartBtn.style.display = "none";
	  
	  if (nextBtn)
		nextBtn.addEventListener("click", () => {
		  if (quizAdvanceTimer) { clearTimeout(quizAdvanceTimer); quizAdvanceTimer = null; }
		  nextQuizQuestion();
		});

	  if (restartBtn)
		restartBtn.addEventListener("click", () => {
		  if (quizAdvanceTimer) { clearTimeout(quizAdvanceTimer); quizAdvanceTimer = null; }
		  resetQuizScore();
		  initQuizOrder();
		  const fEl = document.getElementById("quizFeedback");
		  if (fEl) fEl.textContent = "";
		  const qEl = document.getElementById("quizQuestion");
		  const cEl = document.getElementById("quizChoices");
		  if (qEl) qEl.textContent = "Cliquez sur ¬´ Nouvelle question ¬ª pour recommencer.";
		  if (cEl) cEl.innerHTML = "";
		  document.getElementById("quizNextBtn").disabled = false;
		  document.getElementById("quizSuggestLink").style.display = "none";
		  restartBtn.style.display = "none";
		});
	});


    function prizeTableIsModified() {
      for (const key in DEFAULT_PRIZES) {
        if (prizeMapping[key] !== DEFAULT_PRIZES[key]) return true;
      }
      return false;
    }

    function setCookie(name, value, options = {}) {
      const opt = { path: '/', 'max-age': 60 * 60 * 24 * 365, SameSite: 'Lax', ...options };
      let updated = encodeURIComponent(name) + '=' + encodeURIComponent(value);
      if (opt['max-age']) updated += '; max-age=' + opt['max-age'];
      if (opt.path) updated += '; path=' + opt.path;
      if (opt.SameSite) updated += '; SameSite=' + opt.SameSite;
      document.cookie = updated;
    }

    function getCookie(name) {

      const cookies = document.cookie.split(';').map(c => c.trim());
      for (const c of cookies) {
        const [key, ...v] = c.split('=');
        if (key === name) {
          return decodeURIComponent(v.join('='));
        }
      }
      return null;
    }

    function loadHistory() {
      try {
        const raw = localStorage.getItem(HISTORY_KEY);
        return raw ? JSON.parse(raw) : [];
      } catch {
        return [];
      }
    }

    function saveHistory(arr) {
      try {
        localStorage.setItem(HISTORY_KEY,
          JSON.stringify(arr.slice(0, HISTORY_MAX)));
      } catch { }
    }

    function formatDateFR(d = new Date()) {
      const dd = String(d.getDate()).padStart(2, '0');
      const mm = String(d.getMonth() + 1).padStart(2, '0');
      const yy = String(d.getFullYear()).slice(-2);
      const HH = String(d.getHours()).padStart(2, '0');
      const MM = String(d.getMinutes()).padStart(2, '0');
      return `${dd}/${mm}/${yy} - ${HH}:${MM}`;
    }

    let historySaved = false;

    function addCurrentRunToHistory() {
      if (historySaved) return;

      if (!simulationHasStarted || (count === 0 && totalGrillesJouees === 0)) return;
      const ladder = [
        "5_1", "5_0", "CODE_LOTO",
        "4_1", "4_0",
        "3_1", "3_0",
        "2_1", "2_0",
        "1_1", "1_0",
        "0_1", "0_0"
      ];

      let best = "‚Äî";

      for (const step of ladder) {
        if (step === "CODE_LOTO") {
          if (myMillionWinCount > 0) {
            best = "Code loto";
            break;
          }
        } else if (stats[step] > 0) {
          best = step.replace("_", " n¬∞ + ") + " ‚óâ";
          break;
        }
      }
      const entry = {
        date: formatDateFR(new Date()),
        tirages: count,
        temps: formatTimeInDays(count * (7 / 3)),
        grilles: totalGrillesJouees,
        solde: Number.parseFloat(String(balance)).toFixed(2),
        record: best,
        prizeModified: prizeTableIsModified()
      };


      const hist = loadHistory();
      hist.unshift(entry);
      saveHistory(hist);
      renderHistory();

      historySaved = true;
    }

    function renderHistory() {
      const list = document.getElementById('historyList');
      const empty = document.getElementById('historyEmptyMsg');
      if (!list) return;

      const hist = loadHistory();
      list.innerHTML = '';

      if (hist.length === 0) {
        empty.style.display = 'block';
        return;
      }
      empty.style.display = 'none';

      hist.forEach(item => {
        const li = document.createElement('li');

        const soldeNum = parseFloat(item.solde);
        if (soldeNum >= 1_000_000) li.classList.add('hist-jack');
        else if (soldeNum >= 0) li.classList.add('hist-pos');
        else li.classList.add('hist-neg');


        li.style.margin = '6px 0';
        li.style.border = '1px solid #ddd';
        li.style.padding = '8px';
        li.style.borderRadius = '6px';

        const ratioBrut = Number(item.grilles) / Number(item.tirages);
        const ratio = Math.round(ratioBrut);
        const ratioTxt = ratio.toLocaleString('fr-FR');
        const plurielGrille = (ratio === 1) ? 'grille' : 'grilles';

        const wrench = item.prizeModified
          ? ' <span class="wrench-icon" title="Les gains par rang ont √©t√© modifi√©s pour cette simulation">üîß</span>'
          : '';

        li.innerHTML = `
			  <div><strong>Date :</strong> ${item.date}${wrench}</div>
			  <div><strong>Tirages :</strong> ${Number(item.tirages).toLocaleString('fr-FR')}</div>
			  <div><strong>Temps √©coul√© :</strong> ${item.temps}</div>
			  <div><strong>Grilles jou√©es :</strong> ${Number(item.grilles).toLocaleString('fr-FR')}
				   <span style="color:gray;">(${ratioTxt} ${plurielGrille} par tirage)</span>
			  </div>
			  <div><strong>Pallier :</strong> ${item.record}</div>
			  <div><strong>Solde :</strong>
				   <span class="solde">
					 ${(parseFloat(item.solde)).toLocaleString('fr-FR', {
          minimumFractionDigits: 2, maximumFractionDigits: 2
        })} ‚Ç¨
				   </span>
			  </div>
			`;

        list.appendChild(li);
      });
    }


    function clearHistory() {
      saveHistory([]);
      renderHistory();
    }

    document.addEventListener('DOMContentLoaded', () => {
      renderHistory();
      const btn = document.getElementById('clearHistoryBtn');
      if (btn) btn.addEventListener('click', clearHistory);
    });

    function updateDetailsModalIfOpen() {
      const modal = document.getElementById('detailsModal');
      if (modal.style.display !== 'block') return;

      const allPaliers = [
        { key: 'myMillion', label: 'Code loto' },
        { n: 5, s: 1 }, { n: 5, s: 0 },
        { n: 4, s: 1 }, { n: 4, s: 0 },
        { n: 3, s: 1 }, { n: 3, s: 0 },
        { n: 2, s: 1 }, { n: 2, s: 0 },
        { n: 1, s: 1 }, { n: 1, s: 0 },
        { n: 0, s: 1 }, { n: 0, s: 0 }
      ];
      const state = allPaliers.map(p => firstOccurrence[p.key || `${p.n}_${p.s}`] || 0)

      const currentState = JSON.stringify(state);
      if (currentState === lastDetailsModalState) return;
      lastDetailsModalState = currentState;

      const list = document.getElementById('detailsList');
      list.innerHTML = '';
      allPaliers.forEach(p => {
        const key = p.key || `${p.n}_${p.s}`;
        const label = p.label || `${p.n} n¬∞ + ${p.s} ‚óâ`;
        const li = document.createElement('li');
        if (firstOccurrence[key]) {
          const days = firstOccurrence[key] * (7 / 3);
          const when = formatTimeInDays(days, { skipSmallUnitsIfYearOrCentury: true });
          li.textContent = `${label} : obtenu en ${when}`;
        } else {
          li.innerHTML = `<span style="color:gray">${label} : jamais obtenu</span>`;
        }
        list.appendChild(li);
      });
    }

    function updatePrix() {
	  const mode = document.getElementById("modeSelect")?.value || "flash";

	  if (mode === "custom") {
		const span = document.getElementById("customPriceDisplay");
		const txt = document.getElementById("customGrids")?.value || "";
		const grids = parseCustomGrids(txt);
		if (!grids.length) {
		  if (span) span.textContent = "Prix : -- ‚Ç¨";
		  return;
		}
		let total = 0;
		for (const g of grids) total += costOfTicket(g);
		const affichage = total.toLocaleString("fr-FR", { minimumFractionDigits: 2, maximumFractionDigits: 2 });
		if (span) span.textContent = `Prix : ${affichage} ‚Ç¨`;
		return;
	  }

	  const n = parseInt(document.getElementById("ticketNumbersCount").value) || 5;
	  const s = parseInt(document.getElementById("ticketStarsCount").value) || 1;
	  const nbT = parseInt(document.getElementById("numTickets").value) || 1;

	  const ticketFictif = { numbers: Array(n).fill(0), stars: Array(s).fill(0) };
	  const prixUnitaire = costOfTicket(ticketFictif);
	  let prixTotal = prixUnitaire * nbT;

	  const multichanceChecked = document.getElementById("multichanceCheckbox").checked;
	  if (multichanceChecked) {
		const totalParts = parseInt(document.getElementById("totalParts").value) || 1;
		const yourParts  = parseInt(document.getElementById("yourParts").value)  || 0;
		if (yourParts > 0 && yourParts <= totalParts) {
		  prixTotal = prixTotal * (yourParts / totalParts);
		}
	  }

	  const affichage = prixTotal.toLocaleString("fr-FR", { minimumFractionDigits: 2, maximumFractionDigits: 2 });
	  document.getElementById("priceDisplay").textContent = `Prix : ${affichage} ‚Ç¨`;
	}
	
	document.getElementById('customGrids').addEventListener('input', updatePrix);


    window.addEventListener("DOMContentLoaded", function () {
      updatePrix();
    });

    document.getElementById("ticketNumbersCount").addEventListener("input", updatePrix);
    document.getElementById("ticketStarsCount").addEventListener("input", updatePrix);
    document.getElementById("numTickets").addEventListener("input", updatePrix);
	document.getElementById("showFrequenciesCheckbox").addEventListener("change", renderFrequencies);
	document.getElementById("freqSort")?.addEventListener("change", renderFrequencies);

    document.getElementById("multichanceCheckbox").addEventListener("change", updatePrix);
    document.getElementById("totalParts").addEventListener("input", updatePrix);
    document.getElementById("yourParts").addEventListener("input", updatePrix);

    function combinationIndex(numbers, star, numMax = 49, starMax = 10) {
      function C(n, k) {
        if (k > n) return 0;
        let r = 1;
        for (let i = 0; i < k; i++) r *= (n - i) / (i + 1);
        return r;
      }

      let idx = 0;
      let k = numbers.length;
      let prev = 0;
      for (let i = 0; i < k; i++) {
        let ni = numbers[i];
        for (let v = prev + 1; v < ni; v++) {
          idx += C(numMax - v, k - i - 1);
        }
        prev = ni;
      }

      idx = idx * starMax + (star - 1);

      return idx + 1;
    }

    function combinationFromIndex(idx, numMax = 49, starMax = 10) {
      if (idx < 1 || idx > combination(numMax, 5) * starMax)
        throw new RangeError("Index hors bornes");

      idx--;
      const star = (idx % starMax) + 1;
      let rank = Math.floor(idx / starMax);

      const nums = [];
      let prev = 0;
      for (let k = 5; k >= 1; k--) {
        let n = prev + 1;
        while (combination(numMax - n, k - 1) <= rank) {
          rank -= combination(numMax - n, k - 1);
          n++;
        }
        nums.push(n);
        prev = n;
      }
      return { numbers: nums, stars: [star] };
    }

    function formatTimeInDays(totalDays, options = {}) {
      const { skipSmallUnitsIfYearOrCentury = false } = options;
      const joursTotal = Math.floor(totalDays);
      let centuries = Math.floor(joursTotal / 36500);
      let reste = joursTotal % 36500;
      let years = Math.floor(reste / 365);
      reste = reste % 365;
      let months = Math.floor(reste / 30.4375);
      reste = Math.floor(reste % 30.4375);
      let weeks = Math.floor(reste / 7);
      let days = reste % 7;

      const w = typeof window !== "undefined" ? window.innerWidth : 1200;
      const parts = [];

      if (centuries > 0) parts.push(centuries + ' ' + (centuries === 1 ? 'si√®cle' : 'si√®cles'));
      if (years > 0) parts.push(years + ' ' + (years === 1 ? 'an' : 'ans'));
      if (months > 0) parts.push(months + ' mois');

      const hasBigUnit = centuries > 0 || years > 0;
      let showWeeks = true, showDays = true;
      if (skipSmallUnitsIfYearOrCentury && hasBigUnit) {
        showWeeks = false;
        showDays = false;
      } else {
        if (w > 785 && w < 1000 && centuries > 0) showWeeks = false;
        if (w > 785 && ((w < 1000 && centuries > 0) || (w < 1200 && years > 0))) showDays = false;
      }

      if (weeks > 0 && showWeeks) parts.push(weeks + ' ' + (weeks === 1 ? 'semaine' : 'semaines'));
      if (days > 0 && showDays) parts.push(days + ' ' + (days === 1 ? 'jour' : 'jours'));

      return parts.length === 0 ? "0 jour" : parts.join(", ");
    }



    function generateProbabilityExamples(N) {
      if (!Number.isFinite(N) || N <= 0) return [];

      const F = new Intl.NumberFormat("fr-FR");
      const examples = [];

      const seconds = N;
      if (seconds >= 60) {
        const minutes = seconds / 60;
        if (minutes < 60) {
          examples.push(`‚è±Ô∏è C‚Äôest comme choisir 1 seconde dans ${F.format(Math.round(minutes))} ${minutes < 2 ? "minute" : "minutes"}`);
        } else {
          const hours = minutes / 60;
          if (hours < 24) {
            examples.push(`‚è±Ô∏è C‚Äôest comme choisir 1 seconde dans ${F.format(Math.round(hours))} ${hours < 2 ? "heure" : "heures"}`);
          } else {
            const days = hours / 24;
            if (days < 365) {
              examples.push(`‚è±Ô∏è C‚Äôest comme choisir 1 seconde dans ${F.format(Math.round(days))} ${days < 2 ? "jour" : "jours"}`);
            } else {
              const years = days / 365;
              examples.push(`‚è±Ô∏è C‚Äôest comme choisir 1 seconde dans ${F.format(years.toFixed(1))} ans`);
            }
          }
        }
      }

      const flips = Math.round(Math.log2(N));
      if (flips > 1) {
        examples.push(`ü™ô R√©ussir ${flips} lancers de pile ou face d‚Äôaffil√©e`);
      }

      const km = N / 100_000;
      if (km >= 1) {
        examples.push(`üìè Retrouver un centim√®tre pr√©cis sur une route de ${F.format(Math.round(km))} km`);
      } else {
        const m = N / 100;
        if (m >= 1) {
          examples.push(`üìè Retrouver un centim√®tre pr√©cis sur une r√®gle de ${F.format(Math.round(m))} m`);
        }
      }

      const BOOKS_PER_LIBRARY = 100_000;
      if (N >= 10_000 && N < BOOKS_PER_LIBRARY * 2) {
        examples.push(`üìö Piocher au hasard le bon livre parmi ${F.format(Math.round(N))} ouvrages`);
      } else if (N >= BOOKS_PER_LIBRARY * 2) {
        const libraries = Math.round(N / BOOKS_PER_LIBRARY);
        examples.push(`üìö Trouver le bon livre parmi ${libraries} biblioth√®ques de ${F.format(BOOKS_PER_LIBRARY)} ouvrages`);
      } else if (N >= 100) {
        examples.push(`üé± Tirer la seule bille rouge parmi ${F.format(Math.round(N))} billes blanches`);
      }

      const stadiumCap = 80_000;
      if (N >= stadiumCap / 2 && N < stadiumCap * 2) {
        examples.push(`üèüÔ∏è √ätre tir√© au sort parmi ${F.format(Math.round(N))} personnes`);
      } else if (N >= stadiumCap * 2 && N < 10_000_000) {
        const stades = Math.round(N / stadiumCap);
        examples.push(`üèüÔ∏è √ätre tir√© au sort parmi ${stades} stades de ${stadiumCap.toLocaleString("fr-FR")} personnes`);
      }

      const screenPix = 2_000 * 1_000;
      if (N >= screenPix / 2 && N < BOOKS_PER_LIBRARY) {
        const ecrans = Math.round(N / screenPix);
        examples.push(`üñ•Ô∏è Allumer au hasard le bon pixel parmi ${ecrans} √©crans Full HD`);
      }

      const dropPerLitre = 20_000;
      if (N >= dropPerLitre * 500 && N < 1e9) {
        const litres = Math.round(N / dropPerLitre);
        examples.push(`üíß Identifier une goutte d‚Äôeau pr√©cise dans ${litres.toLocaleString("fr-FR")} litres`);
      }

      const tiragesParAn = 156;
      const daysPerDraw = 365.25 / tiragesParAn;
      const totalDays = N * daysPerDraw;
      const temps = formatTimeInDays(totalDays);
      examples.push(`‚è≥&nbsp;En jouant √† chaque tirage, il faudrait en moyenne :<br><strong style="margin-left: 1.5em;">${temps}</strong>`);

      return examples;
    }

    function openExamplesModal(N) {
      const modal = document.getElementById("examplesModal");
      const overlay = document.getElementById("modalOverlay");
      const content = document.getElementById("examplesContent");

      const listHTML = generateProbabilityExamples(N)
        .map(t => `<li>${t}</li>`)
        .join("");

      const entier = Math.round(N);
      content.innerHTML =
        `<p style="font-size:1.3em; font-weight:bold; margin-top:5px; margin-bottom:16px;">
			<span id="chanceDisplayText">1 chance sur ${entier.toLocaleString("fr-FR")}</span>
			<span id="editOddsIcon" title="Modifier" style="cursor:pointer; margin-left:8px; vertical-align:middle;">
			  <svg width="18" height="18" fill="gray" viewBox="0 0 24 24">
				<path d="M3 17.25V21h3.75l11.02-11.02-3.75-3.75L3 17.25zM20.71 
				  7.04a1.003 1.003 0 0 0 0-1.42l-2.34-2.34a1.003 1.003 0 0 0-1.42 0l-1.83 
				  1.83 3.75 3.75 1.84-1.82z"/>
			  </svg>
			</span>
		  </p>
		  <ul>${listHTML}</ul>`;
      modal.style.display = "block";
      overlay.style.display = "block";

      const editIcon = document.getElementById('editOddsIcon');
      editIcon.onclick = function () {
        const span = document.getElementById('chanceDisplayText');
        const prevVal = span.textContent.match(/\d[\d\s]*$/);
        const val = prevVal ? prevVal[0].replace(/\s/g, '') : '117';
        const currentOdds = N;

        span.innerHTML = `
			1 chance sur 
			<input id="editOddsInput" type="number" min="1" value="${val}" 
			  style="font-size:0.8em;width:150px;text-align:center;">
			<button id="editOddsOk" style="margin-left:2px;font-size:0.6em;">‚úî</button>
			<button id="editOddsCancel" style="margin-left:2px;font-size:0.6em;">‚úñ</button>
		  `;

        document.getElementById('editOddsIcon').style.display = 'none';

        const inputField = document.getElementById('editOddsInput');
        inputField.focus();
        inputField.addEventListener('keydown', function (e) {
          if (e.key === 'Enter') {
            e.preventDefault();
            document.getElementById('editOddsOk').click();
          } else if (e.key === 'Escape') {
            e.preventDefault();
            document.getElementById('editOddsCancel').click();
          }
        });

        document.getElementById('editOddsOk').onclick = function () {
          const nv = parseInt(document.getElementById('editOddsInput').value) || 1;
          document.getElementById('editOddsIcon').style.display = '';
          openExamplesModal(nv);
        };
        document.getElementById('editOddsCancel').onclick = function () {
          document.getElementById('editOddsIcon').style.display = '';
          openExamplesModal(currentOdds);
        };
      };
    }

    document.getElementById("closeExamplesBtn").addEventListener("click", () => {
      document.getElementById("examplesModal").style.display = "none";
      document.getElementById("modalOverlay").style.display = "none";
    });

    document.getElementById("modalOverlay").addEventListener("click", function () {
      document.getElementById("examplesModal").style.display = "none";
    });


    function generateRandomGridString() {
      const numbers = generateNumbers(5, 49);
      const chance = generateNumbers(1, 10);
      return `${numbers.join(",")} ; ${chance.join(",")}`;
    }

    function savePrizeFormData() {
      const form = document.getElementById("prizesForm");
      const inputs = form.querySelectorAll("input");
      inputs.forEach(input => {
        const val = parseFloat(input.value);
        if (!isNaN(val) && val >= 0) {
          prizeMappingEditable[input.name] = val;
        }
      });

      for (const key in prizeMappingEditable) {
        prizeMapping[key] = prizeMappingEditable[key];
      }
      prizeTableModified = true;
    }

    document.getElementById("generateGridsBtn").addEventListener("click", () => {
      const nb = parseInt(document.getElementById("nbGrillesAuto").value, 10);
      if (isNaN(nb) || nb < 1) return;
      let result = "";
      for (let i = 0; i < nb; i++) {
        result += generateRandomGridString() + "\n";
      }
      document.getElementById("customGrids").value = result.trim();
      updateChanceDisplay();
	  updatePrix();
    });
    document.getElementById("clearCustomGridsBtn").addEventListener("click", () => {
      document.getElementById("customGrids").value = "";
      updateChanceDisplay();
	  updatePrix();
    });



    function initGainChart() {
      const ctx = document.getElementById("gainChart").getContext("2d");

      gainChart = new Chart(ctx, {
        type: "line",
        data: {
          datasets: [{
            label: "Solde (‚Ç¨)",
            data: [],
            fill: false,
            borderWidth: 2,
            pointRadius: 0,
            pointHitRadius: 12,
            pointHoverRadius: 5,
            hoverBorderWidth: 2,
            tension: 0,
            segment: {
              borderColor: c => c.p1.parsed.y >= 0 ? "#43a047" : "#e53935"
            }
          }]
        },
        options: {
          animation: false,
          parsing: false,
          spanGaps: true,
          elements: {
            line: { borderCapStyle: "round", borderJoinStyle: "round" },
            point: { radius: 0 }
          },
          plugins: {
            legend: { display: false },
            decimation: {
              enabled: true,
              algorithm: "min-max",
              samples: 40000
            },
            tooltip: {
              enabled: false,
              external({ chart, tooltip }) {
                let el = chart.canvas.parentNode.querySelector('.my-tooltip');
                if (!el) {
                  el = document.createElement('div');
                  el.className = 'my-tooltip';
                  Object.assign(el.style, {
                    position: 'absolute',
                    background: 'rgba(0,0,0,.8)',
                    color: '#fff',
                    borderRadius: '4px',
                    padding: '6px 8px',
                    font: '12px/1.2 sans-serif',
                    pointerEvents: 'none',
                    opacity: 0
                  });
                  chart.canvas.parentNode.appendChild(el);
                }
                if (tooltip.opacity === 0) {
                  el.style.opacity = 0;
                  return;
                }
                const p = tooltip.dataPoints[0];
                const tirage = p.parsed.x;
                const jours = tirage * 7 / 3;
                const soldeN = p.parsed.y;
                const soldeT = soldeN.toLocaleString('fr-FR');
                const couleur = soldeN >= 0 ? '#4caf50' : '#e53935';

                el.innerHTML = `
				  <div><strong>Temps&nbsp;:</strong> ${formatTempsCourt(jours)}</div>
				  <div><strong>Solde&nbsp;:</strong> <span style="color:${couleur}">${soldeT} ‚Ç¨</span></div>
				`;

                const { offsetLeft, offsetTop } = chart.canvas;
                el.style.opacity = 1;
                el.style.left = offsetLeft + tooltip.caretX + 'px';
                el.style.top = offsetTop + tooltip.caretY + 'px';
              }
            }
          },
          scales: {
            x: {
              type: "linear",
              title: { display: true, text: "Temps" },
              ticks: {
                callback(value) {
                  const jours = value * 7 / 3;
                  return formatTempsCourt(jours);
                }
              }
            },
            y: { title: { display: false, text: "‚Ç¨" } }
          }
        }
      });
    }

    function formatTempsCourt(totalJours) {
      if (totalJours < 30) {
        return Math.round(totalJours) + " jours";
      }
      if (totalJours < 30.4375 * 6) {
        return Math.round(totalJours / 30.4375) + " mois";
      }
      const ans = totalJours / 365.25;
      if (ans < 100) {
        return (ans < 10 ? ans.toFixed(1).replace(".0", "") : Math.round(ans)) + " ans";
      }
      const siecles = Math.round(ans / 100);
      return siecles + " si√®cles";
    }

    const GAIN_SEUIL = 20000;
    let prizeTableModified = false;

    function updateGainChart() {
      if (!gainChart) return;

      const gainNet = balance;
      let addPoint = false;

      switch (true) {
        case (count <= 50):
          addPoint = true;
          break;
        case (count <= 200):
          addPoint = (count % 10 === 0);
          break;
        case (count <= 5000):
          addPoint = (count % 30 === 0);
          break;
        case (count <= 10000):
          addPoint = (count % 100 === 0);
          break;
        case (count <= 100000):
          addPoint = (count % 2000 === 0);
          break;
        case (count <= 1000000):
          addPoint = (count % 5000 === 0);
          break;
        case (count <= 5000000):
          addPoint = (count % 10000 === 0);
          break;
        case (count <= 20000000):
          addPoint = (count % 150000 === 0);
          break;
        case (count <= 80000000):
          addPoint = (count % 500000 === 0);
          break;
        default:
          addPoint = (count % 1000000 === 0);
          break;
      }

      if (!prizeTableModified && gainNet > 0 && lastY !== undefined && Math.abs(gainNet - lastY) >= GAIN_SEUIL) {
        addPoint = true;
      }

      if (addPoint) {
        addGainPoint(count, gainNet);
        lastY = gainNet;
      }
    }



    function resetGainChart() {
      if (!gainChart) return;
      gainChart.data.datasets[0].data = [];
      gainChart.update();
      lastY = undefined;
    }

    initGainChart();

    function indexToMyMillionCode(n) {
      const zeroBased = n - 1;
      const BLOCK_SIZE = 200000;
      const blockNumber = Math.floor(zeroBased / BLOCK_SIZE);

      const scramble = (blockNumber * 7919 + 104729) % 26;
      const firstLetter = String.fromCharCode(65 + scramble);

      const digits = String(zeroBased).padStart(7, "0");

      return `${firstLetter} ${digits.slice(0, 3)} ${digits.slice(3)}`;
    }

    function formatMyMillion(val) {
      if (typeof val === "number") return indexToMyMillionCode(val);
      if (typeof val === "string" && val.includes(" √† ")) {
        const [start, end] = val.split(" √† ").map(Number);
        return `${indexToMyMillionCode(start)} √† ${indexToMyMillionCode(end)}`;
      }
      return val;
    }

    function formatCodesList(arr) {
      return arr
        .slice()
        .sort((a, b) => {
          const aStr = formatMyMillion(a).replace(/&nbsp;/g, '').replace(/\s+/g, '');
          const bStr = formatMyMillion(b).replace(/&nbsp;/g, '').replace(/\s+/g, '');
          return aStr.localeCompare(bStr);
        })
        .map(formatMyMillion)
        .join(', ');
    }

    let fancyDisplay = true;
    function toggleDisplayStyle() {
      fancyDisplay = !fancyDisplay;

      document.getElementById('displayFancyIcon').style.display = fancyDisplay ? 'inline-block' : 'none';
      document.getElementById('displayPlainIcon').style.display = fancyDisplay ? 'none' : 'inline-block';

      document.body.classList.toggle('plain-display', !fancyDisplay);

      refreshTicketsDisplay();
    }

    document.getElementById('displayToggle').addEventListener('click', toggleDisplayStyle);

    function simpleTextList(arr) {
      return arr.join(', ');
    }

    function adjustTicketColumns(tickets) {
      const container = document.getElementById('ticketsContainer');
      const bigTicket = tickets.some(t =>
        t.numbers.length > 15 || t.stars.length > 10
      );
      const twoCols = tickets.length > 1 && !bigTicket;
      container.classList.toggle('cols-2', twoCols);
    }

    let soundEnabled = false;
    let currentAudio = null;

    function toggleSound() {
      soundEnabled = !soundEnabled;
      document.getElementById('soundOnIcon').style.display = soundEnabled ? 'inline-block' : 'none';
      document.getElementById('soundOffIcon').style.display = soundEnabled ? 'none' : 'inline-block';
    }

    document.getElementById('soundToggle').addEventListener('click', toggleSound);

    function playSound(soundFile) {
      if (!soundEnabled) return;
      if (currentAudio) {
        currentAudio.pause();
        currentAudio = null;
      }
      currentAudio = new Audio(soundFile);
      currentAudio.play().catch((err) => {
        console.warn('Erreur de lecture audio :', err);
      });
    }

    let stats = {
      "5_1": 0, "5_0": 0,
      "4_1": 0, "4_0": 0,
      "3_1": 0, "3_0": 0,
      "2_1": 0, "2_0": 0,
      "1_1": 0, "1_0": 0,
      "0_1": 0, "0_0": 0
    };

    let myMillionWinCount = 0;
    let myMillionTotalGain = 0;

    let statsGain = {
      "5_1": 0, "5_0": 0,
      "4_1": 0, "4_0": 0,
      "3_1": 0, "3_0": 0,
      "2_1": 0, "2_0": 0,
      "1_1": 0, "1_0": 0,
      "0_1": 0, "0_0": 0
    };

    let count = 0;
    let stopFlag = false;
    let loopTimeout;
    let balance = 0;
    const ticketCost = 2.2;
    let totalGrillesJouees = 0;

    let simulationActive = false;
    let simulationHasStarted = false;

    const prizeMapping = {
      "5_1": 3000000,
      "5_0": 100000,
      "4_1": 1000,
      "4_0": 500,
      "3_1": 50,
      "3_0": 20,
      "2_1": 10,
      "2_0": 4.4,
      "1_1": 2.2,
      "1_0": 0,
      "0_1": 2.2,
      "0_0": 0
    };


    const speedPresets = [
      { batchSize: 1, speed: 1000 },
      { batchSize: 10, speed: 500 },
      { batchSize: 100, speed: 100 },
      { batchSize: 500, speed: 50 },
      { batchSize: 1000, speed: 10 },
      { batchSize: 2000, speed: 5 },
      { batchSize: 5000, speed: 2 },
      { batchSize: 10000, speed: 1 },
      { batchSize: 50000, speed: 0 },
      { batchSize: 100000, speed: 0 },
    ];

    let currentBatchSize = speedPresets[4].batchSize;
    let currentSpeed = speedPresets[4].speed;

    function combination(n, r) {
      if (r > n) return 0;
      let num = 1, den = 1;
      for (let i = 0; i < r; i++) {
        num *= (n - i);
        den *= (i + 1);
      }
      return num / den;
    }

    let __originalMathRandom = Math.random;

    function __cryptoRandom() {
      const u32 = new Uint32Array(1);
      if (window.crypto && window.crypto.getRandomValues) {
        window.crypto.getRandomValues(u32);
        return u32[0] / 4294967296;
      }
      return __originalMathRandom();
    }

    function setPhysicalRandomEnabled(enabled) {
      Math.random = enabled ? __cryptoRandom : __originalMathRandom;
      window.__physicalRandomEnabled__ = !!enabled;
    }


    function costOfTicket(ticket) {
      const n = ticket.numbers.length;
      const s = ticket.stars.length;
      return combination(n, 5) * combination(s, 1) * ticketCost;
    }

    function generateNumbers(count, max) {
      if (!window.__physicalRandomEnabled__) {
        const set = new Set();
        while (set.size < count) {
          set.add(1 + Math.floor(Math.random() * max));
        }
        return Array.from(set).sort((a, b) => a - b);
      }

      const bag = Array.from({ length: max }, (_, i) => i + 1);
      for (let i = 0; i < count; i++) {
        const j = i + Math.floor(Math.random() * (max - i));
        const tmp = bag[i]; bag[i] = bag[j]; bag[j] = tmp;
      }
      const pick = bag.slice(0, count);
      return pick.sort((a, b) => a - b);
    }



    function getCombinations(arr, k) {
      const results = [];
      function combine(start, combo) {
        if (combo.length === k) {
          results.push(combo.slice());
          return;
        }
        for (let i = start; i < arr.length; i++) {
          combo.push(arr[i]);
          combine(i + 1, combo);
          combo.pop();
        }
      }
      combine(0, []);
      return results;
    }

    function generateTicket(numCount, starCount) {
      numCount = Math.max(5, Math.min(49, numCount));
      starCount = Math.max(1, Math.min(10, starCount));

      const ticketNumbers = generateNumbers(numCount, 49);
      const ticketStars = generateNumbers(starCount, 10);
      return { numbers: ticketNumbers, stars: ticketStars };
    }

    const freqNum = Array(50).fill(0);
    const freqStar = Array(11).fill(0);
    const totalFreqNum = Array(50).fill(0);
    const totalFreqStar = Array(11).fill(0);

    const MAX_RECENT_DRAWS = 70;
    const recentDraws = [];


    function pickUnique(pool, k) {
      const sac = [...pool];
      const set = new Set();
      while (set.size < k && sac.length) {
        const idx = Math.floor(Math.random() * sac.length);
        const val = sac.splice(idx, 1)[0];
        set.add(val);
      }
      return [...set].sort((a, b) => a - b);
    }

function generateOptimizedTicket(numCount = 5, starCount = 1) {
  const type = (document.getElementById("smartTypeSelect")?.value) || "frequence";

  numCount = Math.max(5, Math.min(49, numCount));
  starCount = Math.max(1, Math.min(10, starCount));

  const randInt = (a, b) => a + Math.floor(Math.random() * (b - a + 1));

  const sampleDistinct = (pool, k) => {
    const bag = pool.slice();
    const out = [];
    while (out.length < k && bag.length) {
      const idx = Math.floor(Math.random() * bag.length);
      out.push(bag.splice(idx, 1)[0]);
    }
    return out.sort((x, y) => x - y);
  };

  const pickByFreq = (len, freqArr, order) => {
    const arr = Array.from({ length: len }, (_, i) => i + 1)
      .map(v => ({ v, f: (freqArr[v] || 0), r: Math.random() }));
    arr.sort((a, b) => {
      if (order === 'asc') return (a.f - b.f) || (a.r - b.r);
      return (b.f - a.f) || (a.r - b.r);
    });
    return arr.map(o => o.v);
  };

  const completeStars = (chosen) => {
    while (chosen.length < starCount) {
      const s = 1 + Math.floor(Math.random() * 10);
      if (!chosen.includes(s)) chosen.push(s);
    }
    return chosen.sort((a,b)=>a-b);
  };

  const freqAllEqual = (arr, len) => {
    const vals = Array.from({length:len},(_,i)=>arr[i+1]||0);
    return Math.min(...vals) === Math.max(...vals);
  };

  if (type === "frequence" || type === "frequence_plus") {
    if (freqAllEqual(freqNum, 49)) return generateTicket(numCount, starCount);
    const order = (type === "frequence") ? "asc" : "desc";
    const chosenNums  = pickByFreq(49, freqNum, order).slice(0, numCount);
    const chosenStars = pickByFreq(10,  freqStar, order).slice(0, starCount);
    return { numbers: chosenNums.sort((a,b)=>a-b), stars: completeStars(chosenStars) };
  }

  if (type === "frequence_total" || type === "frequence_total_plus") {
    if (freqAllEqual(totalFreqNum, 49)) return generateTicket(numCount, starCount);
    const order = (type === "frequence_total") ? "asc" : "desc";
    const chosenNums  = pickByFreq(49, totalFreqNum, order).slice(0, numCount);
    const chosenStars = pickByFreq(10,  totalFreqStar, order).slice(0, starCount);
    return { numbers: chosenNums.sort((a,b)=>a-b), stars: completeStars(chosenStars) };
  }

  if (type === "anniversaire") {
    const pool = Array.from({ length: 31 }, (_, i) => i + 1);
    let chosenNums = sampleDistinct(pool, Math.min(numCount, 31));
    while (chosenNums.length < numCount) {
      const n = randInt(32, 49);
      if (!chosenNums.includes(n)) chosenNums.push(n);
    }
    chosenNums.sort((a,b)=>a-b);

    const chosenStars = [];
    return {
      numbers: chosenNums,
      stars: completeStars(chosenStars)
    };
  }


  if (type === "pair_impair") {
    let evens = Math.floor(numCount / 2), odds = numCount - evens;
    if (Math.random() < 0.5) [evens, odds] = [odds, evens];

    const evPool = Array.from({length: 24}, (_,i)=> (i+1)*2); 
    const odPool = Array.from({length: 25}, (_,i)=> (i*2)+1); 
    let chosenNums = sampleDistinct(evPool, Math.min(evens, evPool.length))
      .concat(sampleDistinct(odPool, Math.min(odds, odPool.length)));

    while (chosenNums.length < numCount) {
      const n = randInt(1,49);
      if (!chosenNums.includes(n)) chosenNums.push(n);
    }
    chosenNums.sort((a,b)=>a-b);

    return { numbers: chosenNums, stars: generateNumbers(starCount, 10) };
  }


  if (type === "petit_grand") {
    let small = Math.floor(numCount / 2), large = numCount - small;
    if (Math.random() < 0.5) [small, large] = [large, small];

    const smallPool = Array.from({length:25},(_,i)=>i+1);
    const largePool = Array.from({length:24},(_,i)=>i+26);

    let chosenNums = sampleDistinct(smallPool, Math.min(small, smallPool.length))
      .concat(sampleDistinct(largePool, Math.min(large, largePool.length)));

    while (chosenNums.length < numCount) {
      const n = randInt(1,49);
      if (!chosenNums.includes(n)) chosenNums.push(n);
    }
    chosenNums.sort((a,b)=>a-b);

    return { numbers: chosenNums, stars: generateNumbers(starCount, 10) };
  }

  if (type === "consecutif") {
    const runLen = Math.min(numCount >= 3 ? (Math.random() < 0.6 ? 3 : 2) : 2, numCount);
    const startMax = 49 - runLen + 1;
    const start = randInt(1, startMax);
    const run = Array.from({length: runLen}, (_,i) => start + i);

    const chosenSet = new Set(run);
    while (chosenSet.size < numCount) {
      const n = randInt(1,49);
      if (!chosenSet.has(n)) chosenSet.add(n);
    }
    const chosenNums = Array.from(chosenSet).sort((a,b)=>a-b);

    return { numbers: chosenNums, stars: generateNumbers(starCount, 10) };
  }

  if (type === "moyenne") {
    const target = 25 * numCount;
    let best = null, bestDelta = Infinity;

    const trials = Math.min(800, 100 * numCount);
    for (let i = 0; i < trials; i++) {
      const cand = generateNumbers(numCount, 49);
      const sum = cand.reduce((a,b)=>a+b, 0);
      const delta = Math.abs(sum - target);
      if (delta < bestDelta) {
        bestDelta = delta;
        best = cand;
        if (delta === 0) break;
      }
    }
    return { numbers: best || generateNumbers(numCount, 49), stars: generateNumbers(starCount, 10) };
  }

  if (type === "mixte") {
    if (freqAllEqual(freqNum, 49)) return generateTicket(numCount, starCount);

    const lessCount = Math.floor(numCount / 2);
    const moreCount = numCount - lessCount;

    const lessNums = pickByFreq(49, freqNum, 'asc');
    const moreNums = pickByFreq(49, freqNum, 'desc');

    const chosenNums = [];
    for (let n of lessNums) {
      if (chosenNums.length >= lessCount) break;
      if (!chosenNums.includes(n)) chosenNums.push(n);
    }
    for (let n of moreNums) {
      if (chosenNums.length >= numCount) break;
      if (!chosenNums.includes(n)) chosenNums.push(n);
    }
    while (chosenNums.length < numCount) {
      const n = randInt(1,49);
      if (!chosenNums.includes(n)) chosenNums.push(n);
    }
    chosenNums.sort((a,b)=>a-b);

    const lessStars = pickByFreq(10, freqStar, 'asc');
    const moreStars = pickByFreq(10, freqStar, 'desc');

    const chosenStars = [];
    const lessS = Math.floor(starCount / 2);
    const moreS = starCount - lessS;

    for (let s of lessStars) {
      if (chosenStars.length >= lessS) break;
      if (!chosenStars.includes(s)) chosenStars.push(s);
    }
    for (let s of moreStars) {
      if (chosenStars.length >= starCount) break;
      if (!chosenStars.includes(s)) chosenStars.push(s);
    }
    return { numbers: chosenNums, stars: completeStars(chosenStars) };
  }

  return generateTicket(numCount, starCount);
}



    function shuffle(arr) {
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
    }

    function generateDraw() {
      const draw = {
        numbers: generateNumbers(5, 49),
        stars: generateNumbers(1, 10)
      };

      const showFreq = document.getElementById("showFrequenciesCheckbox").checked;
      const smart = document.getElementById("smartDrawCheckbox").checked;

      if (smart) {
        draw.numbers.forEach(n => freqNum[n]++);
        draw.stars.forEach(s => freqStar[s]++);
        recentDraws.push(draw);
        if (recentDraws.length > MAX_RECENT_DRAWS) {
          const old = recentDraws.shift();
          old.numbers.forEach(n => freqNum[n]--);
          old.stars.forEach(s => freqStar[s]--);
        }
      }

		const smartType = document.getElementById("smartTypeSelect")?.value;
		const needTotals = showFreq || (smart && smartType === "frequence_total");

		if (needTotals) {
		  draw.numbers.forEach(n => totalFreqNum[n]++);
		  draw.stars.forEach(s => totalFreqStar[s]++);
		}


      return draw;
    }

    function countMatches(arr1, arr2) {
      return arr1.filter(x => arr2.includes(x)).length;
    }

    function parseCustomInput(str) {
      return str.split(',')
        .map(s => parseInt(s.trim()))
        .filter(n => !isNaN(n));
    }

    function parseCustomGrids(str) {
      const lines = str.split('\n').filter(l => l.trim() !== '');
      const tickets = [];

      lines.forEach(line => {
        const trimmed = line.trim();

        if (trimmed.includes(';')) {
          const [numsPart, starPart] = trimmed.split(';');
          const numbers = parseCustomInput(numsPart);
          const stars = parseCustomInput(starPart);
          if (numbers.length && stars.length) {
            tickets.push({
              numbers: numbers.sort((a, b) => a - b),
              stars: stars.sort((a, b) => a - b)
            });
          }
          return;
        }

        if (/^\d+$/.test(trimmed)) {
          const idx = parseInt(trimmed, 10);
          try {
            tickets.push(combinationFromIndex(idx));
          } catch { }
        }
      });

      return tickets;
    }


    function ballHTML(value, type) {
      const cls = type === "star" ? "star-ball" : "number-ball";
      return `<span class="${cls}">${value}</span>`;
    }

    function combinationBallHTML(val) {
      return `<span class="number-ball" style="margin-left:6px; background:#047dff; color:white; font-size:0.88em; min-width:36px;" title="Num√©ro unique">${val.toLocaleString('fr-FR')}</span>`;
    }

    function refreshTicketsDisplay() {
      if (!window._lastTicketsData) return;

      const { tickets, draw, myMillion } = window._lastTicketsData;

      document.getElementById("ticketsContainer").innerHTML = "";

      tickets.forEach((ticket, index) => {
        const div = document.createElement("div");
        div.className = "ticket";
        const highlightedNums = highlightMatches(ticket.numbers, draw.numbers, "number");
        const highlightedStars = highlightMatches(ticket.stars, draw.stars, "star");
        div.innerHTML = `<strong>Ticket ${index + 1} :</strong><br>
						 Num√©ros : ${highlightedNums}<br>
						 Chance : ${highlightedStars}${myMillion ? `<br>Code Loto : ${formatMyMillion(ticket.myMillon)}` : ""}`;

        const showIdx = document.getElementById("showCombinationNumber")?.checked;
        if (showIdx && ticket.stars.length === 1 && ticket.numbers.length === 5) {
          const combIdx = combinationIndex(ticket.numbers, ticket.stars[0]);
          div.innerHTML += `<br><small style="color:gray;">N¬∞ unique‚ÄØ: ${combIdx.toLocaleString('fr-FR')}</small>`;
        }

        document.getElementById("ticketsContainer").appendChild(div);
      });
    }

    function addGainPoint(x, y) {
      const data = gainChart.data.datasets[0].data;
      const last = data[data.length - 1];

      if (last && last.x === x) {
        last.y = y;
      } else {
        data.push({ x, y });
      }
      gainChart.update();
    }

    function highlightMatches(values, drawValues, type) {
      const isPlain = typeof fancyDisplay !== "undefined" && !fancyDisplay;

      if (isPlain) {
        return values.map((v, i) => {
          const isMatch = drawValues.includes(v);
          let str = isMatch
            ? `<span class="match">${v}</span>`
            : v;
          if (i < values.length - 1) str += ', ';
          return str;
        }).join('');
      } else {
        return values.map(v => {
          const cls = drawValues.includes(v) ? 'match' : 'semi';
          const base = ballHTML(v, type);
          return base.replace('class="', `class="${cls} `);
        }).join(' ');
      }
    }

    function balls(values, type) {
      return values.map(v => ballHTML(v, type)).join(" ");
    }

    function launchFireworks() {
      const container = document.getElementById('fireworksContainer');
      let count = 0;
      const total = 80;
      const interval = setInterval(() => {
        if (count >= total) {
          clearInterval(interval);
          return;
        }
        const firework = document.createElement('div');
        firework.classList.add('firework');
        const x = Math.random() * window.innerWidth;
        firework.style.left = x + 'px';
        firework.style.top = '0px';
        const tx = (Math.random() - 0.5) * 300;
        const ty = Math.random() * 500;
        firework.style.setProperty('--tx', tx + 'px');
        firework.style.setProperty('--ty', ty + 'px');
        const colors = [
          { light: '#ffcc00', dark: '#ff9900' },
          { light: '#ff3366', dark: '#cc0033' },
          { light: '#66ccff', dark: '#3399ff' },
          { light: '#99ff99', dark: '#33cc33' }
        ];
        const chosen = colors[Math.floor(Math.random() * colors.length)];
        firework.style.setProperty('--color', chosen.light);
        firework.style.setProperty('--color-dark', chosen.dark);
        container.appendChild(firework);
        firework.addEventListener('animationend', () => {
          firework.remove();
        });
        count++;
      }, 25);
    }

    function removeLooseImages() {
      const container = document.querySelector('#looseImageContainer');
      if (container) {
        container.innerHTML = "";
      }
    }

    function addLooseImage(filename) {
      const container = document.querySelector('#looseImageContainer');
      if (!container) return;
      const img = document.createElement('img');
      img.src = filename;
      img.style.width = "1.5em";
      img.style.height = "1.5em";
      img.style.verticalAlign = "middle";
      img.style.marginLeft = "8px";
      container.appendChild(img);
    }

    function updateStatsDisplay() {
      let total = 0;
      for (let combo in stats) total += stats[combo];

      const elemMyMillion = document.getElementById("stats_myMillion");
      const valMyMillion = document.getElementById("stats_myMillion_value");
      const pctMyMillion = document.getElementById("stats_myMillion_pct");
      const gainMyMillion = document.getElementById("stats_myMillion_gain");

      if (!document.getElementById("myMillonCheckbox").checked) {
        elemMyMillion.style.display = "none";
      } else {
        elemMyMillion.style.display = "list-item";
        let percent = count > 0 ? (myMillionWinCount / count * 100) : 0;
        if (myMillionWinCount === 0 && simulationHasStarted && count > 0) {
          valMyMillion.innerHTML = `<span style='color: red;'>0</span>`;
        } else {
          valMyMillion.innerHTML = myMillionWinCount.toLocaleString('de-DE');
        }
        pctMyMillion.innerHTML = `<span style='color: gray;'>(${percent.toFixed(2)}%)</span>`;
        if (myMillionTotalGain > 0) {
          gainMyMillion.innerHTML = `<span style='color: green;'>+${myMillionTotalGain.toLocaleString('de-DE', {
            minimumFractionDigits: 1,
            maximumFractionDigits: 1
          })}‚Ç¨</span>`;
        } else {
          gainMyMillion.innerHTML = '';
        }
      }

      for (let combo in stats) {
        const elem = document.getElementById("stats_" + combo);
        if (elem) {
          const countValue = stats[combo];
          let pct = total > 0 ? (countValue / total * 100) : 0;
          const totalPrize = statsGain[combo];
          const totalPrizeFormatted = totalPrize.toLocaleString('de-DE', {
            minimumFractionDigits: 1,
            maximumFractionDigits: 1
          });
          const prizeDisplay = totalPrize === 0 ? "" : `<span style='color: green;'>+${totalPrizeFormatted}‚Ç¨</span>`;
          if (countValue === 0) {
            elem.innerHTML =
              `<span style='color: ${simulationHasStarted ? 'red' : 'black'};'>${countValue.toLocaleString('de-DE')}</span>
               <span style='color: gray;'>(${pct.toFixed(2)}%)</span>
               ${prizeDisplay}`;
          } else {
            elem.innerHTML =
              `${countValue.toLocaleString('de-DE')}
               <span style='color: gray;'>(${pct.toFixed(2)}%)</span>
               ${prizeDisplay}`;
          }
        }
      }
      let totalGain = 0;
      for (let combo in statsGain) totalGain += statsGain[combo];
      totalGain += myMillionTotalGain;

      let solde = balance;
      let totalSpent = totalGain - solde;

      let losses = -Math.abs(totalSpent);
      let gains = Math.abs(totalGain);

      document.getElementById('spentValue').innerHTML =
        `<span style="color:red;">${losses.toLocaleString('fr-FR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}&nbsp;‚Ç¨</span>`;
      document.getElementById('gainValue').innerHTML =
        `<span style="color:green;">+${gains.toLocaleString('fr-FR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}&nbsp;‚Ç¨</span>`;

      let percentLossVal = (totalSpent > 0)
        ? ((totalGain / totalSpent - 1) * 100)
        : 0;
      let percentString = `(${percentLossVal >= 0 ? "+" : ""}${percentLossVal.toFixed(2)}%)`;
      document.getElementById('percentValue').innerHTML =
        `<span style="color:#888;">${percentString}</span>`;
    }

    function updateChanceDisplay() {
	  const __uiMode = document.getElementById("modeSelect").value;
	  if (__uiMode === "quiz") { 
	    return; 
	  }
      const mode = document.getElementById("modeSelect").value;
      let numCount, starCount;
      if (mode === "flash") {
        numCount = parseInt(document.getElementById("ticketNumbersCount").value) || 5;
        starCount = parseInt(document.getElementById("ticketStarsCount").value) || 2;
      } else {
        const customGridsText = document.getElementById("customGrids").value;
        const grids = parseCustomGrids(customGridsText);
        if (grids.length > 0) {
          numCount = grids[0].numbers.length;
          starCount = grids[0].stars.length;
        } else {
          numCount = 5;
          starCount = 2;
        }
      }
      numCount = Math.max(5, Math.min(49, numCount));
      starCount = Math.max(1, Math.min(10, starCount));
      const numTickets = mode === "flash" ? (parseInt(document.getElementById("numTickets").value) || 1) : 1;
      const stopNumbers = parseInt(document.getElementById("stopNumbers").value) ?? 5;
      const stopStars = parseInt(document.getElementById("stopStars").value) ?? 1;

      function computeChance(numCount, starCount, stopNumbers, stopStars) {
					const probNum = combination(numCount, stopNumbers) *
									combination(49 - numCount, 5 - stopNumbers) /
									combination(49, 5);

					const probStars = combination(starCount, stopStars) *
									  combination(10 - starCount, 1 - stopStars) /
									  combination(10, 1);

					return probNum * probStars;
				}

      let pGlobal = 0;

      if (mode === "flash") {
        const pTicket = computeChance(numCount, starCount, stopNumbers, stopStars);
        pGlobal = 1 - Math.pow(1 - pTicket, numTickets);
      } else {
        const customGridsText = document.getElementById("customGrids").value;
        const grids = parseCustomGrids(customGridsText);
        for (let g of grids) {
          const pTicket = computeChance(g.numbers.length, g.stars.length, stopNumbers, stopStars);
          pGlobal += pTicket;
        }
      }

      const percent = (pGlobal * 100).toFixed(8);
      const reciprocalFormatted = pGlobal > 0
        ? Math.floor(1 / pGlobal).toLocaleString('fr-FR')
        : "‚àû";
      lastOdds = pGlobal > 0 ? 1 / pGlobal : Infinity;


      const POSSIBILITIES = 3_000_000;
      let totalSimpleGrids = 0;

      if (mode === "flash") {
        const gridsPerTicket = simpleGrids(numCount, starCount);
        totalSimpleGrids = gridsPerTicket * numTickets;
      } else {
        const customGridsText = document.getElementById("customGrids").value;
        const grids = parseCustomGrids(customGridsText);
        grids.forEach(g => {
          totalSimpleGrids += simpleGrids(g.numbers.length, g.stars.length);
        });
      }

      const pCodeLoto = 1 - Math.pow(1 - 10 / POSSIBILITIES, totalSimpleGrids);
      const pctCode = (pCodeLoto * 100).toFixed(8);
      const invCode = pCodeLoto > 0
        ? (1 / pCodeLoto).toLocaleString('de-DE', { maximumFractionDigits: 0 })
        : "‚àû";

      let lignes = [
        `Taux de chance (pour au moins ${stopNumbers} n¬∞ et ${stopStars} ‚óâ) : ${percent}%`
      ];

      const probLine =
        `1 chance sur ${reciprocalFormatted} - `
        + (isFinite(lastOdds)
          ? ` <a id="examplesLink" href="#" style="color:#187ad2;">Exemples concrets</a>`
          : "");

      lignes.push(probLine);

      if (document.getElementById("myMillonCheckbox").checked) {
        lignes.push(
          `1 chance sur ${invCode} (Code&nbsp;Loto)
   <span class="info-icon"
         title="Estimation approximative : 
Varie selon le nombre r√©el de grilles jou√©es √† chaque tirage.">i</span>`
        );

      }

      document.getElementById("chanceDisplay").innerHTML = lignes.join("<br>");

      const link = document.getElementById("examplesLink");
      if (link) {
        link.addEventListener("click", function (e) {
          e.preventDefault();
          openExamplesModal(lastOdds);
        });
      }


    }

    setPhysicalRandomEnabled(false);

    document.getElementById("physicalRandomCheckbox").addEventListener("change", (e) => {
      setPhysicalRandomEnabled(e.target.checked);
    });

    function simpleGrids(n, s) {
      return combination(n, 5) * combination(s, 1);
    }

    function updateTimePassed(drawCount) {
      const days = drawCount * (7 / 3);
      const formatted = formatTimeInDays(days);
      document.getElementById("timePassed").textContent = "Temps √©coul√© : " + formatted;
    }

    window.addEventListener("resize", () => updateTimePassed(count));

    function updateGainDisplay() {
      const formatted = balance.toLocaleString('de-DE', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
      const gainElem = document.getElementById("gainDisplay");
      let imageContainer = document.getElementById("looseImageContainer");
      if (!imageContainer) {
        imageContainer = document.createElement("span");
        imageContainer.id = "looseImageContainer";
      }
      if (balance >= 0) {
        gainElem.innerHTML = `Solde : <span style='color: green;'>${formatted} ‚Ç¨</span>`;
      } else {
        gainElem.innerHTML = `Solde : <span style='color: red;'>${formatted} ‚Ç¨</span>`;
      }
      gainElem.appendChild(imageContainer);
      updateGainChart();
    }

    document.querySelectorAll("#ticketNumbersCount, #ticketStarsCount, #numTickets, #stopNumbers, #stopStars, #customGrids, #stopAfterYearsInput, #stopAfterYearsCheckbox")
      .forEach(input => {
        input.addEventListener("input", updateChanceDisplay);
      });
    updateChanceDisplay();
    document.getElementById("stopBtn").style.display = "none";

    document.getElementById("multichanceCheckbox").addEventListener("change", function () {
      const partsContainer = document.getElementById("multichancePartsContainer");
      partsContainer.style.display = this.checked ? "block" : "none";
    });

    document.getElementById("myMillonCheckbox").addEventListener("change", function () {
      document.getElementById("stopMyMillonWinGroup").style.display = this.checked ? "block" : "none";
      updateStatsDisplay();
      updateChanceDisplay();
      renderFrequencies();
    });

    document.getElementById("smartDrawCheckbox").addEventListener("change", function () {
      const block = document.getElementById("smartDrawSettings");
      block.style.display = this.checked ? "block" : "none";
    });

document.getElementById("modeSelect").addEventListener("change", function () {
  const mode = this.value;
  if (mode === "flash" || mode === "custom") {
	window.lastSimMode = mode;
  }

  const flash  = document.getElementById("flashSettings");
  const custom = document.getElementById("customSettings");
  const quiz   = document.getElementById("quizSettings");

  const ticketsGrp   = document.getElementById("ticketsCountGroup");
  const multiGrp     = document.getElementById("multichanceCheckbox").parentNode;
  const multiParts   = document.getElementById("multichancePartsContainer");
  const smartChk     = document.getElementById("smartDrawCheckbox").parentNode;
  const smartSet     = document.getElementById("smartDrawSettings");
  const speedGrp     = document.getElementById("speedControlGroup");
  const freqBox      = document.getElementById("frequencyContainer");
  const myMillonGrp  = document.getElementById("stopMyMillonWinGroup");
  const btnRow       = document.getElementById("startBtn")?.parentElement;

  const stopYearsGrp = document.getElementById("stopAfterYearsCheckbox").closest(".form-group");
  const stopBalGrp   = document.getElementById("stopNegativeGainCheckbox").closest(".form-group");
  const stopAtLeastGrp = document.getElementById("stopNumbers").closest(".form-group");

  const smallOptions = [
    document.getElementById("showCombinationNumber")?.closest("div"),
    document.getElementById("physicalRandomCheckbox")?.closest("div"),
    document.getElementById("showFrequenciesCheckbox")?.closest("div")
  ];
  const codeMultiSmart = [
    document.getElementById("myMillonCheckbox")?.parentElement,
    document.getElementById("multichanceCheckbox")?.parentElement,
    document.getElementById("smartDrawCheckbox")?.parentElement
  ];

  if (mode === "flash") {
    flash.style.display  = "block";
    custom.style.display = "none";
    quiz.style.display   = "none";

    ticketsGrp.style.display = "block";
    multiGrp.style.display   = "block";
    multiParts.style.display = document.getElementById("multichanceCheckbox").checked ? "block" : "none";
    smartChk.style.display   = "block";
    smartSet.style.display   = document.getElementById("smartDrawCheckbox").checked ? "block" : "none";
    speedGrp.style.display   = "flex";
    freqBox.style.display    = document.getElementById("showFrequenciesCheckbox").checked ? "block" : "none";
    myMillonGrp.style.display= document.getElementById("myMillonCheckbox").checked ? "block" : "none";
    if (btnRow) btnRow.style.display = "inline-flex";

    stopYearsGrp.style.display = "block";
    stopBalGrp.style.display   = "block";
    stopAtLeastGrp.style.display = "flex";
    [...smallOptions, ...codeMultiSmart].forEach(el => el && (el.style.display = "block"));
  }
  else if (mode === "custom") {
    flash.style.display  = "none";
    custom.style.display = "block";
    quiz.style.display   = "none";

    ticketsGrp.style.display = "none";
    multiGrp.style.display   = "none";
    multiParts.style.display = "none";
    smartChk.style.display   = "none";
    smartSet.style.display   = "none";
    speedGrp.style.display   = "flex";
    freqBox.style.display    = "none";
    myMillonGrp.style.display= "none";
    if (btnRow) btnRow.style.display = "inline-flex";

    stopYearsGrp.style.display = "block";
    stopBalGrp.style.display   = "block";
    stopAtLeastGrp.style.display = "flex";
    [...smallOptions, ...codeMultiSmart].forEach(el => el && (el.style.display = "block"));
  }
else if (mode === "quiz") {
  flash.style.display  = "none";
  custom.style.display = "none";
  quiz.style.display   = "block";

  ticketsGrp.style.display   = "none";
  multiGrp.style.display     = "none";
  multiParts.style.display   = "none";
  smartChk.style.disdplay     = "none";
  smartSet.style.display     = "none";
  speedGrp.style.display     = "none";
  freqBox.style.display      = "none";
  myMillonGrp.style.display  = "none";
  if (btnRow) btnRow.style.display = "none";

  stopYearsGrp.style.display   = "none";
  stopBalGrp.style.display     = "none";
  stopAtLeastGrp.style.display = "none";
  [ ...smallOptions, ...codeMultiSmart ].forEach(el => el && (el.style.display = "none"));
}

  updateChanceDisplay();
});

    const speedSlider = document.getElementById("speedSlider");
    const speedValueLabel = document.getElementById("speedValueLabel");

    function updateSpeedFromSlider(value) {
      const sliderVal = parseInt(value, 10);
      if (sliderVal <= 50) {
        currentBatchSize = 1;
        currentSpeed = Math.round(1000 - (sliderVal - 1) * (999 / 49));
      } else if (sliderVal <= 70) {
        let ratio = (sliderVal - 50) / 20;
        currentBatchSize = Math.round(1 + ratio * (200 - 1));
        currentSpeed = 1;
      } else {
        let ratio = (sliderVal - 70) / 30;
        currentBatchSize = Math.round(200 + ratio * (2000 - 200));
        currentSpeed = Math.round(1 - ratio * 1);
      }
      speedValueLabel.textContent = `(Tirage = ${currentBatchSize}, D√©lai = ${currentSpeed} ms)`;
    }

    updateSpeedFromSlider(speedSlider.value);
    speedSlider.addEventListener("input", function () {
      updateSpeedFromSlider(this.value);
    });

    function runLoop() {
      removeLooseImages();
      if (stopFlag) return;
      simulationActive = true;

      const mode = getEffectiveMode();
	  	  const raw = document.getElementById("customGrids")?.value.trim();
	  if (mode === "custom" && (!raw || raw === "")) {
	    stopFlag = true;
	    simulationActive = false;
	    clearTimeout(loopTimeout);
	    const stopBtn = document.getElementById("stopBtn");
	    if (stopBtn) stopBtn.textContent = "Continuer";
	    return;
	  }
      let multichanceRatio = 1;
      if (mode === "flash" && document.getElementById("multichanceCheckbox").checked) {
        const totalParts = parseInt(document.getElementById("totalParts").value) || 0;
        const yourParts = parseInt(document.getElementById("yourParts").value) || 0;
        if (yourParts > totalParts) {
          alert("Erreur : Votre nombre de parts ne peut pas d√©passer le total de parts (" + totalParts + ").");
          stopFlag = true;
          document.getElementById("startBtn").style.display = "block";
          simulationActive = false;
          return;
        }
        multichanceRatio = yourParts / totalParts;
      }
      let tickets = [];
      let draw = null;
      let customTickets = [];
      if (mode === "custom") {
        const customGridsText = document.getElementById("customGrids").value;
        customTickets = parseCustomGrids(customGridsText);
      }
      const numCount = mode === "flash"
        ? (parseInt(document.getElementById("ticketNumbersCount").value) || 5)
        : (customTickets.length > 0 ? customTickets[0].numbers.length : 5);
      const starCount = mode === "flash"
        ? (parseInt(document.getElementById("ticketStarsCount").value) || 2)
        : (customTickets.length > 0 ? customTickets[0].stars.length : 2);
      const numTickets = mode === "flash"
        ? (parseInt(document.getElementById("numTickets").value) || 1)
        : (customTickets.length > 0 ? customTickets.length : 1);
		
      let simpleGridsPerTicket = 1;
      if (numCount > 5) simpleGridsPerTicket *= combination(numCount, 5);
      if (starCount > 1) simpleGridsPerTicket *= combination(starCount, 1);
      const stopNumbers = parseInt(document.getElementById("stopNumbers").value) || 0;
      const stopStars = parseInt(document.getElementById("stopStars").value) || 0;
      const stopAfterYearsChecked = document.getElementById("stopAfterYearsCheckbox").checked;
      const stopAfterYearsValue = parseInt(document.getElementById("stopAfterYearsInput").value) || 100;
      const batchSize = currentBatchSize;
      const speed = currentSpeed;

      const stopMyMillonWin = document.getElementById("stopMyMillonWinCheckbox").checked;

      for (let i = 0; i < batchSize; i++) {
        count++;
        totalGrillesJouees += numTickets * simpleGridsPerTicket;
        tickets = [];
        for (let j = 0; j < numTickets; j++) {
          if (mode === "flash") {
            if (document.getElementById("smartDrawCheckbox").checked) {
			  tickets.push(generateOptimizedTicket(numCount, starCount));
			} else {
			  tickets.push(generateTicket(numCount, starCount));
			}
          } else {
            if (customTickets.length > 0) {
              tickets.push(customTickets[j % customTickets.length]);
            }
          }
        }
        if (mode === "flash") {
          let costPerTicket = simpleGridsPerTicket * ticketCost;
          if (document.getElementById("multichanceCheckbox").checked) {
            costPerTicket *= multichanceRatio;
          }
          balance -= numTickets * costPerTicket;
        } else {
          tickets.forEach(ticket => {
            balance -= costOfTicket(ticket);
          });
        }
        draw = generateDraw();
        if (document.getElementById("showFrequenciesCheckbox").checked) {
          renderFrequencies();
        }

        let myMillionJustWon = false;
        if (document.getElementById("myMillonCheckbox").checked) {
          let tirageJour = (count - 1) % 3;
          let possibilities;
          switch (tirageJour) {
            case 0:
              possibilities = 2200000;
              break;
            case 1:
              possibilities = 3000000;
              break;
            case 2:
              possibilities = 3800000;
              break;
          }

          let assignedRanges = [];
          tickets.forEach(ticket => {
            let n = ticket.numbers.length;
            let s = ticket.stars.length;
            let numGrilles = combination(n, 5) * combination(s, 1);
            if (numGrilles > 1) {
              let baseNumber;
              let attempt = 0;
              const maxAttempts = 100;
              do {
                baseNumber = Math.floor(Math.random() * (possibilities - numGrilles + 1)) + 1;
                attempt++;
                var conflict = assignedRanges.some(range =>
                  baseNumber <= range.end && (baseNumber + numGrilles - 1) >= range.start
                );
              } while (conflict && attempt < maxAttempts);
              let rangeEnd = baseNumber + numGrilles;
              assignedRanges.push({ start: baseNumber, end: rangeEnd });
              ticket.myMillon = baseNumber + " √† " + rangeEnd;
            } else {
              let candidate;
              let attempt = 0;
              const maxAttempts = 100;
              do {
                candidate = Math.floor(Math.random() * possibilities) + 1;
                attempt++;
                var conflict = assignedRanges.some(range =>
                  candidate >= range.start && candidate <= range.end
                );
              } while (conflict && attempt < maxAttempts);
              assignedRanges.push({ start: candidate, end: candidate });
              ticket.myMillon = candidate;
            }
          });
          draw.myMillon = [];
          while (draw.myMillon.length < 10) {
            const candidate = Math.floor(Math.random() * possibilities) + 1;
            if (!draw.myMillon.includes(candidate)) {
              draw.myMillon.push(candidate);
            }
          }


          let myMillonWin = tickets.some(ticket => {
            return draw.myMillon.some(code => {
              if (typeof ticket.myMillon === "string" && ticket.myMillon.includes(" √† ")) {
                let [start, end] = ticket.myMillon.split(" √† ").map(Number);
                return code >= start && code <= end;
              } else {
                return ticket.myMillon === code;
              }
            });
          });


          if (myMillonWin) {
            myMillionWinCount++;
            let myMillonPrize = 20000;
            if (document.getElementById("multichanceCheckbox").checked) {
              const totalParts = parseInt(document.getElementById("totalParts").value) || 1;
              const yourParts = parseInt(document.getElementById("yourParts").value) || 1;
              myMillonPrize = 20000 * (yourParts / totalParts);
            }
            balance += myMillonPrize;
            myMillionTotalGain += myMillonPrize;
            if (!firstOccurrence.myMillion) {
              firstOccurrence.myMillion = count;
              updateDetailsModalIfOpen();
            }
            updateStatsDisplay();

            myMillionJustWon = true;
            if (stopMyMillonWin) {
              const tempsEcoule = formatTimeInDays(count * (7 / 3));
              alert(
                "Code Loto gagn√©e !\n" +
                "Temps √©coul√© : " + tempsEcoule + "\n" +
                "Tirage n¬∞ " + count.toLocaleString('de-DE') + "\n" +
                "Gain : " + myMillonPrize.toLocaleString('de-DE', { maximumFractionDigits: 0 }) + " ‚Ç¨"
              );
              if (balance >= 1) {
                playSound("win.mp3");
              } else if (balance <= -1000000) {
                playSound("bigloose.mp3");
                addLooseImage("bigloose.jpeg");
              }

              if (gainChart) {
                addGainPoint(count, balance);
                lastY = balance;
              }

              stopFlag = true;
              simulationActive = false;
              document.getElementById("startBtn").style.display = "inline-block";
              document.getElementById("startBtn").textContent = "Nouvelle simulation";
              document.getElementById("stopBtn").style.display = "inline-block";
              document.getElementById("stopBtn").textContent = "Continuer";

              document.getElementById("ticketsContainer").innerHTML = "";

              tickets.forEach((ticket, index) => {
                const div = document.createElement("div");
                let isWinning;
                if (typeof ticket.myMillon === "string" && ticket.myMillon.includes(" √† ")) {
                  const [start, end] = ticket.myMillon.split(" √† ").map(Number);
                  isWinning = draw.myMillon.some(code => code >= start && code <= end);
                } else {
                  isWinning = draw.myMillon.includes(ticket.myMillon);
                }
                div.className = "ticket" + (isWinning ? " winning" : "");
                const highlightedNums = highlightMatches(ticket.numbers, draw.numbers, "number");
                const highlightedStars = highlightMatches(ticket.stars, draw.stars, "star");
                let myMillionDisplay = formatMyMillion(ticket.myMillon);
                let ticketLabel = `<strong>Ticket ${index + 1}</strong>`;
                if (document.getElementById("showCombinationNumber")?.checked
                  && ticket.stars.length === 1
                  && ticket.numbers.length === 5) {
                  const combIdx = combinationIndex(ticket.numbers, ticket.stars[0]);
                  ticketLabel += ` <span style="color:gray; font-size:0.95em; font-weight:normal;">(${combIdx.toLocaleString('fr-FR')})</span>`;
                }
                if (isWinning) {
                  myMillionDisplay = `<span style="color: green; font-weight: bold;">${formatMyMillion(ticket.myMillon)}</span>`;
                }
                div.innerHTML = `
				${ticketLabel} :<br>
				Num√©ros : ${highlightedNums}<br>
				Chance  : ${highlightedStars}<br>
				Code Loto : ${myMillionDisplay}
			  `;
                document.getElementById("ticketsContainer").appendChild(div);
              });
              let tirageLabel = `<strong>Tirage</strong>`;
              if (
                document.getElementById("showCombinationNumber")?.checked &&
                draw.numbers.length === 5 &&
                draw.stars.length === 1
              ) {
                const idx = combinationIndex(draw.numbers, draw.stars[0]);
                tirageLabel += ` <span style="color:gray; font-size:0.95em; font-weight:normal;">(${idx.toLocaleString('fr-FR')})</span>`;
              }

              const isPlain = typeof fancyDisplay !== "undefined" && !fancyDisplay;
              document.getElementById("resultat").innerHTML =
                `${tirageLabel} :<br>` +
                `Num√©ros : ${isPlain ? simpleTextList(draw.numbers) : balls(draw.numbers, "number")}<br>` +
                `Chance  : ${isPlain ? simpleTextList(draw.stars) : balls(draw.stars, "star")}<br>` +
                `Code Loto : ${formatCodesList(draw.myMillon)}`;

              document.getElementById("counter").textContent = "Tirages : " + count.toLocaleString('de-DE');
              document.getElementById("grillesPlayed").textContent = "Grilles jou√©es : " + totalGrillesJouees.toLocaleString('de-DE');
              updateTimePassed(count);
              updateStatsDisplay();
              updateGainDisplay();
              return;
            }
          }
        }
        updateGainChart();

        if (stopAfterYearsChecked) {
          const currentYears = (count * (7 / 3)) / 365;
          if (currentYears >= stopAfterYearsValue) {
            document.getElementById("ticketsContainer").innerHTML = "";
            const isPlain = typeof fancyDisplay !== "undefined" && !fancyDisplay;
            document.getElementById("resultat").innerHTML =
              `<strong>Tirage :</strong><br>
			   Num√©ros : ${isPlain ? simpleTextList(draw.numbers) : balls(draw.numbers, "number")}<br>
			   Chance : ${isPlain ? simpleTextList(draw.stars) : balls(draw.stars, "star")}${document.getElementById("myMillonCheckbox").checked ? "<br>Code Loto : " + formatCodesList(draw.myMillon) : ""}`;

            document.getElementById("counter").textContent = "Tirages : " + count.toLocaleString('de-DE');
            document.getElementById("grillesPlayed").textContent = "Grilles jou√©es : " + totalGrillesJouees.toLocaleString('de-DE');
            updateTimePassed(count);
            updateStatsDisplay();
            updateGainDisplay();
            alert("On a d√©pass√© les " + stopAfterYearsValue + " ans de simulation !\n(Nombre de tirages : " + count.toLocaleString('de-DE') + ")");

            if (balance >= 1) {
              playSound("win.mp3");
            } else if (balance <= -1000000) {
              playSound("bigloose.mp3");
              addLooseImage("bigloose.jpeg");
            }

            stopFlag = true;
            simulationActive = false;
            document.getElementById("startBtn").style.display = "inline-block";
            document.getElementById("startBtn").textContent = "Nouvelle simulation";
            document.getElementById("stopBtn").style.display = "inline-block";
            document.getElementById("stopBtn").textContent = "Continuer";

            return;
          }
        }

        let foundWinningTicket = false;
        let winningTicket = null;
        tickets.forEach(ticket => {
          const n = ticket.numbers.length;
          const s = ticket.stars.length;

          const numGood = countMatches(ticket.numbers, draw.numbers);
          const numBad = n - numGood;
          const starGood = countMatches(ticket.stars, draw.stars);
          const starBad = s - starGood;

          for (let nb = 0; nb <= Math.min(5, n); nb++) {
            for (let sb = 0; sb <= Math.min(1, s); sb++) {
              const waysNum = combination(numGood, nb) * combination(numBad, 5 - nb);
              const waysStar = combination(starGood, sb) * combination(starBad, 1 - sb);
              const countGrilles = waysNum * waysStar;
              if (countGrilles > 0) {
                const key = nb + "_" + sb;
                if (stats.hasOwnProperty(key)) {
                  const prevCount = stats[key];
                  stats[key] += countGrilles;
                  if (prevCount === 0 && countGrilles > 0) {
                    firstOccurrence[key] = count;
                    updateDetailsModalIfOpen();
                  }
                }
                let prize = prizeMapping[key] || 0;
                if (document.getElementById("multichanceCheckbox").checked) {
                  prize *= multichanceRatio;
                }
                balance += prize * countGrilles;
                statsGain[key] += prize * countGrilles;

                if (!foundWinningTicket && nb >= stopNumbers && sb >= stopStars && countGrilles > 0) {
                  foundWinningTicket = true;
                  winningTicket = ticket;
                }
              }
            }
          }
        });


        if (foundWinningTicket) {
          document.getElementById("ticketsContainer").innerHTML = "";
          adjustTicketColumns(tickets);
          tickets.forEach((ticket, index) => {
            const div = document.createElement("div");
            div.className = "ticket";
            const highlightedNums = highlightMatches(ticket.numbers, draw.numbers, "number");
            const highlightedStars = highlightMatches(ticket.stars, draw.stars, "star");
            let ticketLabel = `<strong>Ticket ${index + 1}</strong>`;
            const showIdx = document.getElementById("showCombinationNumber")?.checked;
            if (showIdx && ticket.stars.length === 1 && ticket.numbers.length === 5) {
              const combIdx = combinationIndex(ticket.numbers, ticket.stars[0]);
              ticketLabel += ` <span style="color:gray; font-size:0.95em; font-weight:normal;">(${combIdx.toLocaleString('fr-FR')})</span>`;
            }
            div.innerHTML = `${ticketLabel} :<br>
						 Num√©ros : ${highlightedNums}<br>
						 Chance : ${highlightedStars}${document.getElementById("myMillonCheckbox").checked ? "<br>Code Loto : " + formatMyMillion(ticket.myMillon) : ""}`;
            document.getElementById("ticketsContainer").appendChild(div);
            if (ticket === winningTicket) {
              div.classList.add("winning");
            }
            document.getElementById("ticketsContainer").appendChild(div);
          });

          let tirageLabel = `<strong>Tirage</strong>`;
          if (
            document.getElementById("showCombinationNumber")?.checked
            && draw.numbers.length === 5
            && draw.stars.length === 1
          ) {
            const idx = combinationIndex(draw.numbers, draw.stars[0]);
            tirageLabel += ` <span style="color:gray; font-size:0.95em; font-weight:normal;">(${idx.toLocaleString('fr-FR')})</span>`;
          }

          const isPlain = typeof fancyDisplay !== "undefined" && !fancyDisplay;
          document.getElementById("resultat").innerHTML =
            `${tirageLabel} :<br>` +
            `Num√©ros : ${isPlain ? simpleTextList(draw.numbers) : balls(draw.numbers, "number")}<br>` +
            `Chance  : ${isPlain ? simpleTextList(draw.stars) : balls(draw.stars, "star")}` +
            (document.getElementById("myMillonCheckbox").checked
              ? `<br>Code Loto : ${formatCodesList(draw.myMillon)}`
              : "");


          document.getElementById("counter").textContent = "Tirages : " + count.toLocaleString('de-DE');
          document.getElementById("grillesPlayed").textContent = "Grilles jou√©es : " + totalGrillesJouees.toLocaleString('de-DE');
          updateTimePassed(count);
          updateStatsDisplay();
          updateGainDisplay();

          const winningMatchNumbers = countMatches(winningTicket.numbers, draw.numbers);
          const winningMatchStars = countMatches(winningTicket.stars, draw.stars);
          const winningKey = winningMatchNumbers + "_" + winningMatchStars;
          let winningGain = prizeMapping[winningKey] || 0;
          if (document.getElementById("multichanceCheckbox").checked) {
            winningGain *= multichanceRatio;
          }
          if (winningMatchNumbers === 5 && winningMatchStars === 1) {
            launchFireworks();
          }
          const tempsEcoule = formatTimeInDays(count * (7 / 3));
          alert("Seuil atteint !\n" +
            "Ticket gagnant : " + winningTicket.numbers.join(", ") + " | " + winningTicket.stars.join(", ") + "\n" +
            "Tirage : " + draw.numbers.join(", ") + " | " + draw.stars.join(", ") + "\n" +
            "Nombre de tirages : " + count.toLocaleString('de-DE') + "\n" +
            "Temps √©coul√© : " + tempsEcoule + "\n" +
            "Gain : " + winningGain.toLocaleString('de-DE', { maximumFractionDigits: 0 }) + " ‚Ç¨");

          if (balance >= 1) {
            playSound("win.mp3");
          } else if (balance <= -1000000) {
            playSound("bigloose.mp3");
            addLooseImage("bigloose.jpeg");
          }

          if (gainChart) {
            addGainPoint(count, balance);
            lastY = balance;
          }

          stopFlag = true;
          simulationActive = false;
          document.getElementById("startBtn").style.display = "inline-block";
          document.getElementById("startBtn").textContent = "Nouvelle simulation";
          document.getElementById("stopBtn").style.display = "inline-block";
          document.getElementById("stopBtn").textContent = "Continuer";

          return;
        }

        if (document.getElementById("stopNegativeGainCheckbox").checked) {
          const seuil = parseFloat(document.getElementById("stopNegativeGainThreshold").value) || 0;
          if (seuil < 0) {
            if (balance < seuil) {
              document.getElementById("ticketsContainer").innerHTML = "";
              adjustTicketColumns(tickets);
              const isPlain = typeof fancyDisplay !== "undefined" && !fancyDisplay;
              document.getElementById("resultat").innerHTML =
                `<strong>Tirage :</strong><br>
				 Num√©ros : ${isPlain ? simpleTextList(draw.numbers) : balls(draw.numbers, "number")}<br>
				 Chance  : ${isPlain ? simpleTextList(draw.stars) : balls(draw.stars, "star")}${document.getElementById("myMillonCheckbox").checked ? "<br>Code Loto : " + formatCodesList(draw.myMillon) : ""}`;

              document.getElementById("counter").textContent = "Tirages : " + count.toLocaleString('de-DE');
              document.getElementById("grillesPlayed").textContent = "Grilles jou√©es : " + totalGrillesJouees.toLocaleString('de-DE');
              updateTimePassed(count);
              updateStatsDisplay();
              updateGainDisplay();
              alert("Le solde est pass√© en dessous du seuil (" + seuil + " ‚Ç¨). La simulation est arr√™t√©e.");

              if (balance >= 1) {
                playSound("win.mp3");
              } else if (balance <= -1000000) {
                playSound("bigloose.mp3");
                addLooseImage("bigloose.jpeg");
              }
              stopFlag = true;
              simulationActive = false;
              document.getElementById("startBtn").style.display = "inline-block";
              document.getElementById("startBtn").textContent = "Nouvelle simulation";
              document.getElementById("stopBtn").style.display = "inline-block";
              document.getElementById("stopBtn").textContent = "Continuer";
              return;
            }
          } else {
            if (balance > seuil) {
              document.getElementById("ticketsContainer").innerHTML = "";
              adjustTicketColumns(tickets);
              const isPlain = typeof fancyDisplay !== "undefined" && !fancyDisplay;
              document.getElementById("resultat").innerHTML =
                `<strong>Tirage :</strong><br>
				 Num√©ros : ${isPlain ? simpleTextList(draw.numbers) : balls(draw.numbers, "number")}<br>
				 Chance  : ${isPlain ? simpleTextList(draw.stars) : balls(draw.stars, "star")}${document.getElementById("myMillonCheckbox").checked ? "<br>Code Loto : " + formatCodesList(draw.myMillon) : ""}`;

              document.getElementById("counter").textContent = "Tirages : " + count.toLocaleString('de-DE');
              document.getElementById("grillesPlayed").textContent = "Grilles jou√©es : " + totalGrillesJouees.toLocaleString('de-DE');
              updateTimePassed(count);
              updateStatsDisplay();
              updateGainDisplay();
              alert("Le solde a d√©pass√© le seuil (" + seuil + " ‚Ç¨). La simulation est arr√™t√©e.");

              if (balance >= 1) {
                playSound("win.mp3");
              } else if (balance <= -1000000) {
                playSound("bigloose.mp3");
                addLooseImage("bigloose.jpeg");
              }
              stopFlag = true;
              simulationActive = false;
              document.getElementById("startBtn").style.display = "inline-block";
              document.getElementById("startBtn").textContent = "Nouvelle simulation";
              document.getElementById("stopBtn").style.display = "inline-block";
              document.getElementById("stopBtn").textContent = "Continuer";
              return;
            }
          }
        }
      }

      document.getElementById("ticketsContainer").innerHTML = "";
      adjustTicketColumns(tickets);
      tickets.forEach((ticket, index) => {
        const div = document.createElement("div");
        div.className = "ticket";
        const highlightedNums = highlightMatches(ticket.numbers, draw.numbers, "number");
        const highlightedStars = highlightMatches(ticket.stars, draw.stars, "star");
        let ticketLabel = `<strong>Ticket ${index + 1}</strong>`;
        const showIdx = document.getElementById("showCombinationNumber")?.checked;
        if (showIdx && ticket.stars.length === 1 && ticket.numbers.length === 5) {
          const combIdx = combinationIndex(ticket.numbers, ticket.stars[0]);
          ticketLabel += ` <span style="color:gray; font-size:0.95em; font-weight:normal;">(${combIdx.toLocaleString('fr-FR')})</span>`;
        }
        div.innerHTML = `${ticketLabel} :<br>
						 Num√©ros : ${highlightedNums}<br>
						 Chance : ${highlightedStars}${document.getElementById("myMillonCheckbox").checked ? "<br>Code Loto : " + formatMyMillion(ticket.myMillon) : ""}`;
        document.getElementById("ticketsContainer").appendChild(div);
      });

		window._lastTicketsData = {
		  tickets: tickets,
		  draw: draw,
		  myMillion: document.getElementById("myMillonCheckbox").checked
		};

		if (document.getElementById("showFrequenciesCheckbox").checked) {
		  renderFrequencies();
		}


      const isPlain = typeof fancyDisplay !== "undefined" && !fancyDisplay;
      document.getElementById("resultat").innerHTML =
        `<strong>
      Tirage${(draw.numbers?.length === 5 && draw.stars?.length === 1 && document.getElementById("showCombinationNumber")?.checked)
          ? ` <span style="color:gray; font-size:0.95em; font-weight:normal;">(${combinationIndex(draw.numbers, draw.stars[0]).toLocaleString('fr-FR')})</span>`
          : ""} :
   </strong><br>
	   Num√©ros : ${isPlain ? simpleTextList(draw.numbers) : balls(draw.numbers, "number")}<br>
	   Chance : ${isPlain ? simpleTextList(draw.stars) : balls(draw.stars, "star")}${document.getElementById("myMillonCheckbox").checked ? "<br>Code Loto : " + formatCodesList(draw.myMillon) : ""}`;

      document.getElementById("counter").textContent = "Tirages : " + count.toLocaleString('de-DE');
      document.getElementById("grillesPlayed").textContent = "Grilles jou√©es : " + totalGrillesJouees.toLocaleString('de-DE');
      updateTimePassed(count);
      updateStatsDisplay();
      updateGainDisplay();

      loopTimeout = setTimeout(runLoop, speed);
    }

    function startDrawing() {
      prizeTableModified = false;
      historySaved = false;
      firstOccurrence = {};
      lastDetailsModalState = "";
      const list = document.getElementById("detailsList");
      if (list) list.innerHTML = "";

      simulationHasStarted = true;
      resetGainChart();

      if (document.getElementById("modeSelect").value === "flash" && document.getElementById("multichanceCheckbox").checked) {
        const totalParts = parseInt(document.getElementById("totalParts").value) || 0;
        const yourParts = parseInt(document.getElementById("yourParts").value) || 0;
        if (yourParts > totalParts) {
          alert("Erreur : Votre nombre de parts (" + yourParts + ") ne peut pas d√©passer le total de parts (" + totalParts + ").");
          return;
        }
      }
      clearTimeout(loopTimeout);
      count = 0;
      stopFlag = false;
      balance = 0;
      totalGrillesJouees = 0;
      for (let combo in stats) {
        stats[combo] = 0;
        statsGain[combo] = 0;
      }
      myMillionWinCount = 0;
      myMillionTotalGain = 0;
      simulationActive = true;
      document.getElementById("counter").textContent = "Tirages : 0";
      document.getElementById("grillesPlayed").textContent = "Grilles jou√©es : 0";
      document.getElementById("timePassed").textContent = "Temps √©coul√© : 0 jour";
      document.getElementById("gainDisplay").innerHTML = "<span style='color: green;'>Solde : 0,00 ‚Ç¨</span>";
      document.getElementById("ticketsContainer").innerHTML = "";
      document.getElementById("resultat").innerHTML = `<strong>Tirage :</strong><br>Num√©ros : --<br>Chance : --`;
      document.getElementById("stopBtn").textContent = "Stop";
      updateStatsDisplay();
      updateTimePassed(0);
      updateGainDisplay();
      removeLooseImages();
      totalFreqNum.fill(0);
      totalFreqStar.fill(0);
      renderFrequencies();
      document.getElementById("startBtn").style.display = "none";
      document.getElementById("stopBtn").style.display = "inline-block";
      runLoop();
    }

    document.getElementById("myMillonCheckbox").checked = true;
    document.getElementById("stopMyMillonWinCheckbox").checked = false;
    document.getElementById("stopMyMillonWinGroup").style.display = "block";

    document.getElementById("startBtn").addEventListener("click", function () {
      addCurrentRunToHistory();
      startDrawing();
    });

    document.getElementById("stopBtn").addEventListener("click", function () {
      if (!stopFlag) {
        stopFlag = true;
        simulationActive = false;
        clearTimeout(loopTimeout);
        this.textContent = "Continuer";
      } else {
        stopFlag = false;
        simulationActive = true;
        this.textContent = "Stop";
        runLoop();
        if (simulationActive) {
          document.getElementById("startBtn").style.display = "none";
        }
      }
      updateStatsDisplay();
    });


    document.getElementById("resetBtn").addEventListener("click", function () {
      totalFreqNum.fill(0);
      totalFreqStar.fill(0);
      renderFrequencies();
      addCurrentRunToHistory();
      stopFlag = true;
      simulationHasStarted = false;
      clearTimeout(loopTimeout);
      count = 0;
      totalGrillesJouees = 0;
      for (let combo in stats) {
        stats[combo] = 0;
        statsGain[combo] = 0;
      }
      firstOccurrence = {};
      myMillionWinCount = 0;
      myMillionTotalGain = 0;
      simulationActive = false;
      updateStatsDisplay();
      document.getElementById("counter").textContent = "Tirages : 0";
      document.getElementById("grillesPlayed").textContent = "Grilles jou√©es : 0";
      document.getElementById("timePassed").textContent = "Temps √©coul√© : 0 jour";
      document.getElementById("gainDisplay").innerHTML = "<span style='color: green;'>Solde : 0,00 ‚Ç¨</span>";
      document.getElementById("ticketsContainer").innerHTML = "";
      document.getElementById("resultat").innerHTML = `<strong>Tirage :</strong><br>Num√©ros : --<br>Chance : --`;
      document.getElementById("startBtn").textContent = "D√©marrer la simulation";
      document.getElementById("startBtn").style.display = "inline-block";
      document.getElementById("stopBtn").style.display = "none";

      removeLooseImages();
      resetGainChart();
    });

    updateStatsDisplay();

    document.getElementById("ticketStarsCount").addEventListener("blur", function () {
      let v = parseInt(this.value) || 1;
      if (v < 1) v = 1;
      if (v > 10) v = 10;
      this.value = v;
    });
    document.getElementById("ticketNumbersCount").addEventListener("blur", function () {
      let v = parseInt(this.value) || 5;
      if (v < 5) v = 5;
      if (v > 49) v = 49;
      this.value = v;
    });
    const prizeMappingEditable = { ...prizeMapping };

    document.getElementById("editPrizesLink").addEventListener("click", function (e) {
      e.preventDefault();
      const form = document.getElementById("prizesForm");
      form.innerHTML = "";

      for (const key in prizeMappingEditable) {
        const label = document.createElement("label");
        label.textContent = `${key.replace("_", " n¬∞ + ")} ‚óâ :`;
        const input = document.createElement("input");
        input.type = "number";
        input.step = "1.0";
        input.min = "0";
        input.name = key;
        input.value = prizeMappingEditable[key];
        input.style.margin = "4px";
        input.style.width = "120px";

        const div = document.createElement("div");
        div.appendChild(label);
        div.appendChild(input);
        form.appendChild(div);
      }

      document.getElementById("prizesModal").style.display = "block";
      document.getElementById("modalOverlay").style.display = "block";
    });

    document.getElementById("closePrizesBtn").addEventListener("click", function () {
      savePrizeFormData();
      document.getElementById("prizesModal").style.display = "none";
      document.getElementById("modalOverlay").style.display = "none";
    });
    document.getElementById("resetPrizesBtn").addEventListener("click", function () {
      const defaultPrizes = {
        "5_1": 3000000,
        "5_0": 100000,
        "4_1": 1000,
        "4_0": 500,
        "3_1": 50,
        "3_0": 20,
        "2_1": 10,
        "2_0": 4.4,
        "1_1": 2.2,
        "1_0": 0,
        "0_1": 2.2,
        "0_0": 0
      };

      for (const key in defaultPrizes) {
        prizeMappingEditable[key] = defaultPrizes[key];
        prizeMapping[key] = defaultPrizes[key];
      }

      const form = document.getElementById("prizesForm");
      const inputs = form.querySelectorAll("input");
      inputs.forEach(input => {
        if (defaultPrizes.hasOwnProperty(input.name)) {
          input.value = defaultPrizes[input.name];
        }
      });
      prizeTableModified = false;
    });

    document.getElementById("modalOverlay").addEventListener("click", function () {
      savePrizeFormData();
      document.getElementById("prizesModal").style.display = "none";
      this.style.display = "none";
      document.body.style.overflow = "";
    });

    setTimeout(() => {
      const link = document.getElementById("examplesLink");
      if (link) {
        link.addEventListener("click", e => {
          e.preventDefault();
          openExamplesModal(lastOdds);
        });
      }
    }, 0);
    document.getElementById('showDetails').addEventListener('click', e => {
      e.preventDefault();
      const list = document.getElementById('detailsList');
      list.innerHTML = '';

      const allPaliers = [
        { key: 'myMillion', label: 'Code loto' },
        { n: 5, s: 1 }, { n: 5, s: 0 },
        { n: 4, s: 1 }, { n: 4, s: 0 },
        { n: 3, s: 1 }, { n: 3, s: 0 },
        { n: 2, s: 1 }, { n: 2, s: 0 },
        { n: 1, s: 1 }, { n: 1, s: 0 },
        { n: 0, s: 1 }, { n: 0, s: 0 }
      ];


      allPaliers.forEach(p => {
        const key = p.key || `${p.n}_${p.s}`;
        const label = p.label || `${p.n} n¬∞ + ${p.s} ‚óâ`;
        const li = document.createElement('li');
        if (firstOccurrence[key]) {
          const days = firstOccurrence[key] * (7 / 3);
          const when = formatTimeInDays(days, { skipSmallUnitsIfYearOrCentury: true });
          li.textContent = `${label} : obtenu en ${when}`;
        } else {
          li.innerHTML = `<span style="color:gray">${label} : jamais obtenu</span>`;
        }
        list.appendChild(li);
      });


      document.getElementById('modalOverlayDetails').style.display = 'block';
      document.getElementById('detailsModal').style.display = 'block';
    });

    document.getElementById('closeDetailsBtn').addEventListener('click', () => {
      document.getElementById('detailsModal').style.display = 'none';
      document.getElementById('modalOverlayDetails').style.display = 'none';
    });
    document.getElementById('modalOverlayDetails').addEventListener('click', () => {
      document.getElementById('detailsModal').style.display = 'none';
      document.getElementById('modalOverlayDetails').style.display = 'none';
    });

    document.addEventListener("DOMContentLoaded", () => {
      document.getElementById("historyLink").addEventListener("click", (e) => {
        e.preventDefault();
        renderHistory();
        document.getElementById("historyModal").style.display = "block";
      });

      document.getElementById("closeHistoryBtn").addEventListener("click", () => {
        document.getElementById("historyModal").style.display = "none";
      });

      document.getElementById("historyModal").addEventListener("click", (e) => {
        if (e.target.id === "historyModal") {
          document.getElementById("historyModal").style.display = "none";
        }
      });
    });

    function persistLastRun() {
      try { addCurrentRunToHistory(); } catch { }
    }

    window.addEventListener('beforeunload', persistLastRun);
    window.addEventListener('pagehide', persistLastRun);
	

	function renderFrequencies() {
	  const chk = document.getElementById('showFrequenciesCheckbox');
	  const box = document.getElementById('frequencyContainer');
	  if (!chk || !box) return;
	  
	  box.style.display = chk.checked ? 'block' : 'none';
	  if (!chk.checked) return;
	  
	  if (typeof currentBatchSize !== 'undefined' && typeof currentSpeed !== 'undefined') {
		if (currentBatchSize >= 100) {
		  if (typeof count !== 'undefined' && count % 2000 !== 0) return;
		}
	  }

	  const sortMode = document.getElementById('freqSort')?.value || 'natural';
	  const nums  = Array.from({ length: 49 }, (_, i) => i + 1);
	  const stars = Array.from({ length: 10 }, (_, i) => i + 1);

	  function cmpByFreq(a, b, totals) {
		if (sortMode === 'natural') return a - b;
		if (sortMode === 'desc') {
		  const d = (totals[b] || 0) - (totals[a] || 0);
		  return d !== 0 ? d : (a - b);
		}
		const d = (totals[a] || 0) - (totals[b] || 0);
		return d !== 0 ? d : (a - b);
	  }

	  nums.sort((a, b) => cmpByFreq(a, b, totalFreqNum));
	  stars.sort((a, b) => cmpByFreq(a, b, totalFreqStar));

	  const numTarget  = document.getElementById('freqNumbers');
	  const starTarget = document.getElementById('freqStars');
	  if (!numTarget || !starTarget) return;
	  numTarget.innerHTML = '';
	  starTarget.innerHTML = '';

	  const last = window._lastTicketsData?.draw || null;
	  const lastNums  = last ? last.numbers : [];
	  const lastStars = last ? last.stars   : [];

	  nums.forEach(n => {
		const el = document.createElement('div');
		el.className = 'freq-item';
		const cls = lastNums.includes(n) ? 'number-ball last-draw' : 'number-ball';
		el.innerHTML = `
		  <span class="${cls}">${n}</span>
		  <span class="freq-count">${(totalFreqNum[n] || 0).toLocaleString('fr-FR')}√ó</span>
		`;
		numTarget.appendChild(el);
	  });

	  stars.forEach(s => {
		const el = document.createElement('div');
		el.className = 'freq-item';
		const cls = lastStars.includes(s) ? 'star-ball last-draw' : 'star-ball';
		el.innerHTML = `
		  <span class="${cls}">${s}</span>
		  <span class="freq-count">${(totalFreqStar[s] || 0).toLocaleString('fr-FR')}√ó</span>
		`;
		starTarget.appendChild(el);
	  });
	}

  </script>
  </div>
</body>

</html>
