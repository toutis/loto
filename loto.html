<!DOCTYPE html>
<html lang="fr">
<head>
  <!-- Projet sous licence MIT – Voir fichier LICENSE.
	Simulation pédagogique et indépendante, sans affiliation ni approbation de la Française des Jeux (FDJ).
	Aucune mise réelle, aucun gain, aucune collecte de données personnelles. -->
  <meta charset="UTF-8">
  <title>Simulation Loto</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
  <link rel="shortcut icon" type="image/x-icon" href="favicon.ico">
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0px;
      padding-left: 30px;
      padding-right: 30px;
    }
    .main-container {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      flex-wrap: wrap;
      gap: 10px;
    }
    .left-column {
      flex: 1;
      max-width: 45%;
      text-align: left;
    }
    .right-column {
      flex: 1;
      max-width: 45%;
      text-align: left;
    }
    .form-group,
    .display,
    .compteur {
      font-size: 1.1em;
      margin: 10px 0;
    }
    input,
    button,
    select,
    textarea {
      padding: 6px 12px;
      font-size: 1em;
      margin: 5px;
    }
    .ticket {
      border: 1px solid #aaa;
      padding: 8px;
      margin: 5px 0;
      width: fit-content;
    }
    .winning {
      background-color: #cfc;
    }
    #chanceDisplay {
      font-weight: bold;
      margin: 10px 0;
    }
    #resultat {
      border: 2px solid #008ccd;
      padding: 10px;
      margin: 10px 0;
    }
    #statsContainer {
      margin-top: 20px;
    }
    #statsContainer ul {
      list-style: none;
      padding: 0;
    }
    #statsContainer li {
      margin: 5px 0;
    }
    #multichanceAndMyMillonContainer {
      display: flex;
      align-items: center;
    }
    .info-icon {
      display: inline-block;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background-color: #ccc;
      text-align: center;
      line-height: 16px;
      font-size: 12px;
      margin-left: 5px;
      cursor: help;
    }
    #speedControlGroup {
      display: flex;
      align-items: center;
      justify-content: flex-start;
      gap: 10px;
      margin: 10px 0;
    }
    #speedValueLabel {
      color: gray;
    }
    #fireworksContainer {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 9999;
    }
    .firework {
      position: absolute;
      width: 4px;
      height: 4px;
      background: radial-gradient(circle, var(--color) 0%, var(--color-dark) 70%);
      border-radius: 50%;
      opacity: 1;
      animation: firework 2.0s ease-out forwards;
      box-shadow: 0 0 15px var(--color);
    }
    @keyframes firework {
      0% { transform: scale(1); opacity: 1; }
      50% { opacity: 1; }
      100% { transform: translate(var(--tx), var(--ty)) scale(3); opacity: 0; }
    }
	.sound-toggle {
	  cursor: pointer;
	  margin-left: 0px;
	  font-size: 24px;
	  vertical-align: middle;
	}
    .sound-toggle span {
      display: inline-block;
    }
	.icons-bar {
	  display: inline-flex;
	  align-items: center;
	  gap: 4px;
	}
    #stopMyMillonWinGroup {
      margin-left: 22px;
      margin-top: 0;
      font-size: 0.95em;
      display: none;
    }
    .number-ball, .star-ball {
      display: inline-flex;
      justify-content: center;
      align-items: center;
      width: 30px;
      height: 30px;
      margin: 2px 0px; 
      font-size: .85em;
      font-weight: bold;
      color: #fff;
      position: relative;
      vertical-align: middle;
      user-select: none;
    }
    .number-ball {
      background: #187ad2;
      border-radius: 50%;
    }
    .star-ball {
      background: #e35050;
      border-radius: 50%;
    }
	.match {
	  opacity: 1 !important;
	}
	.semi {
	  opacity: 0.45;
	}
	#ticketsContainer{
	}
	#ticketsContainer .ticket{
	  display: inline-block;
	  margin: 6px 0; 
	  box-sizing: border-box;
	}
	#ticketsContainer.cols-2{
	  display: grid;
	  grid-template-columns: repeat(2, minmax(320px, 1fr));
	  gap: 12px;
	}
	#ticketsContainer.cols-2 .ticket{
	  display: block;
	  width: 100%;
	  margin: 0;
	}
	#resultat,
	.ticket {
	  word-break: break-word;
	  white-space: normal;
	}
	.display-toggle {
	  cursor: pointer;
	  margin-left: 0px; 
	  font-size: 24px;
	  user-select: none;
	  vertical-align: middle;
	}
	body.plain-display .number-ball,
	body.plain-display .star-ball {
	  background: none !important;
	  color: #111 !important;
	  font-family: inherit !important;
	  font-size: inherit !important;
	  font-weight: normal !important;
	  letter-spacing: 0 !important;
	  border-radius: 0 !important;
	  box-shadow: none !important;
	  width: auto !important;
	  height: auto !important;
	  padding: 0 2px !important;
	  margin: 0 2px !important;
	  opacity: 1 !important;
	  vertical-align: baseline !important;
	}

	body.plain-display .number-ball.semi,
	body.plain-display .star-ball.semi {
	  color: #111 !important;
	  opacity: 1 !important;
	}

	body.plain-display .number-ball.match,
	body.plain-display .star-ball.match {
	  color: #159f13 !important; 
	  font-weight: bold !important;
	  opacity: 1 !important;
	}

	body.plain-display .star-ball::before {
	  display: none !important;
	}
	
	body.plain-display .number-ball,
	body.plain-display .star-ball {
	  font-family: inherit !important;
	  font-size: inherit !important;
	  margin-right: 0 !important;
	  word-spacing: 0 !important;
	}
	
		body.plain-display .number-ball,
	body.plain-display .star-ball {
	  display: inline-block !important;
	}

	body.plain-display .number-ball,
	body.plain-display .star-ball {
	  letter-spacing: 0 !important;
	}

	body.plain-display .ticket span {
	  font-family: inherit !important;
	  font-size: inherit !important;
	}

	body.plain-display .ticket {
	  font-family: inherit;
	  font-size: inherit;
	  word-spacing: 0 !important;
	}
	
	body.plain-display .number-ball.match,
	body.plain-display .star-ball.match,
	body.plain-display .match {
	  color: #159f13 !important;
	  font-weight: bold !important;
	  opacity: 1 !important;
	}
	
	
  </style>
</head>
<body>
  <div class="main-container">
    <div class="left-column">
	<h1>
	  Simulation Loto
	    <span class="icons-bar">
	  <span id="soundToggle" class="sound-toggle">
	  </span>

	  <span id="displayToggle" class="display-toggle"
			title="Basculer l’affichage des boules / affichage texte">
	  </span>
	  </span>
	</h1>

      <div class="section">
        <div class="form-group">
          <label for="modeSelect">Mode :</label>
          <select id="modeSelect">
            <option value="flash" selected>Flash (tickets aléatoires)</option>
            <option value="custom">Personnalisé (définir mes propres grilles)</option>
          </select>
        </div>
        <div class="form-group" id="flashSettings">
          <label for="ticketNumbersCount">Nombre de numéros (min 5, max 49) :</label>
          <input type="number" id="ticketNumbersCount" value="5" min="5" max="49"><br>
          <label for="ticketStarsCount">Nombre d'Chance (min 1, max 10) :</label>
          <input type="number" id="ticketStarsCount" value="1" min="1" max="10">
        </div>
        <div class="form-group" id="customSettings" style="display:none;">
          <label for="customGrids">
            Mes grilles personnalisées :<br>
            Entrez une grille par ligne au format "num1,num2,... ; chance1,..."<br>
            Exemple: <em>3,15,22,37,42 ; 1</em>
          </label>
          <br>
          <textarea id="customGrids" rows="4" cols="50" placeholder="Une grille par ligne"></textarea>
        </div>
        <div class="form-group" id="ticketsCountGroup">
          <label for="numTickets">Nombre de tickets par tirage :</label>
          <input type="number" id="numTickets" value="1" min="1">
        </div>
        <div class="form-group">
          <label for="stopNumbers">Stopper si au moins X numéros corrects :</label>
          <input type="number" id="stopNumbers" value="5" min="0" max="5">
        </div>
        <div class="form-group">
          <label for="stopStars">Stopper si au moins Y chance correctes :</label>
          <input type="number" id="stopStars" value="1" min="0" max="1">
        </div>
        <div class="form-group">
          <input type="checkbox" id="stopNegativeGainCheckbox">
          <label for="stopNegativeGainCheckbox">Stopper si le gain net est négatif à :</label>
          <input type="number" id="stopNegativeGainThreshold" value="10000" step="0.01" style="width:100px;">
        </div>
        <div class="form-group">
          <input type="checkbox" id="stopAfterYearsCheckbox">
          <label for="stopAfterYearsCheckbox">Stopper si on dépasse X années :</label>
          <input type="number" id="stopAfterYearsInput" value="50" min="1" style="width:80px;">
        </div>
        <div class="form-group" id="speedControlGroup">
          <label for="speedSlider">Vitesse :</label>
          <input type="range" id="speedSlider" min="1" max="100" value="50" list="tickmarks">
          <datalist id="tickmarks">
            <option value="50" label="50%"></option>
          </datalist>
          <span id="speedValueLabel">(Tirage = 1, Délai = 1000 ms)</span>
        </div>

		<div style="display: flex; align-items: center; gap: 20px; margin-bottom: 10px;">
		  <div>
			<input type="checkbox" id="myMillonCheckbox" checked>
			<label for="myMillonCheckbox">
				Codes Loto <span class="info-icon" title="L'option Code Loto : Chaque lundi, environ 3 millions de grilles sont jouées, 4,2 millions le mercredi, et 6 millions le samedi.
À chaque tirage, 10 codes gagnants sont tirés au sort parmi toutes les grilles jouées.
Chaque code gagnant remporte 20.000 € !">i</span>
			</label>
		  </div>

		  <div>
			<input type="checkbox" id="multichanceCheckbox">
			<label for="multichanceCheckbox">
			  Multichance <span class="info-icon" title="L'option Multichance : Il permet de réduire votre mise en répartissant votre investissement sur plusieurs parts.
Cela diminue le coût par ticket, mais réduit également les gains proportionnellement au nombre de parts détenues.
Cette option est utilisée seulement avec une dizaine de grilles multiples.
Exemple : 10 grilles multiples (6 numéros, 10 Chance), 1 à 10 parts sur 200">i</span>
			</label>
		  </div>

		  <div>
			<input type="checkbox" id="smartDrawCheckbox">
			<label for="smartDrawCheckbox">
			  Tirage intelligent 
<span class="info-icon" title="Active une stratégie de sélection basée sur la rareté.

Les numéros et Chance les moins souvent tirés au cours des 30 derniers tirages 
sont privilégiés, dans l’espoir qu’ils soient « en retard ». Cela repose sur 
l’idée de compenser une sous-fréquence apparente.

⚠️ En réalité, chaque tirage est totalement indépendant des précédents, 
et tous les numéros ont toujours exactement la même probabilité de sortir.
Cette méthode n'augmente donc pas objectivement vos chances.">i</span>

			</label>

		  </div>
		</div>

		<div class="form-group" id="stopMyMillonWinGroup" style="margin-left: 10px; margin-bottom: 10px;">
		  <input type="checkbox" id="stopMyMillonWinCheckbox">
		  <label for="stopMyMillonWinCheckbox">Stopper si on gagne un code loto</label>
		</div>

		<div id="smartDrawSettings" style="margin-left: 22px; margin-top: 0px; display: none;">
		  <label for="rareNumbersCount">Nb de numéros rares (0 à 5) :</label>
		  <input type="number" id="rareNumbersCount" value="3" min="0" max="5" style="width: 60px;"><br>
		  <label for="rareStarsCount">Nb de chance rares (0 à 1) :</label>
		  <input type="number" id="rareStarsCount" value="1" min="0" max="1" style="width: 60px;">
		</div>

        <div class="form-group" id="multichancePartsContainer" style="display:none; margin-left:20px;">
          <label for="totalParts">Total de parts :</label>
          <input type="number" id="totalParts" value="200" min="1"><br>
          <label for="yourParts">Votre nombre de parts :</label>
          <input type="number" id="yourParts" value="1" min="1">
        </div>
        <div style="display: inline-flex; gap: 10px;">
          <button id="startBtn">Démarrer la simulation</button>
          <button id="stopBtn">Stop</button>
          <button id="resetBtn">Reset</button>
        </div>
      </div>
    </div>
    <div class="right-column">
      <div id="chanceDisplay"></div>
      <div class="section display" id="resultat">
        <strong>Tirage :</strong><br>
        Numéros : --<br>
        Chance : --<br>
      </div>
      <div class="compteur" id="counter">Tirages : 0</div>
      <div class="compteur" id="timePassed">Temps écoulé : 0 jour</div>
      <div class="compteur" id="grillesPlayed">Grilles jouées : 0</div>
      <div class="compteur" id="gainDisplay">Gain net : 0 €</div>
      <div class="section display" id="ticketsContainer"></div>
	  <canvas id="gainChart" height="150"></canvas>
      <div class="section display" id="statsContainer">
        <h3>Statistiques de résultats</h3>
        <ul>
          <li id="stats_myMillion" style="display: list-item;">
            Code loto : <span id="stats_myMillion_value">0</span>
            <span id="stats_myMillion_pct"></span>
            <span id="stats_myMillion_gain"></span>
          </li>
          <li>5 n° + 1 ◉ : <span id="stats_5_1">0</span></li>
          <li>5 n° + 0 ◉ : <span id="stats_5_0">0</span></li>
          <li>4 n° + 1 ◉ : <span id="stats_4_1">0</span></li>
          <li>4 n° + 0 ◉ : <span id="stats_4_0">0</span></li>
          <li>3 n° + 1 ◉ : <span id="stats_3_1">0</span></li>
          <li>3 n° + 0 ◉ : <span id="stats_3_0">0</span></li>
          <li>2 n° + 1 ◉ : <span id="stats_2_1">0</span></li>
          <li>2 n° + 0 ◉ : <span id="stats_2_0">0</span></li>
          <li>1 n° + 1 ◉ : <span id="stats_1_1">0</span></li>
          <li>1 n° + 0 ◉ : <span id="stats_1_0">0</span></li>
          <li>0 n° + 1 ◉ : <span id="stats_0_1">0</span></li>
          <li>0 n° + 0 ◉ : <span id="stats_0_0">0</span></li>
        </ul>
      </div>
    </div>
  </div>
  <div id="fireworksContainer"></div>
  <script>

	let gainChart = null;
	let lastY;

	function initGainChart() {
	  const ctx = document.getElementById("gainChart").getContext("2d");

	  gainChart = new Chart(ctx, {
		type: "line",
		data: {
		  datasets: [{
			label: "Gain net (€)",
			data: [],
			fill: false,
			borderWidth: 2,
			pointRadius: 0,
			tension: 0,
			segment: {
			  borderColor: ctx => ctx.p1.parsed.y >= 0 ? "#43a047" : "#e53935"
			}
		  }]
		},
		options: {
		  animation: false,
		  parsing: false,
		  spanGaps: true,
		  elements: {
			line: {
			  borderCapStyle: 'round',
			  borderJoinStyle: 'round'
			},
			point: {
			  radius: 0
			}
		  },
		  plugins: {
			legend: { display: false },
			decimation: {
			  enabled: true,
			  algorithm: 'min-max',
			  samples: 40000
			}
		  },
		  scales: {
			x: { type: "linear", title: { display: true, text: "Tirages" } },
			y: { title: { display: false, text: "€" } }
		  }
		}
	  });
	}
			
	const GAIN_SEUIL = 20000;

	function updateGainChart() {
	  if (!gainChart) return;

	  const gainNet = balance;
	  let addPoint = false;

	  switch (true) {
		case (count <= 50):
		  addPoint = true;
		  break;
		case (count <= 200):
		  addPoint = (count % 10 === 0);
		  break;
		case (count <= 5000):
		  addPoint = (count % 30 === 0);
		  break;
		case (count <= 10000):
		  addPoint = (count % 100 === 0);
		  break;
		case (count <= 100000):
		  addPoint = (count % 2000 === 0);
		  break;
		case (count <= 1000000):
		  addPoint = (count % 5000 === 0);
		  break;
		case (count <= 5000000):
		  addPoint = (count % 10000 === 0);
		  break;
		case (count <= 20000000):
		  addPoint = (count % 150000 === 0);
		  break;
		case (count <= 80000000):
		  addPoint = (count % 500000 === 0);
		  break;
		default:
		  addPoint = (count % 1000000 === 0);
		  break;
	  }

	  if (gainNet > 0 && lastY !== undefined && Math.abs(gainNet - lastY) >= GAIN_SEUIL) {
		addPoint = true;
	  }

	  if (addPoint) {
		gainChart.data.datasets[0].data.push({ x: count, y: gainNet });
		gainChart.update();
		lastY = gainNet;
	  }
	}



	function resetGainChart() {
	  if (!gainChart) return;
	  gainChart.data.datasets[0].data = [];
	  gainChart.update();
	  lastY = undefined;
	}

	initGainChart();

	function indexToMyMillionCode(n) {
	  const zeroBased   = n - 1;
	  const BLOCK_SIZE  = 200000;
	  const blockNumber = Math.floor(zeroBased / BLOCK_SIZE);

	  const scramble    = (blockNumber * 7919 + 104729) % 26;
	  const firstLetter = String.fromCharCode(65 + scramble);

	  const digits      = String(zeroBased).padStart(7, "0");

	  return `${firstLetter} ${digits.slice(0,3)} ${digits.slice(3)}`;
	}

	function formatMyMillion(val) {
	  if (typeof val === "number")              return indexToMyMillionCode(val);
	  if (typeof val === "string" && val.includes(" à ")) {
		const [start, end] = val.split(" à ").map(Number);
		return `${indexToMyMillionCode(start)} à ${indexToMyMillionCode(end)}`;
	  }
	  return val;
	}
	
	function formatCodesList(arr) {
	  return arr
		.slice()
		.sort((a, b) => {
		  const aStr = formatMyMillion(a).replace(/&nbsp;/g, '').replace(/\s+/g, '');
		  const bStr = formatMyMillion(b).replace(/&nbsp;/g, '').replace(/\s+/g, '');
		  return aStr.localeCompare(bStr);
		})
		.map(formatMyMillion)
		.join(', ');
	}

	let fancyDisplay = true;
	function toggleDisplayStyle() {
	  fancyDisplay = !fancyDisplay;

	  document.getElementById('displayFancyIcon').style.display  = fancyDisplay ? 'inline-block' : 'none';
	  document.getElementById('displayPlainIcon').style.display  = fancyDisplay ? 'none' : 'inline-block';

	  document.body.classList.toggle('plain-display', !fancyDisplay);
	  
	  refreshTicketsDisplay();
	}

	document.getElementById('displayToggle').addEventListener('click', toggleDisplayStyle);

	function simpleTextList(arr) {
	  return arr.join(', ');
	}
	  
	function adjustTicketColumns(tickets){
	  const container = document.getElementById('ticketsContainer');
	  const bigTicket = tickets.some(t =>
		t.numbers.length > 15 || t.stars.length > 10
	  );
	  const twoCols   = tickets.length > 1 && !bigTicket;
	  container.classList.toggle('cols-2', twoCols);
	}

	let soundEnabled = false;
	let currentAudio = null;

	function toggleSound() {
	  soundEnabled = !soundEnabled;
	  document.getElementById('soundOnIcon').style.display = soundEnabled ? 'inline-block' : 'none';
	  document.getElementById('soundOffIcon').style.display = soundEnabled ? 'none' : 'inline-block';
	}

	document.getElementById('soundToggle').addEventListener('click', toggleSound);

	function playSound(soundFile) {
	  if (!soundEnabled) return;
	  if (currentAudio) {
		currentAudio.pause();
		currentAudio = null;
	  }
	  currentAudio = new Audio(soundFile);
	  currentAudio.play().catch((err) => {
		console.warn('Erreur de lecture audio :', err);
	  });
	}

    let stats = {
      "5_1": 0, "5_0": 0,
      "4_1": 0, "4_0": 0,
      "3_1": 0, "3_0": 0,
      "2_1": 0, "2_0": 0,
      "1_1": 0, "1_0": 0,
      "0_1": 0, "0_0": 0
    };

    let myMillionWinCount = 0;
    let myMillionTotalGain = 0;

    let statsGain = {
      "5_1": 0, "5_0": 0,
      "4_1": 0, "4_0": 0,
      "3_1": 0, "3_0": 0,
      "2_1": 0, "2_0": 0,
      "1_1": 0, "1_0": 0,
      "0_1": 0, "0_0": 0
    };

    let count = 0;
    let stopFlag = false;
    let loopTimeout;
    let balance = 0;
    const ticketCost = 2.2;
    let totalGrillesJouees = 0;

    let simulationActive = false; 
    let simulationHasStarted = false;

	const prizeMapping = {
	  "5_1": 3000000,
	  "5_0": 100000,
	  "4_1": 1000,
	  "4_0": 500,
	  "3_1": 50,
	  "3_0": 20,
	  "2_1": 10,
	  "2_0": 4.4,
	  "1_1": 2.2,
	  "1_0": 0,
	  "0_1": 2.2,
	  "0_0": 0
	};


    const speedPresets = [
      { batchSize: 1,     speed: 1000 },
      { batchSize: 10,    speed: 500 },
      { batchSize: 100,   speed: 100 },
      { batchSize: 500,   speed: 50 },
      { batchSize: 1000,  speed: 10 },
      { batchSize: 2000,  speed: 5 },
      { batchSize: 5000,  speed: 2 },
      { batchSize: 10000, speed: 1 },
      { batchSize: 50000, speed: 0 },
      { batchSize: 100000,speed: 0 },
    ];

    let currentBatchSize = speedPresets[4].batchSize;
    let currentSpeed = speedPresets[4].speed;

    function combination(n, r) {
      if (r > n) return 0;
      let num = 1, den = 1;
      for (let i = 0; i < r; i++) {
        num *= (n - i);
        den *= (i + 1);
      }
      return num / den;
    }

    function costOfTicket(ticket) {
      const n = ticket.numbers.length;
      const s = ticket.stars.length;
      return combination(n, 5) * combination(s, 1) * ticketCost;
    }

    function generateNumbers(count, max) {
      let numbers = [];
      while (numbers.length < count) {
        const num = Math.floor(Math.random() * max) + 1;
        if (!numbers.includes(num)) {
          numbers.push(num);
        }
      }
      return numbers.sort((a, b) => a - b);
    }

    function getCombinations(arr, k) {
      const results = [];
      function combine(start, combo) {
        if (combo.length === k) {
          results.push(combo.slice());
          return;
        }
        for (let i = start; i < arr.length; i++) {
          combo.push(arr[i]);
          combine(i + 1, combo);
          combo.pop();
        }
      }
      combine(0, []);
      return results;
    }

    function generateTicket(numCount, starCount) {
      numCount = Math.max(5, Math.min(49, numCount));
      starCount = Math.max(1, Math.min(10, starCount));

      const ticketNumbers = generateNumbers(numCount, 49);
      const ticketStars = generateNumbers(starCount, 10);
      return { numbers: ticketNumbers, stars: ticketStars };
    }
	
	const freqNum  = Array(50).fill(0);
	const freqStar = Array(11).fill(0);
	const MAX_RECENT_DRAWS = 30;
	const recentDraws = [];

	
	function pickUnique(pool, k) {
	  const sac  = [...pool]; 
	  const set  = new Set(); 
	  while (set.size < k && sac.length) {
		const idx = Math.floor(Math.random() * sac.length);
		const val = sac.splice(idx, 1)[0];
		set.add(val);
	  }
	  return [...set].sort((a, b) => a - b);
	}

	function buildCommonRareSet(numCount = 5, starCount = 1) {
	  const rareNumWanted = Math.min(
    parseInt(document.getElementById("rareNumbersCount")?.value) || 0,
    numCount, 5
  );
  const rareStarWanted = Math.min(
    parseInt(document.getElementById("rareStarsCount")?.value) || 0,
    starCount, 1
  );

	  const numsByRarity  = [...Array(49).keys()].map(i => i + 1)
							 .sort((a, b) => freqNum[a]  - freqNum[b]);
	  const starsByRarity = [...Array(10).keys()].map(i => i + 1)
							 .sort((a, b) => freqStar[a] - freqStar[b]);

	  const minFreqNum  = freqNum [numsByRarity [0]];
	  const minFreqStar = freqStar[starsByRarity[0]];

	  const rareNumsPool  = numsByRarity.slice(0, rareNumWanted);
	  const rareStarsPool = starsByRarity.slice(0, rareStarWanted);

	  shuffle(rareNumsPool);
	  shuffle(rareStarsPool);

	  return {
		rareNums : rareNumsPool .slice(0, rareNumWanted),
		rareStars: rareStarsPool.slice(0, rareStarWanted) 
	  };
	}

	function generateSmartTicket(numCount = 5, starCount = 1, lotRares = null) {

	  const chosenNums  = lotRares ? [...lotRares.rareNums ] : [];
	  const chosenStars = lotRares ? [...lotRares.rareStars] : [];

	  while (chosenNums.length < numCount) {
		const n = 1 + Math.floor(Math.random() * 49);
		if (!chosenNums.includes(n)) chosenNums.push(n);
	  }
	  while (chosenStars.length < starCount) {
		const s = 1 + Math.floor(Math.random() * 10);
		if (!chosenStars.includes(s)) chosenStars.push(s);
	  }

	  return {
		numbers: chosenNums.sort((a, b) => a - b),
		stars  : chosenStars.sort((a, b) => a - b)
	  };
	}

	function shuffle(arr) {
	  for (let i = arr.length - 1; i > 0; i--) {
		const j = Math.floor(Math.random() * (i + 1));
		[arr[i], arr[j]] = [arr[j], arr[i]];
	  }
	}

	function generateDraw() {
	  const draw = {
		numbers: generateNumbers(5, 49),
		stars  : generateNumbers(1, 10)
	  };

	  draw.numbers.forEach(n => freqNum[n]++);
	  draw.stars  .forEach(s => freqStar[s]++);

	  recentDraws.push(draw);

	  if (recentDraws.length > MAX_RECENT_DRAWS) {
		const old = recentDraws.shift();
		old.numbers.forEach(n => freqNum[n]--);
		old.stars  .forEach(s => freqStar[s]--);
	  }

	  return draw;
	}



    function countMatches(arr1, arr2) {
      return arr1.filter(x => arr2.includes(x)).length;
    }

    function parseCustomInput(str) {
      return str.split(',')
                .map(s => parseInt(s.trim()))
                .filter(n => !isNaN(n));
    }

    function parseCustomGrids(str) {
      const lines = str.split('\n').filter(line => line.trim() !== '');
      const tickets = [];
      lines.forEach(line => {
        const parts = line.split(';');
        if (parts.length === 2) {
          const numbers = parseCustomInput(parts[0]);
          const stars = parseCustomInput(parts[1]);
          if (numbers.length > 0 && stars.length > 0) {
            tickets.push({ numbers: numbers.sort((a, b) => a - b), stars: stars.sort((a, b) => a - b) });
          }
        }
      });
      return tickets;
    }

    function ballHTML(value, type){
      const cls = type === "star" ? "star-ball" : "number-ball";
      return `<span class="${cls}">${value}</span>`;
    }
	
	function refreshTicketsDisplay() {
	  if (!window._lastTicketsData) return;

	  const { tickets, draw, myMillion } = window._lastTicketsData;

	  document.getElementById("ticketsContainer").innerHTML = "";

	  tickets.forEach((ticket, index) => {
		const div = document.createElement("div");
		div.className = "ticket";
		const highlightedNums = highlightMatches(ticket.numbers, draw.numbers, "number");
		const highlightedStars = highlightMatches(ticket.stars, draw.stars, "star");
		div.innerHTML = `<strong>Ticket ${index + 1} :</strong><br>
						 Numéros : ${highlightedNums}<br>
						 Chance : ${highlightedStars}${myMillion ? `<br>Code Loto : ${formatMyMillion(ticket.myMillon)}` : ""}`;
		document.getElementById("ticketsContainer").appendChild(div);
	  });
	}


	function highlightMatches(values, drawValues, type) {
	  const isPlain = typeof fancyDisplay !== "undefined" && !fancyDisplay;

	  if (isPlain) {
		return values.map((v, i) => {
		  const isMatch = drawValues.includes(v);
		  let str = isMatch
			? `<span class="match">${v}</span>`
			: v;
		  if (i < values.length - 1) str += ', ';
		  return str;
		}).join('');
	  } else {
		return values.map(v => {
		  const cls = drawValues.includes(v) ? 'match' : 'semi';
		  const base = ballHTML(v, type);
		  return base.replace('class="', `class="${cls} `);
		}).join(' ');
	  }
	}

    function balls(values, type){
      return values.map(v => ballHTML(v, type)).join(" ");
    }

    function launchFireworks() {
      const container = document.getElementById('fireworksContainer');
      let count = 0;
      const total = 80;
      const interval = setInterval(() => {
        if (count >= total) {
          clearInterval(interval);
          return;
        }
        const firework = document.createElement('div');
        firework.classList.add('firework');
        const x = Math.random() * window.innerWidth;
        firework.style.left = x + 'px';
        firework.style.top = '0px';
        const tx = (Math.random() - 0.5) * 300;
        const ty = Math.random() * 500;
        firework.style.setProperty('--tx', tx + 'px');
        firework.style.setProperty('--ty', ty + 'px');
        const colors = [
          { light: '#ffcc00', dark: '#ff9900' },
          { light: '#ff3366', dark: '#cc0033' },
          { light: '#66ccff', dark: '#3399ff' },
          { light: '#99ff99', dark: '#33cc33' }
        ];
        const chosen = colors[Math.floor(Math.random() * colors.length)];
        firework.style.setProperty('--color', chosen.light);
        firework.style.setProperty('--color-dark', chosen.dark);
        container.appendChild(firework);
        firework.addEventListener('animationend', () => {
          firework.remove();
        });
        count++;
      }, 25);
    }

    function removeLooseImages() {
      const container = document.querySelector('#looseImageContainer');
      if (container) {
        container.innerHTML = "";
      }
    }

    function addLooseImage(filename) {
      const container = document.querySelector('#looseImageContainer');
      if (!container) return;
      const img = document.createElement('img');
      img.src = filename;
      img.style.width = "1.5em";
      img.style.height = "1.5em";
      img.style.verticalAlign = "middle";
      img.style.marginLeft = "8px";
      container.appendChild(img);
    }

    function updateStatsDisplay() {
      let total = 0;
      for (let combo in stats) total += stats[combo];

      const elemMyMillion = document.getElementById("stats_myMillion");
      const valMyMillion = document.getElementById("stats_myMillion_value");
      const pctMyMillion = document.getElementById("stats_myMillion_pct");
      const gainMyMillion = document.getElementById("stats_myMillion_gain");

      if (!document.getElementById("myMillonCheckbox").checked) {
        elemMyMillion.style.display = "none";
      } else {
        elemMyMillion.style.display = "list-item";
        let percent = count > 0 ? (myMillionWinCount / count * 100) : 0;
        if (myMillionWinCount === 0 && simulationHasStarted && count > 0) {
          valMyMillion.innerHTML = `<span style='color: red;'>0</span>`;
        } else {
          valMyMillion.innerHTML = myMillionWinCount.toLocaleString('de-DE');
        }
        pctMyMillion.innerHTML =  `<span style='color: gray;'>(${percent.toFixed(2)}%)</span>`;
        if (myMillionTotalGain > 0) {
          gainMyMillion.innerHTML =  `<span style='color: green;'>+${myMillionTotalGain.toLocaleString('de-DE', {
            minimumFractionDigits: 1,
            maximumFractionDigits: 1
          })}€</span>`;
        } else {
          gainMyMillion.innerHTML = '';
        }
      }

      for (let combo in stats) {
        const elem = document.getElementById("stats_" + combo);
        if (elem) {
          const countValue = stats[combo];
          let pct = total > 0 ? (countValue / total * 100) : 0;
          const totalPrize = statsGain[combo];
          const totalPrizeFormatted = totalPrize.toLocaleString('de-DE', {
            minimumFractionDigits: 1,
            maximumFractionDigits: 1
          });
          const prizeDisplay = totalPrize === 0 ? "" : `<span style='color: green;'>+${totalPrizeFormatted}€</span>`;
          if (countValue === 0) {
            elem.innerHTML =
              `<span style='color: ${simulationHasStarted ? 'red' : 'black'};'>${countValue.toLocaleString('de-DE')}</span>
               <span style='color: gray;'>(${pct.toFixed(2)}%)</span>
               ${prizeDisplay}`;
          } else {
            elem.innerHTML =
              `${countValue.toLocaleString('de-DE')}
               <span style='color: gray;'>(${pct.toFixed(2)}%)</span>
               ${prizeDisplay}`;
          }
        }
      }
    }

    function updateChanceDisplay() {
      const mode = document.getElementById("modeSelect").value;
      let numCount, starCount;
      if (mode === "flash") {
        numCount = parseInt(document.getElementById("ticketNumbersCount").value) || 5;
        starCount = parseInt(document.getElementById("ticketStarsCount").value) || 2;
      } else {
        const customGridsText = document.getElementById("customGrids").value;
        const grids = parseCustomGrids(customGridsText);
        if (grids.length > 0) {
          numCount = grids[0].numbers.length;
          starCount = grids[0].stars.length;
        } else {
          numCount = 5;
          starCount = 2;
        }
      }
      numCount = Math.max(5, Math.min(49, numCount));
      starCount = Math.max(1, Math.min(10, starCount));
      const numTickets = mode === "flash" ? (parseInt(document.getElementById("numTickets").value) || 1) : 1;
      const stopNumbers = parseInt(document.getElementById("stopNumbers").value) ?? 5;
      const stopStars = parseInt(document.getElementById("stopStars").value) ?? 1;

      function computeChance(numCount, starCount, stopNumbers, stopStars) {
        let probNum = 0;
        for (let k = stopNumbers; k <= Math.min(numCount, 5); k++) {
          probNum += combination(numCount, k) * combination(49 - numCount, 5 - k) / combination(49, 5);
        }
        let probStars = 0;
        for (let l = stopStars; l <= Math.min(starCount, 1); l++) {
          probStars += combination(starCount, l) * combination(10 - starCount, 1 - l) / combination(10, 1);
        }
        return probNum * probStars;
      }

      const pTicket = computeChance(numCount, starCount, stopNumbers, stopStars);
      const pGlobal = 1 - Math.pow(1 - pTicket, numTickets);
      const percent = (pGlobal * 100).toFixed(8);
      const reciprocalFormatted = pGlobal > 0
        ? (1 / pGlobal).toLocaleString('de-DE', { maximumFractionDigits: 0 })
        : "∞";

	const POSSIBILITIES = 4_200_000;
	let totalSimpleGrids = 0;

	if (mode === "flash") {
	  const gridsPerTicket   = simpleGrids(numCount, starCount);
	  totalSimpleGrids       = gridsPerTicket * numTickets;
	} else { 
	  const customGridsText  = document.getElementById("customGrids").value;
	  const grids            = parseCustomGrids(customGridsText);
	  grids.forEach(g => {
		totalSimpleGrids += simpleGrids(g.numbers.length, g.stars.length);
	  });
	}

	const pCodeLoto  = 1 - Math.pow(1 - 10 / POSSIBILITIES, totalSimpleGrids);
	const pctCode    = (pCodeLoto * 100).toFixed(8);
	const invCode    = pCodeLoto > 0
	  ? (1 / pCodeLoto).toLocaleString('de-DE', { maximumFractionDigits: 0 })
	  : "∞";

	let lignes = [
	  `Taux de chance (pour au moins ${stopNumbers} n° et ${stopStars} ◉) : ${percent}%`,
	  `1 chance sur ${reciprocalFormatted}`
	];

	if (document.getElementById("myMillonCheckbox").checked) {
lignes.push(
  `1 chance sur ${invCode} (Code&nbsp;Loto)
   <span class="info-icon"
         title="Estimation approximative : 
Varie selon le nombre réel de grilles jouées à chaque tirage.">i</span>`
);

	}

	document.getElementById("chanceDisplay").innerHTML = lignes.join("<br>");


    }
	
	function simpleGrids(n, s) {
	  return combination(n, 5) * combination(s, 1);
	}

    function formatTimeInDays(totalDays) {
      const joursTotal = Math.floor(totalDays);
      let centuries = Math.floor(joursTotal / 36500);
      let reste = joursTotal % 36500;
      let years = Math.floor(reste / 365);
      reste = reste % 365;
      let months = Math.floor(reste / 30.4375);
      reste = Math.floor(reste % 30.4375);
      let weeks = Math.floor(reste / 7);
      let days = reste % 7;
      const parts = [];
      if (centuries > 0) parts.push(centuries + " " + (centuries === 1 ? "siècle" : "siècles"));
      if (years > 0) parts.push(years + " " + (years === 1 ? "an" : "ans"));
      if (months > 0) parts.push(months + " mois");
      if (weeks > 0) parts.push(weeks + " " + (weeks === 1 ? "semaine" : "semaines"));
      if (days > 0) parts.push(days + " " + (days === 1 ? "jour" : "jours"));
      return parts.length === 0 ? "0 jour" : parts.join(", ");
    }

    function updateTimePassed(drawCount) {
      const days = drawCount * (7 / 3);
      const formatted = formatTimeInDays(days);
      document.getElementById("timePassed").textContent = "Temps écoulé : " + formatted;
    }

    function updateGainDisplay() {
      const formatted = balance.toLocaleString('de-DE', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
      const gainElem = document.getElementById("gainDisplay");
      let imageContainer = document.getElementById("looseImageContainer");
      if (!imageContainer) {
        imageContainer = document.createElement("span");
        imageContainer.id = "looseImageContainer";
      }
      if (balance >= 0) {
        gainElem.innerHTML = `Gain net : <span style='color: green;'>${formatted} €</span>`;
      } else {
        gainElem.innerHTML = `Gain net : <span style='color: red;'>${formatted} €</span>`;
      }
      gainElem.appendChild(imageContainer);
	  updateGainChart(); 
    }

    document.querySelectorAll("#ticketNumbersCount, #ticketStarsCount, #numTickets, #stopNumbers, #stopStars, #customGrids, #stopAfterYearsInput, #stopAfterYearsCheckbox")
      .forEach(input => {
        input.addEventListener("input", updateChanceDisplay);
      });
    updateChanceDisplay();
    document.getElementById("stopBtn").style.display = "none";

    document.getElementById("multichanceCheckbox").addEventListener("change", function() {
      const partsContainer = document.getElementById("multichancePartsContainer");
      partsContainer.style.display = this.checked ? "block" : "none";
    });

    document.getElementById("myMillonCheckbox").addEventListener("change", function() {
      document.getElementById("stopMyMillonWinGroup").style.display = this.checked ? "block" : "none";
      updateStatsDisplay();
	  updateChanceDisplay();
    });
	
	document.getElementById("smartDrawCheckbox").addEventListener("change", function () {
		const block = document.getElementById("smartDrawSettings");
		block.style.display = this.checked ? "block" : "none";
	});


	document.getElementById("modeSelect").addEventListener("change", function() {
	  const mode       = this.value;
	  const flash      = document.getElementById("flashSettings");
	  const custom     = document.getElementById("customSettings");
	  const ticketsGrp = document.getElementById("ticketsCountGroup");
	  const multiGrp   = document.getElementById("multichanceCheckbox").parentNode;
	  const multiParts = document.getElementById("multichancePartsContainer");
	  const smartChk   = document.getElementById("smartDrawCheckbox").parentNode;
	  const smartSet   = document.getElementById("smartDrawSettings");

	  if (mode === "flash") {
		flash.style.display      = "block";
		custom.style.display     = "none";
		ticketsGrp.style.display = "block";
		multiGrp.style.display   = "block";
		multiParts.style.display = document.getElementById("multichanceCheckbox").checked
									 ? "block" : "none";
		smartChk.style.display   = "block";
		smartSet.style.display   = document.getElementById("smartDrawCheckbox").checked
									 ? "block" : "none";
	  } else {
		flash.style.display      = "none";
		custom.style.display     = "block";
		ticketsGrp.style.display = "none";
		multiGrp.style.display   = "none";
		multiParts.style.display = "none";
		smartChk.style.display   = "none";
		smartSet.style.display   = "none";
	  }
	  updateChanceDisplay();
	});

    const speedSlider = document.getElementById("speedSlider");
    const speedValueLabel = document.getElementById("speedValueLabel");

    function updateSpeedFromSlider(value) {
      const sliderVal = parseInt(value, 10);
      if (sliderVal <= 50) {
        currentBatchSize = 1;
        currentSpeed = Math.round(1000 - (sliderVal - 1) * (999 / 49));
      } else if (sliderVal <= 70) {
        let ratio = (sliderVal - 50) / 20;
        currentBatchSize = Math.round(1 + ratio * (200 - 1));
        currentSpeed = 1;
      } else {
        let ratio = (sliderVal - 70) / 30;
        currentBatchSize = Math.round(200 + ratio * (2000 - 200));
        currentSpeed = Math.round(1 - ratio * 1);
      }
      speedValueLabel.textContent = `(Tirage = ${currentBatchSize}, Délai = ${currentSpeed} ms)`;
    }

    updateSpeedFromSlider(speedSlider.value);
    speedSlider.addEventListener("input", function() {
      updateSpeedFromSlider(this.value);
    });

    function runLoop() {
      removeLooseImages();
      if (stopFlag) return;
      simulationActive = true;

      const mode = document.getElementById("modeSelect").value;
      let multichanceRatio = 1;
      if (mode === "flash" && document.getElementById("multichanceCheckbox").checked) {
        const totalParts = parseInt(document.getElementById("totalParts").value) || 0;
        const yourParts = parseInt(document.getElementById("yourParts").value) || 0;
        if (yourParts > totalParts) {
          alert("Erreur : Votre nombre de parts ne peut pas dépasser le total de parts (" + totalParts + ").");
          stopFlag = true;
          document.getElementById("startBtn").style.display = "block";
          simulationActive = false;
          return;
        }
        multichanceRatio = yourParts / totalParts;
      }
      let tickets = [];
      let draw = null;
      let customTickets = [];
      if (mode === "custom") {
        const customGridsText = document.getElementById("customGrids").value;
        customTickets = parseCustomGrids(customGridsText);
      }
      const numCount = mode === "flash"
        ? (parseInt(document.getElementById("ticketNumbersCount").value) || 5)
        : (customTickets.length > 0 ? customTickets[0].numbers.length : 5);
      const starCount = mode === "flash"
        ? (parseInt(document.getElementById("ticketStarsCount").value) || 2)
        : (customTickets.length > 0 ? customTickets[0].stars.length : 2);
      const numTickets = mode === "flash"
        ? (parseInt(document.getElementById("numTickets").value) || 1)
        : (customTickets.length > 0 ? customTickets.length : 1);
		let lotRares = null;
	if (document.getElementById("smartDrawCheckbox").checked) {
	  lotRares = buildCommonRareSet(numCount, starCount);
	}

	let simpleGridsPerTicket = 1;
	if (numCount > 5) simpleGridsPerTicket *= combination(numCount, 5);
	if (starCount > 1) simpleGridsPerTicket *= combination(starCount, 1);
      const stopNumbers = parseInt(document.getElementById("stopNumbers").value) || 0;
      const stopStars = parseInt(document.getElementById("stopStars").value) || 0;
      const stopAfterYearsChecked = document.getElementById("stopAfterYearsCheckbox").checked;
      const stopAfterYearsValue = parseInt(document.getElementById("stopAfterYearsInput").value) || 100;
      const batchSize = currentBatchSize;
      const speed = currentSpeed;

      const stopMyMillonWin = document.getElementById("stopMyMillonWinCheckbox").checked;

      for (let i = 0; i < batchSize; i++) {
        count++;
        totalGrillesJouees += numTickets * simpleGridsPerTicket;
        tickets = [];
        for (let j = 0; j < numTickets; j++) {
          if (mode === "flash") {
			if (document.getElementById("smartDrawCheckbox").checked) {
			  tickets.push(generateSmartTicket(numCount, starCount, lotRares));
			} else {
			  tickets.push(generateTicket(numCount, starCount));
			}
          } else {
            if (customTickets.length > 0) {
              tickets.push(customTickets[j % customTickets.length]);
            }
          }
        }
        if (mode === "flash") {
          let costPerTicket = simpleGridsPerTicket * ticketCost;
          if (document.getElementById("multichanceCheckbox").checked) {
            costPerTicket *= multichanceRatio;
          }
          balance -= numTickets * costPerTicket;
        } else {
          tickets.forEach(ticket => {
            balance -= costOfTicket(ticket);
          });
        }
        draw = generateDraw();

        let myMillionJustWon = false;
        if (document.getElementById("myMillonCheckbox").checked) {
		let tirageJour = (count - 1) % 3;
		let possibilities;
		switch (tirageJour) {
		  case 0:
			possibilities = 3000000;
			break;
		  case 1:
			possibilities = 4200000;
			break;
		  case 2:
			possibilities = 6000000;
			break;
		}

          let assignedRanges = [];
          tickets.forEach(ticket => {
            let n = ticket.numbers.length;
            let s = ticket.stars.length;
            let numGrilles = combination(n, 5) * combination(s, 1);
            if (numGrilles > 1) {
              let baseNumber;
              let attempt = 0;
              const maxAttempts = 100;
              do {
                baseNumber = Math.floor(Math.random() * (possibilities - numGrilles + 1)) + 1;
                attempt++;
                var conflict = assignedRanges.some(range =>
                  baseNumber <= range.end && (baseNumber + numGrilles - 1) >= range.start
                );
              } while (conflict && attempt < maxAttempts);
              let rangeEnd = baseNumber + numGrilles - 1;
              assignedRanges.push({ start: baseNumber, end: rangeEnd });
              ticket.myMillon = baseNumber + " à " + rangeEnd;
            } else {
              let candidate;
              let attempt = 0;
              const maxAttempts = 100;
              do {
                candidate = Math.floor(Math.random() * possibilities) + 1;
                attempt++;
                var conflict = assignedRanges.some(range =>
                  candidate >= range.start && candidate <= range.end
                );
              } while (conflict && attempt < maxAttempts);
              assignedRanges.push({ start: candidate, end: candidate });
              ticket.myMillon = candidate;
            }
          });
			draw.myMillon = [];
			while (draw.myMillon.length < 10) {
			  const candidate = Math.floor(Math.random() * possibilities) + 1;
			  if (!draw.myMillon.includes(candidate)) {
				draw.myMillon.push(candidate);
			  }
			}


		let myMillonWin = tickets.some(ticket => {
		  return draw.myMillon.some(code => {
			if (typeof ticket.myMillon === "string" && ticket.myMillon.includes(" à ")) {
			  let [start, end] = ticket.myMillon.split(" à ").map(Number);
			  return code >= start && code <= end;
			} else {
			  return ticket.myMillon === code;
			}
		  });
		});


          if (myMillonWin) {
            myMillionWinCount++;
            let myMillonPrize = 20000;
            if (document.getElementById("multichanceCheckbox").checked) {
              const totalParts = parseInt(document.getElementById("totalParts").value) || 1;
              const yourParts = parseInt(document.getElementById("yourParts").value) || 1;
              myMillonPrize = 20000 * (yourParts / totalParts);
            }
            balance += myMillonPrize;
            myMillionTotalGain += myMillonPrize;
            updateStatsDisplay();

            myMillionJustWon = true;
            if (stopMyMillonWin) {
				alert(
				  "Code Loto gagnée !\n" +
				  "Tirage n° " + count.toLocaleString('de-DE') + "\n" +
				  "Gain : " + myMillonPrize.toLocaleString('de-DE', { maximumFractionDigits: 0 }) + " €"
				);

              if (balance >= 1) {
                playSound("win.mp3");
              } else if (balance <= -1000000) {
                playSound("bigloose.mp3");
                addLooseImage("bigloose.jpeg");
              } else {
                playSound("loose.mp3");
                addLooseImage("loose.png");
              }

              if (gainChart) {
              	gainChart.data.datasets[0].data.push({ x: count, y: balance });
              	gainChart.update();
		lastY = balance;
              }

              stopFlag = true;
              simulationActive = false;
              document.getElementById("startBtn").style.display = "block";
              document.getElementById("ticketsContainer").innerHTML = "";
              tickets.forEach((ticket, index) => {
                const div = document.createElement("div");
			 let isWinning;
			 if (typeof ticket.myMillon === "string" && ticket.myMillon.includes(" à ")) {
			   const [start, end] = ticket.myMillon.split(" à ").map(Number);
			   isWinning = draw.myMillon.some(code => code >= start && code <= end);
			 } else {
			   isWinning = draw.myMillon.includes(ticket.myMillon);
			 }
                div.className = "ticket" + (isWinning ? " winning" : "");
                const highlightedNums = highlightMatches(ticket.numbers, draw.numbers, "number");
                const highlightedStars = highlightMatches(ticket.stars, draw.stars, "star");
                let myMillionDisplay = formatMyMillion(ticket.myMillon);
                if (isWinning) {
                  myMillionDisplay = `<span style="color: green; font-weight: bold;">${formatMyMillion(ticket.myMillon)}</span>`;
                }
                div.innerHTML = `<strong>Ticket ${index + 1} :</strong><br>
                                 Numéros : ${highlightedNums}<br>
                                 Chance : ${highlightedStars}<br>
                                 Code Loto : ${myMillionDisplay}`;
                document.getElementById("ticketsContainer").appendChild(div);
              });
	const isPlain = typeof fancyDisplay !== "undefined" && !fancyDisplay;
	document.getElementById("resultat").innerHTML =
	  `<strong>Tirage :</strong><br>
	   Numéros : ${isPlain ? simpleTextList(draw.numbers) : balls(draw.numbers, "number")}<br>
	   Chance : ${isPlain ? simpleTextList(draw.stars) : balls(draw.stars, "star")}<br>
	   Code Loto : ${formatCodesList(draw.myMillon)}`;
              document.getElementById("counter").textContent = "Tirages : " + count.toLocaleString('de-DE');
              document.getElementById("grillesPlayed").textContent = "Grilles jouées : " + totalGrillesJouees.toLocaleString('de-DE');
              updateTimePassed(count);
              updateStatsDisplay();
              updateGainDisplay();
              return;
            }
          }
        }
		updateGainChart(); 

        if (stopAfterYearsChecked) {
          const currentYears = (count * (7 / 3)) / 365;
          if (currentYears >= stopAfterYearsValue) {
            document.getElementById("ticketsContainer").innerHTML = "";
			const isPlain = typeof fancyDisplay !== "undefined" && !fancyDisplay;
			document.getElementById("resultat").innerHTML =
			  `<strong>Tirage :</strong><br>
			   Numéros : ${isPlain ? simpleTextList(draw.numbers) : balls(draw.numbers, "number")}<br>
			   Chance : ${isPlain ? simpleTextList(draw.stars) : balls(draw.stars, "star")}${document.getElementById("myMillonCheckbox").checked ? "<br>Code Loto : " + formatCodesList(draw.myMillon) : ""}`;

            document.getElementById("counter").textContent = "Tirages : " + count.toLocaleString('de-DE');
            document.getElementById("grillesPlayed").textContent = "Grilles jouées : " + totalGrillesJouees.toLocaleString('de-DE');
            updateTimePassed(count);
            updateStatsDisplay();
            updateGainDisplay();
            alert("On a dépassé les " + stopAfterYearsValue + " ans de simulation !\n(Nombre de tirages : " + count.toLocaleString('de-DE') + ")");

            if (balance >= 1) {
              playSound("win.mp3");
            } else if (balance <= -1000000) {
              playSound("bigloose.mp3");
              addLooseImage("bigloose.jpeg");
            } else {
              playSound("loose.mp3");
              addLooseImage("loose.png");
            }

            stopFlag = true;
            simulationActive = false;
            document.getElementById("startBtn").style.display = "block";
            return;
          }
        }

        let foundWinningTicket = false;
        let winningTicket = null;
        tickets.forEach(ticket => {
          const n = ticket.numbers.length;
          const s = ticket.stars.length;

          const numGood = countMatches(ticket.numbers, draw.numbers);
          const numBad = n - numGood;
          const starGood = countMatches(ticket.stars, draw.stars);
          const starBad = s - starGood;

          for (let nb = 0; nb <= Math.min(5, n); nb++) {
            for (let sb = 0; sb <= Math.min(1, s); sb++) {
              const waysNum = combination(numGood, nb) * combination(numBad, 5 - nb);
              const waysStar = combination(starGood, sb) * combination(starBad, 1 - sb);
              const countGrilles = waysNum * waysStar;
              if (countGrilles > 0) {
                const key = nb + "_" + sb;
                if (stats.hasOwnProperty(key)) stats[key] += countGrilles;
                let prize = prizeMapping[key] || 0;
                if (document.getElementById("multichanceCheckbox").checked) {
                  prize *= multichanceRatio;
                }
                balance += prize * countGrilles;
                statsGain[key] += prize * countGrilles;

                if (!foundWinningTicket && nb >= stopNumbers && sb >= stopStars && countGrilles > 0) {
                  foundWinningTicket = true;
                  winningTicket = ticket;
                }
              }
            }
          }
        });


        if (foundWinningTicket) {
          document.getElementById("ticketsContainer").innerHTML = "";
		  adjustTicketColumns(tickets);
          tickets.forEach((ticket, index) => {
            const div = document.createElement("div");
            div.className = "ticket";
            const highlightedNums = highlightMatches(ticket.numbers, draw.numbers, "number");
            const highlightedStars = highlightMatches(ticket.stars, draw.stars, "star");
            div.innerHTML = `<strong>Ticket ${index + 1} :</strong><br>
                             Numéros : ${highlightedNums}<br>
                             Chance : ${highlightedStars}${document.getElementById("myMillonCheckbox").checked ? "<br>Code Loto : " + formatMyMillion(ticket.myMillon) : ""}`;
            if (ticket === winningTicket) {
              div.classList.add("winning");
            }
            document.getElementById("ticketsContainer").appendChild(div);
          });
			const isPlain = typeof fancyDisplay !== "undefined" && !fancyDisplay;
			document.getElementById("resultat").innerHTML =
			  `<strong>Tirage :</strong><br>
			   Numéros : ${isPlain ? simpleTextList(draw.numbers) : balls(draw.numbers, "number")}<br>
			   Chance : ${isPlain ? simpleTextList(draw.stars) : balls(draw.stars, "star")}${document.getElementById("myMillonCheckbox").checked ? "<br>Code Loto : " + formatCodesList(draw.myMillon) : ""}`;

          document.getElementById("counter").textContent = "Tirages : " + count.toLocaleString('de-DE');
          document.getElementById("grillesPlayed").textContent = "Grilles jouées : " + totalGrillesJouees.toLocaleString('de-DE');
          updateTimePassed(count);
          updateStatsDisplay();
          updateGainDisplay();

          const winningMatchNumbers = countMatches(winningTicket.numbers, draw.numbers);
          const winningMatchStars = countMatches(winningTicket.stars, draw.stars);
          const winningKey = winningMatchNumbers + "_" + winningMatchStars;
          let winningGain = prizeMapping[winningKey] || 0;
          if (document.getElementById("multichanceCheckbox").checked) {
            winningGain *= multichanceRatio;
          }
          if (winningMatchNumbers === 5 && winningMatchStars === 1) {
            launchFireworks();
          }
          alert("Seuil atteint !\n" +
                "Ticket gagnant : " + winningTicket.numbers.join(", ") + " | " + winningTicket.stars.join(", ") + "\n" +
                "Tirage : " + draw.numbers.join(", ") + " | " + draw.stars.join(", ") + "\n" +
                "Nombre de tirages : " + count.toLocaleString('de-DE') + "\n" +
                "Gain : " + winningGain.toLocaleString('de-DE', { maximumFractionDigits: 0 }) + " €");

          if (balance >= 1) {
            playSound("win.mp3");
            } else if (balance <= -1000000) {
              playSound("bigloose.mp3");
              addLooseImage("bigloose.jpeg");
            } else {
              playSound("loose.mp3");
              addLooseImage("loose.png");
            }

          if (gainChart) {
             gainChart.data.datasets[0].data.push({ x: count, y: balance });
             gainChart.update();
	     lastY = balance;
          }

          stopFlag = true;
          simulationActive = false;
          document.getElementById("startBtn").style.display = "block";
          return;
        }

        if (document.getElementById("stopNegativeGainCheckbox").checked) {
          const negThreshold = parseFloat(document.getElementById("stopNegativeGainThreshold").value) || 0;
          if (balance < -negThreshold) {
            document.getElementById("ticketsContainer").innerHTML = "";
			adjustTicketColumns(tickets);
			const isPlain = typeof fancyDisplay !== "undefined" && !fancyDisplay;
			document.getElementById("resultat").innerHTML =
			  `<strong>Tirage :</strong><br>
			   Numéros : ${isPlain ? simpleTextList(draw.numbers) : balls(draw.numbers, "number")}<br>
			   Chance : ${isPlain ? simpleTextList(draw.stars) : balls(draw.stars, "star")}${document.getElementById("myMillonCheckbox").checked ? "<br>Code Loto : " + formatCodesList(draw.myMillon) : ""}`;

            document.getElementById("counter").textContent = "Tirages : " + count.toLocaleString('de-DE');
            document.getElementById("grillesPlayed").textContent = "Grilles jouées : " + totalGrillesJouees.toLocaleString('de-DE');
            updateTimePassed(count);
            updateStatsDisplay();
            updateGainDisplay();
            alert("Le gain net est inférieur au seuil défini (-" + negThreshold + " €). La simulation est arrêtée.");

            if (balance >= 1) {
              playSound("win.mp3");
            } else if (balance <= -1000000) {
              playSound("bigloose.mp3");
              addLooseImage("bigloose.jpeg");
            } else {
              playSound("loose.mp3");
              addLooseImage("loose.png");
            }

            stopFlag = true;
            simulationActive = false;
            document.getElementById("startBtn").style.display = "block";
            return;
          }
        }
      }

      document.getElementById("ticketsContainer").innerHTML = "";
	  adjustTicketColumns(tickets);
      tickets.forEach((ticket, index) => {
        const div = document.createElement("div");
        div.className = "ticket";
        const highlightedNums = highlightMatches(ticket.numbers, draw.numbers, "number");
        const highlightedStars = highlightMatches(ticket.stars, draw.stars, "star");
        div.innerHTML = `<strong>Ticket ${index + 1} :</strong><br>
                         Numéros : ${highlightedNums}<br>
                         Chance : ${highlightedStars}${document.getElementById("myMillonCheckbox").checked ? "<br>Code Loto : " + formatMyMillion(ticket.myMillon) : ""}`;
        document.getElementById("ticketsContainer").appendChild(div);
      });
	  
	    window._lastTicketsData = {
    tickets: tickets,
    draw: draw,
    myMillion: document.getElementById("myMillonCheckbox").checked
  };
	  
	const isPlain = typeof fancyDisplay !== "undefined" && !fancyDisplay;
	document.getElementById("resultat").innerHTML =
	  `<strong>Tirage :</strong><br>
	   Numéros : ${isPlain ? simpleTextList(draw.numbers) : balls(draw.numbers, "number")}<br>
	   Chance : ${isPlain ? simpleTextList(draw.stars) : balls(draw.stars, "star")}${document.getElementById("myMillonCheckbox").checked ? "<br>Code Loto : " + formatCodesList(draw.myMillon) : ""}`;

      document.getElementById("counter").textContent = "Tirages : " + count.toLocaleString('de-DE');
      document.getElementById("grillesPlayed").textContent = "Grilles jouées : " + totalGrillesJouees.toLocaleString('de-DE');
      updateTimePassed(count);
      updateStatsDisplay();
      updateGainDisplay();

      loopTimeout = setTimeout(runLoop, speed);
    }

    function startDrawing() {
      simulationHasStarted = true;
	  resetGainChart();
	  
      if (document.getElementById("modeSelect").value === "flash" && document.getElementById("multichanceCheckbox").checked) {
        const totalParts = parseInt(document.getElementById("totalParts").value) || 0;
        const yourParts = parseInt(document.getElementById("yourParts").value) || 0;
        if (yourParts > totalParts) {
          alert("Erreur : Votre nombre de parts (" + yourParts + ") ne peut pas dépasser le total de parts (" + totalParts + ").");
          return;
        }
      }
      clearTimeout(loopTimeout);
      count = 0;
      stopFlag = false;
      balance = 0;
      totalGrillesJouees = 0;
      for (let combo in stats) {
        stats[combo] = 0;
        statsGain[combo] = 0;
      }
      myMillionWinCount = 0;
      myMillionTotalGain = 0;
      simulationActive = true;
      document.getElementById("counter").textContent = "Tirages : 0";
      document.getElementById("grillesPlayed").textContent = "Grilles jouées : 0";
      document.getElementById("timePassed").textContent = "Temps écoulé : 0 jour";
      document.getElementById("gainDisplay").innerHTML = "<span style='color: green;'>Gain net : 0,00 €</span>";
      document.getElementById("ticketsContainer").innerHTML = "";
      document.getElementById("resultat").innerHTML = `<strong>Tirage :</strong><br>Numéros : --<br>Chance : --`;
      document.getElementById("stopBtn").textContent = "Stop";
      updateStatsDisplay();
      updateTimePassed(0);
      updateGainDisplay();
      removeLooseImages();
      document.getElementById("startBtn").style.display = "none";
      document.getElementById("stopBtn").style.display = "inline-block";
      runLoop();
    }

    document.getElementById("myMillonCheckbox").checked = true;
    document.getElementById("stopMyMillonWinCheckbox").checked = false;
    document.getElementById("stopMyMillonWinGroup").style.display = "block";

    document.getElementById("startBtn").addEventListener("click", startDrawing);
    document.getElementById("stopBtn").addEventListener("click", function() {
      if (!stopFlag) {
        stopFlag = true;
        simulationActive = false;
        clearTimeout(loopTimeout);
        this.textContent = "Continuer";
      } else {
        stopFlag = false;
        simulationActive = true;
        this.textContent = "Stop";
        runLoop();
      }
      updateStatsDisplay();
    });
    document.getElementById("resetBtn").addEventListener("click", function() {
      stopFlag = true;
      simulationHasStarted = false;
      clearTimeout(loopTimeout);
      count = 0;
      totalGrillesJouees = 0;
      for (let combo in stats) {
        stats[combo] = 0;
        statsGain[combo] = 0;
      }
      myMillionWinCount = 0;
      myMillionTotalGain = 0;
      simulationActive = false;
      updateStatsDisplay();
      document.getElementById("counter").textContent = "Tirages : 0";
      document.getElementById("grillesPlayed").textContent = "Grilles jouées : 0";
      document.getElementById("timePassed").textContent = "Temps écoulé : 0 jour";
      document.getElementById("gainDisplay").innerHTML = "<span style='color: green;'>Gain net : 0,00 €</span>";
      document.getElementById("ticketsContainer").innerHTML = "";
      document.getElementById("resultat").innerHTML = `<strong>Tirage :</strong><br>Numéros : --<br>Chance : --`;
      document.getElementById("stopBtn").textContent = "Stop";
      document.getElementById("startBtn").style.display = "block";
      document.getElementById("stopBtn").style.display = "none";
      removeLooseImages();
	  resetGainChart();
    });

    updateStatsDisplay();

    document.getElementById("ticketStarsCount").addEventListener("blur", function() {
      let v = parseInt(this.value) || 1;
      if (v < 1) v = 1;
      if (v > 10) v = 10;
      this.value = v;
    });
    document.getElementById("ticketNumbersCount").addEventListener("blur", function() {
      let v = parseInt(this.value) || 5;
      if (v < 5) v = 5;
      if (v > 49) v = 49;
      this.value = v;
    });
  </script>
</body>
</html>
