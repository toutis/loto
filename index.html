<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Simulation Euro Millions</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    .main-container {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      flex-wrap: wrap;
      gap: 10px;
    }
    .left-column {
      flex: 1;
      max-width: 45%;
      text-align: left;
    }
    .right-column {
      flex: 1;
      max-width: 45%;
      text-align: left;
    }
    .form-group,
    .display,
    .compteur {
      font-size: 1.1em;
      margin: 10px 0;
    }
    input,
    button,
    select,
    textarea {
      padding: 6px 12px;
      font-size: 1em;
      margin: 5px;
    }
    .ticket {
      border: 1px solid #aaa;
      padding: 8px;
      margin: 5px 0;
      width: fit-content;
    }
    .winning {
      background-color: #cfc;
    }
    #chanceDisplay {
      font-weight: bold;
      margin: 10px 0;
    }
    #resultat {
      border: 2px solid gold;
      padding: 10px;
      margin: 10px 0;
    }
    #statsContainer {
      margin-top: 20px;
    }
    #statsContainer ul {
      list-style: none;
      padding: 0;
    }
    #statsContainer li {
      margin: 5px 0;
    }
    #multichanceAndMyMillonContainer {
      display: flex;
      align-items: center;
    }
    .info-icon {
      display: inline-block;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background-color: #ccc;
      text-align: center;
      line-height: 16px;
      font-size: 12px;
      margin-left: 5px;
      cursor: help;
    }
    #speedControlGroup {
      display: flex;
      align-items: center;
      justify-content: flex-start;
      gap: 10px;
      margin: 10px 0;
    }
    #speedValueLabel {
      color: gray;
    }
    #fireworksContainer {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 9999;
    }
    .firework {
      position: absolute;
      width: 4px;
      height: 4px;
      background: radial-gradient(circle, var(--color) 0%, var(--color-dark) 70%);
      border-radius: 50%;
      opacity: 1;
      animation: firework 2.0s ease-out forwards;
      box-shadow: 0 0 15px var(--color);
    }
    @keyframes firework {
      0% { transform: scale(1); opacity: 1; }
      50% { opacity: 1; }
      100% { transform: translate(var(--tx), var(--ty)) scale(3); opacity: 0; }
    }
	.sound-toggle {
	  cursor: pointer;
	  margin-left: 0px;
	  font-size: 24px;
	  vertical-align: middle;
	}
    .sound-toggle span {
      display: inline-block;
    }
	.icons-bar {
	  display: inline-flex;
	  align-items: center;
	  gap: 4px; /* Ajuste la distance ici */
	}
    #stopMyMillonWinGroup {
      margin-left: 22px;
      margin-top: 0;
      font-size: 0.95em;
      display: none;
    }
    /* Boules bleues pour num√©ros */
    .number-ball, .star-ball {
      display: inline-flex;
      justify-content: center;
      align-items: center;
      width: 30px;
      height: 30px;
      margin: 2px 0px; 
      font-size: .85em;
      font-weight: bold;
      color: #fff;
      position: relative;
      vertical-align: middle;
      user-select: none;
    }
    .number-ball {
      background: #187ad2;
      border-radius: 50%;
    }
    /* √âtoile jaune, vrai trac√© d‚Äô√©toile */
	.star-ball {
	  display: inline-flex;
	  justify-content: center;
	  align-items: center;
	  /* m√™mes dimensions que .number-ball si tu veux */
	  width: 36px;
	  height: 36px;
	  /* supprime tout font-size custom, ou remets font-size identique √† .number-ball */
	  font-size: .85em !important;  
	  font-family: Arial, sans-serif !important;
	  font-weight: bold !important;   
	  position: relative; 
	  z-index: 1; 
	}
	.star-ball::before {
	  content: "";
	  position: absolute;
	  left: 0; top: 0; right: 0; bottom: 0;
	  background: #f5c518;
	  z-index: -1;
	  clip-path: polygon(
		50% 5%, 62% 34%, 98% 36%, 69% 57%,
		79% 92%, 50% 74%, 21% 92%, 31% 57%,
		2% 36%, 38% 34%
	  );
	}
	.match {
	  opacity: 1 !important;
	}
	/* Semi-transparence pour les num√©ros/√©toiles non gagnants */
	.semi {
	  opacity: 0.45;
	}
	/* --- conteneur normal (1 ticket par ligne) -------------------- */
	#ticketsContainer{
	  /* layout par d√©faut : un ticket = une ligne, largeur auto  */
	}

	#ticketsContainer .ticket{
	  display: inline-block;   /* largeur = contenu */
	  margin: 6px 0;           /* petit espace vertical */
	  box-sizing: border-box;  /* on garde la bordure dans la largeur calcul√©e */
	}

	/* --- 2 colonnes quand la classe .cols-2 est pr√©sente ---------- */
	#ticketsContainer.cols-2{
	  display: grid;
	  grid-template-columns: repeat(2, minmax(320px, 1fr));
	  gap: 12px;
	}

	#ticketsContainer.cols-2 .ticket{
	  /* dans la grille on veut remplir toute la cellule */
	  display: block;
	  width: 100%;
	  margin: 0;               /* c‚Äôest le gap qui g√®re l‚Äôespace */
	}

	/* ---------- bouton de bascule ---------- */
	.display-toggle {
	  cursor: pointer;
	  margin-left: 0px; 
	  font-size: 24px;
	  user-select: none;
	  vertical-align: middle;
	}

	/* ---------- mode ‚Äútexte‚Äù ---------- */
	body.plain-display .number-ball,
	body.plain-display .star-ball {
	  background: none !important;
	  color: #111 !important;             /* Num√©ros/√©toiles en noir */
	  font-family: inherit !important;    /* M√™me police que My Million et le texte ticket */
	  font-size: inherit !important;      /* M√™me taille */
	  font-weight: normal !important;
	  letter-spacing: 0 !important;
	  border-radius: 0 !important;
	  box-shadow: none !important;
	  width: auto !important;
	  height: auto !important;
	  padding: 0 2px !important;
	  margin: 0 2px !important;
	  opacity: 1 !important;              /* Toujours bien visibles */
	  vertical-align: baseline !important;
	}

	body.plain-display .number-ball.semi,
	body.plain-display .star-ball.semi {
	  color: #111 !important;             /* Num√©ros/√©toiles NON gagnants en noir */
	  opacity: 1 !important;
	}

	body.plain-display .number-ball.match,
	body.plain-display .star-ball.match {
	  color: #159f13 !important;         /* Vert vif pour les bons num√©ros/√©toiles */
	  font-weight: bold !important;      /* Gras */
	  opacity: 1 !important;
	}

	body.plain-display .star-ball::before {
	  display: none !important;           /* Supprime le fond √©toile graphique */
	}
	
	body.plain-display .number-ball,
	body.plain-display .star-ball {
	  font-family: inherit !important;
	  font-size: inherit !important;
	  /* ... (ton reste de style) ... */
	  /* ANTI-ESPACE ENTRE <span> */
	  margin-right: 0 !important;
	  word-spacing: 0 !important;
	}
	
		body.plain-display .number-ball,
	body.plain-display .star-ball {
	  display: inline-block !important;
	}

	body.plain-display .number-ball,
	body.plain-display .star-ball {
	  /* On annule l'espace entre balises en mode texte */
	  letter-spacing: 0 !important;
	}

	body.plain-display .ticket span {
	  /* Emp√™che l'espace inter-balises dans .ticket */
	  font-family: inherit !important;
	  font-size: inherit !important;
	}

	body.plain-display .ticket {
	  /* Emp√™che la coupure/espacement automatique */
	  font-family: inherit;
	  font-size: inherit;
	  word-spacing: 0 !important;
	}
	
	body.plain-display .number-ball.match,
	body.plain-display .star-ball.match,
	body.plain-display .match {
	  color: #159f13 !important;   /* Vert vif */
	  font-weight: bold !important;
	  opacity: 1 !important;
	}
	
  </style>
</head>
<body>
  <div class="main-container">
    <div class="left-column">
	<h1>
	  Simulation Euro Millions
	    <span class="icons-bar">
	  <span id="soundToggle" class="sound-toggle">
		  <span id="soundOnIcon" style="display:none;">&#128266;</span>
		  <span id="soundOffIcon" style="display:inline-block;">&#128263;</span>
	  </span>

	  <!-- BOUTON D‚ÄôAFFICHAGE -->
	  <span id="displayToggle" class="display-toggle"
			title="Basculer l‚Äôaffichage des boules / affichage texte">
		  <span id="displayFancyIcon" style="display:inline-block;">üî§</span>
		  <span id="displayPlainIcon" style="display:none;">üé±</span>
	  </span>
	  </span>
	</h1>

      <div class="section">
        <div class="form-group">
          <label for="modeSelect">Mode :</label>
          <select id="modeSelect">
            <option value="flash" selected>Flash (tickets al√©atoires)</option>
            <option value="custom">Personnalis√© (d√©finir mes propres grilles)</option>
          </select>
        </div>
        <div class="form-group" id="flashSettings">
          <label for="ticketNumbersCount">Nombre de num√©ros (min 5, max 50) :</label>
          <input type="number" id="ticketNumbersCount" value="5" min="5" max="50"><br>
          <label for="ticketStarsCount">Nombre d'√©toiles (min 2, max 12) :</label>
          <input type="number" id="ticketStarsCount" value="2" min="2" max="12">
        </div>
        <div class="form-group" id="customSettings" style="display:none;">
          <label for="customGrids">
            Mes grilles personnalis√©es :<br>
            Entrez une grille par ligne au format "num1,num2,... ; star1,star2,..."<br>
            Exemple: <em>3,15,22,37,42 ; 1,9</em>
          </label>
          <br>
          <textarea id="customGrids" rows="4" cols="50" placeholder="Une grille par ligne"></textarea>
        </div>
        <div class="form-group" id="ticketsCountGroup">
          <label for="numTickets">Nombre de tickets par tirage :</label>
          <input type="number" id="numTickets" value="1" min="1">
        </div>
        <div class="form-group">
          <label for="stopNumbers">Stopper si au moins X num√©ros corrects :</label>
          <input type="number" id="stopNumbers" value="5" min="0" max="5">
        </div>
        <div class="form-group">
          <label for="stopStars">Stopper si au moins Y √©toiles correctes :</label>
          <input type="number" id="stopStars" value="2" min="0" max="2">
        </div>
        <div class="form-group">
          <input type="checkbox" id="stopNegativeGainCheckbox">
          <label for="stopNegativeGainCheckbox">Stopper si le gain net est n√©gatif √† :</label>
          <input type="number" id="stopNegativeGainThreshold" value="10000" step="0.01" style="width:100px;">
        </div>
        <div class="form-group">
          <input type="checkbox" id="stopAfterYearsCheckbox">
          <label for="stopAfterYearsCheckbox">Stopper si on d√©passe X ann√©es :</label>
          <input type="number" id="stopAfterYearsInput" value="50" min="1" style="width:80px;">
        </div>
        <div class="form-group" id="speedControlGroup">
          <label for="speedSlider">Vitesse :</label>
          <input type="range" id="speedSlider" min="1" max="100" value="50" list="tickmarks">
          <datalist id="tickmarks">
            <option value="50" label="50%"></option>
          </datalist>
          <span id="speedValueLabel">(Tirage = 1, D√©lai = 1000 ms)</span>
        </div>
        <div class="form-group" id="multichanceAndMyMillonContainer">
          <div id="myMillonGroup" style="display: inline-block; margin-right: 20px;">
            <input type="checkbox" id="myMillonCheckbox" checked>
            <label for="myMillonCheckbox">
              My Millon
              <span class="info-icon"
                    title="L'option My Millon : Chaque mardi en France, environ 4 millions de grilles sont jou√©es, et 8 millions le vendredi.
√Ä chaque tirage, un num√©ro al√©atoire est attribu√© parmi l'ensemble des grilles jou√©es.
Le gagnant dont le num√©ro correspond exactement √† celui du tirage remporte 1 000 000 ‚Ç¨ !"
                    onclick="event.stopPropagation(); event.preventDefault();"
                    onmousedown="event.stopPropagation(); event.preventDefault();">
                i
              </span>
            </label>
          </div>
          <div id="multichanceGroup" style="display: inline-block;">
            <input type="checkbox" id="multichanceCheckbox">
            <label for="multichanceCheckbox">
              Multichance
              <span class="info-icon"
                    title="L'option Multichance : Il permet de r√©duire votre mise en r√©partissant votre investissement sur plusieurs parts.
Cela diminue le co√ªt par ticket, mais r√©duit √©galement les gains proportionnellement au nombre de parts d√©tenues.
Cette option est utilis√©e seulement avec une dizaine de grilles multiples.
Exemple : 10 grilles multiples (7 num√©ros, 4 √©toiles), 1 √† 10 parts sur 420"
                    onclick="event.stopPropagation(); event.preventDefault();"
                    onmousedown="event.stopPropagation(); event.preventDefault();">
                i
              </span>
            </label>
          </div>
        </div>
        <div class="form-group" id="stopMyMillonWinGroup" style="display:none;">
          <input type="checkbox" id="stopMyMillonWinCheckbox">
          <label for="stopMyMillonWinCheckbox">Stopper si on gagne le my million</label>
        </div>
        <div class="form-group" id="multichancePartsContainer" style="display:none; margin-left:20px;">
          <label for="totalParts">Total de parts :</label>
          <input type="number" id="totalParts" value="420" min="1"><br>
          <label for="yourParts">Votre nombre de parts :</label>
          <input type="number" id="yourParts" value="1" min="1">
        </div>
        <div style="display: inline-flex; gap: 10px;">
          <button id="startBtn">D√©marrer la simulation</button>
          <button id="stopBtn">Stop</button>
          <button id="resetBtn">Reset</button>
        </div>
      </div>
    </div>
    <div class="right-column">
      <div id="chanceDisplay"></div>
      <div class="section display" id="resultat">
        <strong>Tirage :</strong><br>
        Num√©ros : --<br>
        √âtoiles : --<br>
      </div>
      <div class="compteur" id="counter">Tirages : 0</div>
      <div class="compteur" id="timePassed">Temps √©coul√© : 0 jour</div>
      <div class="compteur" id="grillesPlayed">Grilles jou√©es : 0</div>
      <div class="compteur" id="gainDisplay">Gain net : 0 ‚Ç¨</div>
      <div class="section display" id="ticketsContainer"></div>
      <div class="section display" id="statsContainer">
        <h3>Statistiques de r√©sultats</h3>
        <ul>
          <li id="stats_myMillion" style="display: list-item;">
            My Million : <span id="stats_myMillion_value">0</span>
            <span id="stats_myMillion_pct"></span>
            <span id="stats_myMillion_gain"></span>
          </li>
          <li>5 n¬∞ + 2 ‚òÖ : <span id="stats_5_2">0</span></li>
          <li>5 n¬∞ + 1 ‚òÖ : <span id="stats_5_1">0</span></li>
          <li>5 n¬∞ + 0 ‚òÖ : <span id="stats_5_0">0</span></li>
          <li>4 n¬∞ + 2 ‚òÖ : <span id="stats_4_2">0</span></li>
          <li>4 n¬∞ + 1 ‚òÖ : <span id="stats_4_1">0</span></li>
          <li>4 n¬∞ + 0 ‚òÖ : <span id="stats_4_0">0</span></li>
          <li>3 n¬∞ + 2 ‚òÖ : <span id="stats_3_2">0</span></li>
          <li>3 n¬∞ + 1 ‚òÖ : <span id="stats_3_1">0</span></li>
          <li>3 n¬∞ + 0 ‚òÖ : <span id="stats_3_0">0</span></li>
          <li>2 n¬∞ + 2 ‚òÖ : <span id="stats_2_2">0</span></li>
          <li>2 n¬∞ + 1 ‚òÖ : <span id="stats_2_1">0</span></li>
          <li>2 n¬∞ + 0 ‚òÖ : <span id="stats_2_0">0</span></li>
          <li>1 n¬∞ + 2 ‚òÖ : <span id="stats_1_2">0</span></li>
          <li>1 n¬∞ + 1 ‚òÖ : <span id="stats_1_1">0</span></li>
          <li>1 n¬∞ + 0 ‚òÖ : <span id="stats_1_0">0</span></li>
          <li>0 n¬∞ + 2 ‚òÖ : <span id="stats_0_2">0</span></li>
          <li>0 n¬∞ + 1 ‚òÖ : <span id="stats_0_1">0</span></li>
          <li>0 n¬∞ + 0 ‚òÖ : <span id="stats_0_0">0</span></li>
        </ul>
      </div>
    </div>
  </div>
  <div id="fireworksContainer"></div>
  <script>
	
	/* ------------ My Million : conversion index ‚Üí code ‚ÄúAA XXX XXXX‚Äù ------------ */
	function indexToMyMillionCode(n) {
	  const zeroBased   = n - 1;               
	  const BLOCK_SIZE  = 20000;             
	  const blockNumber = Math.floor(zeroBased / BLOCK_SIZE);      

	  const scramble    = (blockNumber * 7919 + 104729) % 676;     
	  const firstLetter = String.fromCharCode(65 + Math.floor(scramble / 26));
	  const secondLetter= String.fromCharCode(65 + (scramble % 26));

	  const digits      = String(zeroBased).padStart(7, "0"); // ‚Üê modifi√© ici

	  return `${firstLetter}${secondLetter} ${digits.slice(0,3)} ${digits.slice(3)}`;
	}



	/* Accepte soit un nombre, soit une cha√Æne ‚Äústart √† end‚Äù ‚Äì‚Äì> formate joliment */
	function formatMyMillion(val) {
	  if (typeof val === "number")              return indexToMyMillionCode(val);
	  if (typeof val === "string" && val.includes(" √† ")) {
		const [start, end] = val.split(" √† ").map(Number);
		return `${indexToMyMillionCode(start)} √† ${indexToMyMillionCode(end)}`;
	  }
	  return val;
	}

	let fancyDisplay = true;   // true = boules/√©toiles graphiques
	function toggleDisplayStyle() {
	  fancyDisplay = !fancyDisplay;

	  // On change l‚Äôic√¥ne
	  document.getElementById('displayFancyIcon').style.display  = fancyDisplay ? 'inline-block' : 'none';
	  document.getElementById('displayPlainIcon').style.display  = fancyDisplay ? 'none' : 'inline-block';

	  // On applique ou retire la classe sur <body>
	  document.body.classList.toggle('plain-display', !fancyDisplay);
	  
	  refreshTicketsDisplay();
	}

	document.getElementById('displayToggle').addEventListener('click', toggleDisplayStyle);

	function simpleTextList(arr) {
	  return arr.join(', ');
	}
	  
	function adjustTicketColumns(tickets){
	  const container = document.getElementById('ticketsContainer');
	  const bigTicket = tickets.some(t =>
		t.numbers.length > 15 || t.stars.length > 10
	  );
	  const twoCols   = tickets.length > 1 && !bigTicket;
	  container.classList.toggle('cols-2', twoCols);
	}
  
    // --- Nouveau : gestion du son ---
    let soundEnabled = false; // D√©sactiv√© par d√©faut
    function toggleSound() {
      soundEnabled = !soundEnabled;
      document.getElementById('soundOnIcon').style.display = soundEnabled ? 'inline-block' : 'none';
      document.getElementById('soundOffIcon').style.display = soundEnabled ? 'none' : 'inline-block';
    }
    document.getElementById('soundToggle').addEventListener('click', toggleSound);

    function playSound(soundFile) {
      if (!soundEnabled) return;
      new Audio(soundFile).play();
    }
    // --- FIN gestion du son ---

    // --- VARIABLES GLOBALES ---
    let stats = {
      "5_2": 0, "5_1": 0, "5_0": 0,
      "4_2": 0, "4_1": 0, "4_0": 0,
      "3_2": 0, "3_1": 0, "3_0": 0,
      "2_2": 0, "2_1": 0, "2_0": 0,
      "1_2": 0, "1_1": 0, "1_0": 0,
      "0_2": 0, "0_1": 0, "0_0": 0
    };

    let myMillionWinCount = 0;
    let myMillionTotalGain = 0;

    let statsGain = {
      "5_2": 0, "5_1": 0, "5_0": 0,
      "4_2": 0, "4_1": 0, "4_0": 0,
      "3_2": 0, "3_1": 0, "3_0": 0,
      "2_2": 0, "2_1": 0, "2_0": 0,
      "1_2": 0, "1_1": 0, "1_0": 0,
      "0_2": 0, "0_1": 0, "0_0": 0
    };

    let count = 0;
    let stopFlag = false;
    let loopTimeout;
    let balance = 0;
    const ticketCost = 2.5;
    let totalGrillesJouees = 0;

    let simulationActive = false; // Indique si la simulation est en cours
    let simulationHasStarted = false;

    const prizeMapping = {
      "5_2": 45000000,
      "5_1": 400000,
      "5_0": 50000,
      "4_2": 1500,
      "4_1": 150,
      "4_0": 55,
      "3_2": 75,
      "3_1": 14,
      "3_0": 11,
      "2_2": 15,
      "2_1": 8,
      "2_0": 4,
      "1_2": 7,
      "1_1": 0,
      "1_0": 0,
      "0_2": 0,
      "0_1": 0,
      "0_0": 0
    };

    const speedPresets = [
      { batchSize: 1,     speed: 1000 },
      { batchSize: 10,    speed: 500 },
      { batchSize: 100,   speed: 100 },
      { batchSize: 500,   speed: 50 },
      { batchSize: 1000,  speed: 10 },
      { batchSize: 2000,  speed: 5 },
      { batchSize: 5000,  speed: 2 },
      { batchSize: 10000, speed: 1 },
      { batchSize: 50000, speed: 0 },
      { batchSize: 100000,speed: 0 },
    ];

    let currentBatchSize = speedPresets[4].batchSize;
    let currentSpeed = speedPresets[4].speed;

    function combination(n, r) {
      if (r > n) return 0;
      let num = 1, den = 1;
      for (let i = 0; i < r; i++) {
        num *= (n - i);
        den *= (i + 1);
      }
      return num / den;
    }

    function costOfTicket(ticket) {
      const n = ticket.numbers.length;
      const s = ticket.stars.length;
      return combination(n, 5) * combination(s, 2) * ticketCost;
    }

    function generateNumbers(count, max) {
      let numbers = [];
      while (numbers.length < count) {
        const num = Math.floor(Math.random() * max) + 1;
        if (!numbers.includes(num)) {
          numbers.push(num);
        }
      }
      return numbers.sort((a, b) => a - b);
    }

    // Renvoie toutes les combinaisons de k √©l√©ments dans arr
    function getCombinations(arr, k) {
      const results = [];
      function combine(start, combo) {
        if (combo.length === k) {
          results.push(combo.slice());
          return;
        }
        for (let i = start; i < arr.length; i++) {
          combo.push(arr[i]);
          combine(i + 1, combo);
          combo.pop();
        }
      }
      combine(0, []);
      return results;
    }

    function generateTicket(numCount, starCount) {
      // Clamp les valeurs pour garantir les bornes
      numCount = Math.max(5, Math.min(50, numCount));
      starCount = Math.max(2, Math.min(12, starCount));

      const ticketNumbers = generateNumbers(numCount, 50);
      const ticketStars = generateNumbers(starCount, 12);
      return { numbers: ticketNumbers, stars: ticketStars };
    }

    function generateDraw() {
      return { numbers: generateNumbers(5, 50), stars: generateNumbers(2, 12) };
    }

    function countMatches(arr1, arr2) {
      return arr1.filter(x => arr2.includes(x)).length;
    }

    function parseCustomInput(str) {
      return str.split(',')
                .map(s => parseInt(s.trim()))
                .filter(n => !isNaN(n));
    }

    function parseCustomGrids(str) {
      const lines = str.split('\n').filter(line => line.trim() !== '');
      const tickets = [];
      lines.forEach(line => {
        const parts = line.split(';');
        if (parts.length === 2) {
          const numbers = parseCustomInput(parts[0]);
          const stars = parseCustomInput(parts[1]);
          if (numbers.length > 0 && stars.length > 0) {
            tickets.push({ numbers: numbers.sort((a, b) => a - b), stars: stars.sort((a, b) => a - b) });
          }
        }
      });
      return tickets;
    }

    // --- Affichage boules/√©toiles avec mise en √©vidence ---
    function ballHTML(value, type){
      const cls = type === "star" ? "star-ball" : "number-ball";
      return `<span class="${cls}">${value}</span>`;
    }
	
	function refreshTicketsDisplay() {
	  // Si aucun ticket affich√©, ne rien faire
	  if (!window._lastTicketsData) return;

	  const { tickets, draw, myMillion } = window._lastTicketsData;

	  // Vide le conteneur
	  document.getElementById("ticketsContainer").innerHTML = "";

	  tickets.forEach((ticket, index) => {
		const div = document.createElement("div");
		div.className = "ticket";
		// Mode texte/graphique‚ÄØ: highlightMatches s'occupe du format
		const highlightedNums = highlightMatches(ticket.numbers, draw.numbers, "number");
		const highlightedStars = highlightMatches(ticket.stars, draw.stars, "star");
		div.innerHTML = `<strong>Ticket ${index + 1} :</strong><br>
						 Num√©ros : ${highlightedNums}<br>
						 √âtoiles : ${highlightedStars}${myMillion ? `<br>My Million : ${formatMyMillion(ticket.myMillon)}` : ""}`;
		document.getElementById("ticketsContainer").appendChild(div);
	  });
	}


	function highlightMatches(values, drawValues, type) {
	  const isPlain = typeof fancyDisplay !== "undefined" && !fancyDisplay;

	  if (isPlain) {
		// Mode texte : retourne du vrai texte avec juste <span class="match"> sur les bons num√©ros
		return values.map((v, i) => {
		  const isMatch = drawValues.includes(v);
		  let str = isMatch
			? `<span class="match">${v}</span>`
			: v;
		  if (i < values.length - 1) str += ', ';
		  return str;
		}).join('');
	  } else {
		// Mode graphique (boules), on garde chaque num√©ro/√©toile dans un span
		return values.map(v => {
		  const cls = drawValues.includes(v) ? 'match' : 'semi';
		  const base = ballHTML(v, type);
		  return base.replace('class="', `class="${cls} `);
		}).join(' ');
	  }
	}

    function balls(values, type){
      return values.map(v => ballHTML(v, type)).join(" ");
    }
    // -----------------------------------

    function launchFireworks() {
      const container = document.getElementById('fireworksContainer');
      let count = 0;
      const total = 80;
      const interval = setInterval(() => {
        if (count >= total) {
          clearInterval(interval);
          return;
        }
        const firework = document.createElement('div');
        firework.classList.add('firework');
        const x = Math.random() * window.innerWidth;
        firework.style.left = x + 'px';
        firework.style.top = '0px';
        const tx = (Math.random() - 0.5) * 300;
        const ty = Math.random() * 500;
        firework.style.setProperty('--tx', tx + 'px');
        firework.style.setProperty('--ty', ty + 'px');
        const colors = [
          { light: '#ffcc00', dark: '#ff9900' },
          { light: '#ff3366', dark: '#cc0033' },
          { light: '#66ccff', dark: '#3399ff' },
          { light: '#99ff99', dark: '#33cc33' }
        ];
        const chosen = colors[Math.floor(Math.random() * colors.length)];
        firework.style.setProperty('--color', chosen.light);
        firework.style.setProperty('--color-dark', chosen.dark);
        container.appendChild(firework);
        firework.addEventListener('animationend', () => {
          firework.remove();
        });
        count++;
      }, 25);
    }

    function removeLooseImages() {
      const container = document.querySelector('#looseImageContainer');
      if (container) {
        container.innerHTML = "";
      }
    }

    function addLooseImage(filename) {
      const container = document.querySelector('#looseImageContainer');
      if (!container) return;
      const img = document.createElement('img');
      img.src = filename;
      img.style.width = "1.5em";
      img.style.height = "1.5em";
      img.style.verticalAlign = "middle";
      img.style.marginLeft = "8px";
      container.appendChild(img);
    }

    // --- Affichage de la stat My Million avec % et couleur dynamique ---
    function updateStatsDisplay() {
      let total = 0;
      for (let combo in stats) total += stats[combo];

      // My Million
      const elemMyMillion = document.getElementById("stats_myMillion");
      const valMyMillion = document.getElementById("stats_myMillion_value");
      const pctMyMillion = document.getElementById("stats_myMillion_pct");
      const gainMyMillion = document.getElementById("stats_myMillion_gain");

      if (!document.getElementById("myMillonCheckbox").checked) {
        elemMyMillion.style.display = "none";
      } else {
        elemMyMillion.style.display = "list-item";
        let percent = count > 0 ? (myMillionWinCount / count * 100) : 0;
        // >>> ICI correction <<<
        if (myMillionWinCount === 0 && simulationHasStarted && count > 0) {
          valMyMillion.innerHTML = `<span style='color: red;'>0</span>`;
        } else {
          valMyMillion.innerHTML = myMillionWinCount.toLocaleString('de-DE');
        }
        pctMyMillion.innerHTML =  `<span style='color: gray;'>(${percent.toFixed(2)}%)</span>`;
        if (myMillionTotalGain > 0) {
          gainMyMillion.innerHTML =  `<span style='color: green;'>+${myMillionTotalGain.toLocaleString('de-DE', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
          })}‚Ç¨</span>`;
        } else {
          gainMyMillion.innerHTML = '';
        }
      }

      // Autres stats
      for (let combo in stats) {
        const elem = document.getElementById("stats_" + combo);
        if (elem) {
          const countValue = stats[combo];
          let pct = total > 0 ? (countValue / total * 100) : 0;
          const totalPrize = statsGain[combo];
          const totalPrizeFormatted = totalPrize.toLocaleString('de-DE', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
          });
          const prizeDisplay = totalPrize === 0 ? "" : `<span style='color: green;'>+${totalPrizeFormatted}‚Ç¨</span>`;
          if (countValue === 0) {
            elem.innerHTML =
              `<span style='color: ${simulationHasStarted ? 'red' : 'black'};'>${countValue.toLocaleString('de-DE')}</span>
               <span style='color: gray;'>(${pct.toFixed(2)}%)</span>
               ${prizeDisplay}`;
          } else {
            elem.innerHTML =
              `${countValue.toLocaleString('de-DE')}
               <span style='color: gray;'>(${pct.toFixed(2)}%)</span>
               ${prizeDisplay}`;
          }
        }
      }
    }

    function updateChanceDisplay() {
      const mode = document.getElementById("modeSelect").value;
      let numCount, starCount;
      if (mode === "flash") {
        numCount = parseInt(document.getElementById("ticketNumbersCount").value) || 5;
        starCount = parseInt(document.getElementById("ticketStarsCount").value) || 2;
      } else {
        const customGridsText = document.getElementById("customGrids").value;
        const grids = parseCustomGrids(customGridsText);
        if (grids.length > 0) {
          numCount = grids[0].numbers.length;
          starCount = grids[0].stars.length;
        } else {
          numCount = 5;
          starCount = 2;
        }
      }
      numCount = Math.max(5, Math.min(50, numCount));
      starCount = Math.max(2, Math.min(12, starCount));
      const numTickets = mode === "flash" ? (parseInt(document.getElementById("numTickets").value) || 1) : 1;
      const stopNumbers = parseInt(document.getElementById("stopNumbers").value) ?? 5;
      const stopStars = parseInt(document.getElementById("stopStars").value) ?? 2;

      function computeChance(numCount, starCount, stopNumbers, stopStars) {
        let probNum = 0;
        for (let k = stopNumbers; k <= Math.min(numCount, 5); k++) {
          probNum += combination(numCount, k) * combination(50 - numCount, 5 - k) / combination(50, 5);
        }
        let probStars = 0;
        for (let l = stopStars; l <= Math.min(starCount, 2); l++) {
          probStars += combination(starCount, l) * combination(12 - starCount, 2 - l) / combination(12, 2);
        }
        return probNum * probStars;
      }

      const pTicket = computeChance(numCount, starCount, stopNumbers, stopStars);
      const pGlobal = 1 - Math.pow(1 - pTicket, numTickets);
      const percent = (pGlobal * 100).toFixed(8);
      const reciprocalFormatted = pGlobal > 0
        ? (1 / pGlobal).toLocaleString('de-DE', { maximumFractionDigits: 0 })
        : "‚àû";
      document.getElementById("chanceDisplay").innerHTML =
        `Taux de chance (pour au moins ${stopNumbers} n¬∞ et ${stopStars} ‚òÖ) : ${percent}%<br>
         1 chance sur ${reciprocalFormatted}`;
    }

    function formatTimeInDays(totalDays) {
      const joursTotal = Math.floor(totalDays);
      let centuries = Math.floor(joursTotal / 36500);
      let reste = joursTotal % 36500;
      let years = Math.floor(reste / 365);
      reste = reste % 365;
      let months = Math.floor(reste / 30.4375);
      reste = Math.floor(reste % 30.4375);
      let weeks = Math.floor(reste / 7);
      let days = reste % 7;
      const parts = [];
      if (centuries > 0) parts.push(centuries + " " + (centuries === 1 ? "si√®cle" : "si√®cles"));
      if (years > 0) parts.push(years + " " + (years === 1 ? "an" : "ans"));
      if (months > 0) parts.push(months + " mois");
      if (weeks > 0) parts.push(weeks + " " + (weeks === 1 ? "semaine" : "semaines"));
      if (days > 0) parts.push(days + " " + (days === 1 ? "jour" : "jours"));
      return parts.length === 0 ? "0 jour" : parts.join(", ");
    }

    function updateTimePassed(drawCount) {
      const days = drawCount * 3.5;
      const formatted = formatTimeInDays(days);
      document.getElementById("timePassed").textContent = "Temps √©coul√© : " + formatted;
    }

    function updateGainDisplay() {
      const formatted = balance.toLocaleString('de-DE', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
      const gainElem = document.getElementById("gainDisplay");
      let imageContainer = document.getElementById("looseImageContainer");
      if (!imageContainer) {
        imageContainer = document.createElement("span");
        imageContainer.id = "looseImageContainer";
      }
      if (balance >= 0) {
        gainElem.innerHTML = `Gain net : <span style='color: green;'>${formatted} ‚Ç¨</span>`;
      } else {
        gainElem.innerHTML = `Gain net : <span style='color: red;'>${formatted} ‚Ç¨</span>`;
      }
      gainElem.appendChild(imageContainer);
    }

    document.querySelectorAll("#ticketNumbersCount, #ticketStarsCount, #numTickets, #stopNumbers, #stopStars, #customGrids, #stopAfterYearsInput, #stopAfterYearsCheckbox")
      .forEach(input => {
        input.addEventListener("input", updateChanceDisplay);
      });
    updateChanceDisplay();
    document.getElementById("stopBtn").style.display = "none";

    document.getElementById("multichanceCheckbox").addEventListener("change", function() {
      const partsContainer = document.getElementById("multichancePartsContainer");
      partsContainer.style.display = this.checked ? "block" : "none";
    });

    document.getElementById("myMillonCheckbox").addEventListener("change", function() {
      document.getElementById("stopMyMillonWinGroup").style.display = this.checked ? "block" : "none";
      updateStatsDisplay();
    });

    document.getElementById("modeSelect").addEventListener("change", function() {
      const mode = this.value;
      if (mode === "flash") {
        document.getElementById("flashSettings").style.display = "block";
        document.getElementById("customSettings").style.display = "none";
        document.getElementById("ticketsCountGroup").style.display = "block";
        document.getElementById("multichanceGroup").style.display = "block";
        document.getElementById("multichancePartsContainer").style.display =
          document.getElementById("multichanceCheckbox").checked ? "block" : "none";
      } else {
        document.getElementById("flashSettings").style.display = "none";
        document.getElementById("customSettings").style.display = "block";
        document.getElementById("ticketsCountGroup").style.display = "none";
        document.getElementById("multichanceGroup").style.display = "none";
        document.getElementById("multichancePartsContainer").style.display = "none";
      }
      updateChanceDisplay();
    });

    const speedSlider = document.getElementById("speedSlider");
    const speedValueLabel = document.getElementById("speedValueLabel");

    function updateSpeedFromSlider(value) {
      const sliderVal = parseInt(value, 10);
      if (sliderVal <= 50) {
        currentBatchSize = 1;
        currentSpeed = Math.round(1000 - (sliderVal - 1) * (999 / 49));
      } else if (sliderVal <= 70) {
        let ratio = (sliderVal - 50) / 20;
        currentBatchSize = Math.round(1 + ratio * (200 - 1));
        currentSpeed = 1;
      } else {
        let ratio = (sliderVal - 70) / 30;
        currentBatchSize = Math.round(200 + ratio * (2000 - 200));
        currentSpeed = Math.round(1 - ratio * 1);
      }
      speedValueLabel.textContent = `(Tirage = ${currentBatchSize}, D√©lai = ${currentSpeed} ms)`;
    }

    updateSpeedFromSlider(speedSlider.value);
    speedSlider.addEventListener("input", function() {
      updateSpeedFromSlider(this.value);
    });

    function runLoop() {
      removeLooseImages();
      if (stopFlag) return;
      simulationActive = true;

      const mode = document.getElementById("modeSelect").value;
      let multichanceRatio = 1;
      if (mode === "flash" && document.getElementById("multichanceCheckbox").checked) {
        const totalParts = parseInt(document.getElementById("totalParts").value) || 0;
        const yourParts = parseInt(document.getElementById("yourParts").value) || 0;
        if (yourParts > totalParts) {
          alert("Erreur : Votre nombre de parts ne peut pas d√©passer le total de parts (" + totalParts + ").");
          stopFlag = true;
          document.getElementById("startBtn").style.display = "block";
          simulationActive = false;
          return;
        }
        multichanceRatio = yourParts / totalParts;
      }
      let tickets = [];
      let draw = null;
      let customTickets = [];
      if (mode === "custom") {
        const customGridsText = document.getElementById("customGrids").value;
        customTickets = parseCustomGrids(customGridsText);
      }
      const numCount = mode === "flash"
        ? (parseInt(document.getElementById("ticketNumbersCount").value) || 5)
        : (customTickets.length > 0 ? customTickets[0].numbers.length : 5);
      const starCount = mode === "flash"
        ? (parseInt(document.getElementById("ticketStarsCount").value) || 2)
        : (customTickets.length > 0 ? customTickets[0].stars.length : 2);
      const numTickets = mode === "flash"
        ? (parseInt(document.getElementById("numTickets").value) || 1)
        : (customTickets.length > 0 ? customTickets.length : 1);

      const simpleGridsPerTicket = combination(
        Math.max(5, Math.min(50, numCount)),
          5
        ) * combination(
        Math.max(2, Math.min(12, starCount)),
          2
        );
      const stopNumbers = parseInt(document.getElementById("stopNumbers").value) || 0;
      const stopStars = parseInt(document.getElementById("stopStars").value) || 0;
      const stopAfterYearsChecked = document.getElementById("stopAfterYearsCheckbox").checked;
      const stopAfterYearsValue = parseInt(document.getElementById("stopAfterYearsInput").value) || 100;
      const batchSize = currentBatchSize;
      const speed = currentSpeed;

      const stopMyMillonWin = document.getElementById("stopMyMillonWinCheckbox").checked;

      for (let i = 0; i < batchSize; i++) {
        count++;
        totalGrillesJouees += numTickets * simpleGridsPerTicket;
        tickets = [];
        for (let j = 0; j < numTickets; j++) {
          if (mode === "flash") {
            tickets.push(generateTicket(numCount, starCount));
          } else {
            if (customTickets.length > 0) {
              tickets.push(customTickets[j % customTickets.length]);
            }
          }
        }
        if (mode === "flash") {
          let costPerTicket = simpleGridsPerTicket * ticketCost;
          if (document.getElementById("multichanceCheckbox").checked) {
            costPerTicket *= multichanceRatio;
          }
          balance -= numTickets * costPerTicket;
        } else {
          tickets.forEach(ticket => {
            balance -= costOfTicket(ticket);
          });
        }
        draw = generateDraw();

        // Gestion de l'option My Millon
        let myMillionJustWon = false;
        if (document.getElementById("myMillonCheckbox").checked) {
          let possibilities = (count % 2 === 0) ? 4000000 : 8000000;
          let assignedRanges = [];
          tickets.forEach(ticket => {
            let n = ticket.numbers.length;
            let s = ticket.stars.length;
            let numGrilles = combination(n, 5) * combination(s, 2);
            if (numGrilles > 1) {
              let baseNumber;
              let attempt = 0;
              const maxAttempts = 100;
              do {
                baseNumber = Math.floor(Math.random() * (possibilities - numGrilles + 1)) + 1;
                attempt++;
                var conflict = assignedRanges.some(range =>
                  baseNumber <= range.end && (baseNumber + numGrilles - 1) >= range.start
                );
              } while (conflict && attempt < maxAttempts);
              let rangeEnd = baseNumber + numGrilles - 1;
              assignedRanges.push({ start: baseNumber, end: rangeEnd });
              ticket.myMillon = baseNumber + " √† " + rangeEnd;
            } else {
              let candidate;
              let attempt = 0;
              const maxAttempts = 100;
              do {
                candidate = Math.floor(Math.random() * possibilities) + 1;
                attempt++;
                var conflict = assignedRanges.some(range =>
                  candidate >= range.start && candidate <= range.end
                );
              } while (conflict && attempt < maxAttempts);
              assignedRanges.push({ start: candidate, end: candidate });
              ticket.myMillon = candidate;
            }
          });
          draw.myMillon = Math.floor(Math.random() * possibilities) + 1;

          let myMillonWin = tickets.some(ticket => {
            if (typeof ticket.myMillon === "string" && ticket.myMillon.includes(" √† ")) {
              let [start, end] = ticket.myMillon.split(" √† ").map(Number);
              return draw.myMillon >= start && draw.myMillon <= end;
            } else {
              return ticket.myMillon === draw.myMillon;
            }
          });

          if (myMillonWin) {
            myMillionWinCount++;
            let myMillonPrize = 1000000;
            if (document.getElementById("multichanceCheckbox").checked) {
              const totalParts = parseInt(document.getElementById("totalParts").value) || 1;
              const yourParts = parseInt(document.getElementById("yourParts").value) || 1;
              myMillonPrize = 1000000 * (yourParts / totalParts);
            }
            balance += myMillonPrize;
            myMillionTotalGain += myMillonPrize;
            updateStatsDisplay();

            myMillionJustWon = true;
            if (stopMyMillonWin) {
              alert("Option My Millon gagn√©e !\nTirage My Million : " + formatMyMillion(draw.myMillon) + "\nGain : " + myMillonPrize.toLocaleString('de-DE', { maximumFractionDigits: 0 }) + " ‚Ç¨");

              if (balance >= 1) {
                playSound("win.mp3");
              } else if (balance <= -1000000) {
                playSound("bigloose.mp3");
                addLooseImage("bigloose.jpeg");
              } else {
                playSound("loose.mp3");
                addLooseImage("loose.png");
              }

              stopFlag = true;
              simulationActive = false;
              document.getElementById("startBtn").style.display = "block";
              document.getElementById("ticketsContainer").innerHTML = "";
              tickets.forEach((ticket, index) => {
                const div = document.createElement("div");
                let isWinning = false;
                if (typeof ticket.myMillon === "string" && ticket.myMillon.includes(" √† ")) {
                  let [start, end] = ticket.myMillon.split(" √† ").map(Number);
                  if (draw.myMillon >= start && draw.myMillon <= end) {
                    isWinning = true;
                  }
                } else if (ticket.myMillon === draw.myMillon) {
                  isWinning = true;
                }
                div.className = "ticket" + (isWinning ? " winning" : "");
                const highlightedNums = highlightMatches(ticket.numbers, draw.numbers, "number");
                const highlightedStars = highlightMatches(ticket.stars, draw.stars, "star");
                let myMillionDisplay = ticket.myMillon;
                if (isWinning) {
                  myMillionDisplay = `<span style="color: green; font-weight: bold;">${formatMyMillion(ticket.myMillon)}</span>`;
                }
                div.innerHTML = `<strong>Ticket ${index + 1} :</strong><br>
                                 Num√©ros : ${highlightedNums}<br>
                                 √âtoiles : ${highlightedStars}<br>
                                 My Million : ${myMillionDisplay}`;
                document.getElementById("ticketsContainer").appendChild(div);
              });
	const isPlain = typeof fancyDisplay !== "undefined" && !fancyDisplay;
	document.getElementById("resultat").innerHTML =
	  `<strong>Tirage :</strong><br>
	   Num√©ros : ${isPlain ? simpleTextList(draw.numbers) : balls(draw.numbers, "number")}<br>
	   √âtoiles : ${isPlain ? simpleTextList(draw.stars) : balls(draw.stars, "star")}<br>
	   My Million : ${formatMyMillion(draw.myMillon)}`;
              document.getElementById("counter").textContent = "Tirages : " + count.toLocaleString('de-DE');
              document.getElementById("grillesPlayed").textContent = "Grilles jou√©es : " + totalGrillesJouees.toLocaleString('de-DE');
              updateTimePassed(count);
              updateStatsDisplay();
              updateGainDisplay();
              return;
            }
          }
        }
        // --- (le reste du code runLoop inchang√©) ---

        // Check arr√™t par ann√©es
        if (stopAfterYearsChecked) {
          const currentYears = (count * 3.5) / 365;
          if (currentYears >= stopAfterYearsValue) {
            document.getElementById("ticketsContainer").innerHTML = "";
			const isPlain = typeof fancyDisplay !== "undefined" && !fancyDisplay;
			document.getElementById("resultat").innerHTML =
			  `<strong>Tirage :</strong><br>
			   Num√©ros : ${isPlain ? simpleTextList(draw.numbers) : balls(draw.numbers, "number")}<br>
			   √âtoiles : ${isPlain ? simpleTextList(draw.stars) : balls(draw.stars, "star")}${document.getElementById("myMillonCheckbox").checked ? "<br>My Million : " + formatMyMillion(draw.myMillon) : ""}`;

            document.getElementById("counter").textContent = "Tirages : " + count.toLocaleString('de-DE');
            document.getElementById("grillesPlayed").textContent = "Grilles jou√©es : " + totalGrillesJouees.toLocaleString('de-DE');
            updateTimePassed(count);
            updateStatsDisplay();
            updateGainDisplay();
            alert("On a d√©pass√© les " + stopAfterYearsValue + " ans de simulation !\n(Nombre de tirages : " + count.toLocaleString('de-DE') + ")");

            if (balance >= 1) {
              playSound("win.mp3");
            } else if (balance <= -1000000) {
              playSound("bigloose.mp3");
              addLooseImage("bigloose.jpeg");
            } else {
              playSound("loose.mp3");
              addLooseImage("loose.png");
            }

            stopFlag = true;
            simulationActive = false;
            document.getElementById("startBtn").style.display = "block";
            return;
          }
        }

        let foundWinningTicket = false;
        let winningTicket = null;
        tickets.forEach(ticket => {
          const n = ticket.numbers.length;
          const s = ticket.stars.length;

          const numGood = countMatches(ticket.numbers, draw.numbers);
          const numBad = n - numGood;
          const starGood = countMatches(ticket.stars, draw.stars);
          const starBad = s - starGood;

          // Pour chaque possibilit√© de bons num√©ros (0 √† 5) et √©toiles (0 √† 2)
          for (let nb = 0; nb <= Math.min(5, n); nb++) {
            for (let sb = 0; sb <= Math.min(2, s); sb++) {
              // Combien de grilles simples (dans la grille multiple) font nb bons num√©ros et sb bonnes √©toiles
              const waysNum = combination(numGood, nb) * combination(numBad, 5 - nb);
              const waysStar = combination(starGood, sb) * combination(starBad, 2 - sb);
              const countGrilles = waysNum * waysStar;
              if (countGrilles > 0) {
                const key = nb + "_" + sb;
                if (stats.hasOwnProperty(key)) stats[key] += countGrilles;
                let prize = prizeMapping[key] || 0;
                if (document.getElementById("multichanceCheckbox").checked) {
                  prize *= multichanceRatio;
                }
                balance += prize * countGrilles;
                statsGain[key] += prize * countGrilles;

                // Si au moins UNE des grilles simples franchit le seuil d'arr√™t, on consid√®re le ticket "gagnant"
                if (!foundWinningTicket && nb >= stopNumbers && sb >= stopStars && countGrilles > 0) {
                  foundWinningTicket = true;
                  winningTicket = ticket;
                }
              }
            }
          }
        });


        if (foundWinningTicket) {
          document.getElementById("ticketsContainer").innerHTML = "";
		  adjustTicketColumns(tickets);
          tickets.forEach((ticket, index) => {
            const div = document.createElement("div");
            div.className = "ticket";
            const highlightedNums = highlightMatches(ticket.numbers, draw.numbers, "number");
            const highlightedStars = highlightMatches(ticket.stars, draw.stars, "star");
            div.innerHTML = `<strong>Ticket ${index + 1} :</strong><br>
                             Num√©ros : ${highlightedNums}<br>
                             √âtoiles : ${highlightedStars}${document.getElementById("myMillonCheckbox").checked ? "<br>My Million : " + formatMyMillion(ticket.myMillon) : ""}`;
            if (ticket === winningTicket) {
              div.classList.add("winning");
            }
            document.getElementById("ticketsContainer").appendChild(div);
          });
			const isPlain = typeof fancyDisplay !== "undefined" && !fancyDisplay;
			document.getElementById("resultat").innerHTML =
			  `<strong>Tirage :</strong><br>
			   Num√©ros : ${isPlain ? simpleTextList(draw.numbers) : balls(draw.numbers, "number")}<br>
			   √âtoiles : ${isPlain ? simpleTextList(draw.stars) : balls(draw.stars, "star")}${document.getElementById("myMillonCheckbox").checked ? "<br>My Million : " + formatMyMillion(draw.myMillon) : ""}`;

          document.getElementById("counter").textContent = "Tirages : " + count.toLocaleString('de-DE');
          document.getElementById("grillesPlayed").textContent = "Grilles jou√©es : " + totalGrillesJouees.toLocaleString('de-DE');
          updateTimePassed(count);
          updateStatsDisplay();
          updateGainDisplay();

          const winningMatchNumbers = countMatches(winningTicket.numbers, draw.numbers);
          const winningMatchStars = countMatches(winningTicket.stars, draw.stars);
          const winningKey = winningMatchNumbers + "_" + winningMatchStars;
          let winningGain = prizeMapping[winningKey] || 0;
          if (document.getElementById("multichanceCheckbox").checked) {
            winningGain *= multichanceRatio;
          }
          if (winningMatchNumbers === 5 && winningMatchStars === 2) {
            launchFireworks();
          }
          alert("Seuil atteint !\n" +
                "Ticket gagnant : " + winningTicket.numbers.join(", ") + " | " + winningTicket.stars.join(", ") + "\n" +
                "Tirage : " + draw.numbers.join(", ") + " | " + draw.stars.join(", ") + "\n" +
                "Nombre de tirages : " + count.toLocaleString('de-DE') + "\n" +
                "Gain : " + winningGain.toLocaleString('de-DE', { maximumFractionDigits: 0 }) + " ‚Ç¨");

          if (balance >= 1) {
            playSound("win.mp3");
            } else if (balance <= -1000000) {
              playSound("bigloose.mp3");
              addLooseImage("bigloose.jpeg");
            } else {
              playSound("loose.mp3");
              addLooseImage("loose.png");
            }

          stopFlag = true;
          simulationActive = false;
          document.getElementById("startBtn").style.display = "block";
          return;
        }

        if (document.getElementById("stopNegativeGainCheckbox").checked) {
          const negThreshold = parseFloat(document.getElementById("stopNegativeGainThreshold").value) || 0;
          if (balance < -negThreshold) {
            document.getElementById("ticketsContainer").innerHTML = "";
			adjustTicketColumns(tickets);
			const isPlain = typeof fancyDisplay !== "undefined" && !fancyDisplay;
			document.getElementById("resultat").innerHTML =
			  `<strong>Tirage :</strong><br>
			   Num√©ros : ${isPlain ? simpleTextList(draw.numbers) : balls(draw.numbers, "number")}<br>
			   √âtoiles : ${isPlain ? simpleTextList(draw.stars) : balls(draw.stars, "star")}${document.getElementById("myMillonCheckbox").checked ? "<br>My Million : " + formatMyMillion(draw.myMillon) : ""}`;

            document.getElementById("counter").textContent = "Tirages : " + count.toLocaleString('de-DE');
            document.getElementById("grillesPlayed").textContent = "Grilles jou√©es : " + totalGrillesJouees.toLocaleString('de-DE');
            updateTimePassed(count);
            updateStatsDisplay();
            updateGainDisplay();
            alert("Le gain net est inf√©rieur au seuil d√©fini (-" + negThreshold + " ‚Ç¨). La simulation est arr√™t√©e.");

            if (balance >= 1) {
              playSound("win.mp3");
            } else if (balance <= -1000000) {
              playSound("bigloose.mp3");
              addLooseImage("bigloose.jpeg");
            } else {
              playSound("loose.mp3");
              addLooseImage("loose.png");
            }

            stopFlag = true;
            simulationActive = false;
            document.getElementById("startBtn").style.display = "block";
            return;
          }
        }
      }

      document.getElementById("ticketsContainer").innerHTML = "";
	  adjustTicketColumns(tickets);
      tickets.forEach((ticket, index) => {
        const div = document.createElement("div");
        div.className = "ticket";
        const highlightedNums = highlightMatches(ticket.numbers, draw.numbers, "number");
        const highlightedStars = highlightMatches(ticket.stars, draw.stars, "star");
        div.innerHTML = `<strong>Ticket ${index + 1} :</strong><br>
                         Num√©ros : ${highlightedNums}<br>
                         √âtoiles : ${highlightedStars}${document.getElementById("myMillonCheckbox").checked ? "<br>My Million : " + formatMyMillion(ticket.myMillon) : ""}`;
        document.getElementById("ticketsContainer").appendChild(div);
      });
	  
	    window._lastTicketsData = {
    tickets: tickets,
    draw: draw,
    myMillion: document.getElementById("myMillonCheckbox").checked
  };
	  
	const isPlain = typeof fancyDisplay !== "undefined" && !fancyDisplay;
	document.getElementById("resultat").innerHTML =
	  `<strong>Tirage :</strong><br>
	   Num√©ros : ${isPlain ? simpleTextList(draw.numbers) : balls(draw.numbers, "number")}<br>
	   √âtoiles : ${isPlain ? simpleTextList(draw.stars) : balls(draw.stars, "star")}${document.getElementById("myMillonCheckbox").checked ? "<br>My Million : " + formatMyMillion(draw.myMillon) : ""}`;

      document.getElementById("counter").textContent = "Tirages : " + count.toLocaleString('de-DE');
      document.getElementById("grillesPlayed").textContent = "Grilles jou√©es : " + totalGrillesJouees.toLocaleString('de-DE');
      updateTimePassed(count);
      updateStatsDisplay();
      updateGainDisplay();

      loopTimeout = setTimeout(runLoop, speed);
    }

    function startDrawing() {
      simulationHasStarted = true;
      if (document.getElementById("modeSelect").value === "flash" && document.getElementById("multichanceCheckbox").checked) {
        const totalParts = parseInt(document.getElementById("totalParts").value) || 0;
        const yourParts = parseInt(document.getElementById("yourParts").value) || 0;
        if (yourParts > totalParts) {
          alert("Erreur : Votre nombre de parts (" + yourParts + ") ne peut pas d√©passer le total de parts (" + totalParts + ").");
          return;
        }
      }
      clearTimeout(loopTimeout);
      count = 0;
      stopFlag = false;
      balance = 0;
      totalGrillesJouees = 0;
      for (let combo in stats) {
        stats[combo] = 0;
        statsGain[combo] = 0;
      }
      myMillionWinCount = 0;
      myMillionTotalGain = 0;
      simulationActive = true;
      document.getElementById("counter").textContent = "Tirages : 0";
      document.getElementById("grillesPlayed").textContent = "Grilles jou√©es : 0";
      document.getElementById("timePassed").textContent = "Temps √©coul√© : 0 jour";
      document.getElementById("gainDisplay").innerHTML = "<span style='color: green;'>Gain net : 0,00 ‚Ç¨</span>";
      document.getElementById("ticketsContainer").innerHTML = "";
      document.getElementById("resultat").innerHTML = `<strong>Tirage :</strong><br>Num√©ros : --<br>√âtoiles : --`;
      document.getElementById("stopBtn").textContent = "Stop";
      updateStatsDisplay();
      updateTimePassed(0);
      updateGainDisplay();
      removeLooseImages();
      document.getElementById("startBtn").style.display = "none";
      document.getElementById("stopBtn").style.display = "inline-block";
      runLoop();
    }

    document.getElementById("myMillonCheckbox").checked = true;
    document.getElementById("stopMyMillonWinCheckbox").checked = false;
    document.getElementById("stopMyMillonWinGroup").style.display = "block";

    document.getElementById("startBtn").addEventListener("click", startDrawing);
    document.getElementById("stopBtn").addEventListener("click", function() {
      if (!stopFlag) {
        stopFlag = true;
        simulationActive = false;
        clearTimeout(loopTimeout);
        this.textContent = "Continuer";
      } else {
        stopFlag = false;
        simulationActive = true;
        this.textContent = "Stop";
        runLoop();
      }
      updateStatsDisplay();
    });
    document.getElementById("resetBtn").addEventListener("click", function() {
      stopFlag = true;
      simulationHasStarted = false;
      clearTimeout(loopTimeout);
      count = 0;
      totalGrillesJouees = 0;
      for (let combo in stats) {
        stats[combo] = 0;
        statsGain[combo] = 0;
      }
      myMillionWinCount = 0;
      myMillionTotalGain = 0;
      simulationActive = false;
      updateStatsDisplay();
      document.getElementById("counter").textContent = "Tirages : 0";
      document.getElementById("grillesPlayed").textContent = "Grilles jou√©es : 0";
      document.getElementById("timePassed").textContent = "Temps √©coul√© : 0 jour";
      document.getElementById("gainDisplay").innerHTML = "<span style='color: green;'>Gain net : 0,00 ‚Ç¨</span>";
      document.getElementById("ticketsContainer").innerHTML = "";
      document.getElementById("resultat").innerHTML = `<strong>Tirage :</strong><br>Num√©ros : --<br>√âtoiles : --`;
      document.getElementById("stopBtn").textContent = "Stop";
      document.getElementById("startBtn").style.display = "block";
      document.getElementById("stopBtn").style.display = "none";
      removeLooseImages();
    });

    // Initialisation pour cacher/montrer la ligne au chargement
    updateStatsDisplay();

    document.getElementById("ticketStarsCount").addEventListener("blur", function() {
      let v = parseInt(this.value) || 2;
      if (v < 2) v = 2;
      if (v > 12) v = 12;
      this.value = v;
    });
    document.getElementById("ticketNumbersCount").addEventListener("blur", function() {
      let v = parseInt(this.value) || 5;
      if (v < 5) v = 5;
      if (v > 50) v = 50;
      this.value = v;
    });
  </script>
</body>
</html>
