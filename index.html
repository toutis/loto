<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Simulation Euro Millions</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    .main-container {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      flex-wrap: wrap;
      gap: 10px;
    }
    .left-column {
      flex: 1;
      max-width: 45%;
      text-align: left;
    }
    .right-column {
      flex: 1;
      max-width: 45%;
      text-align: left;
    }
    .form-group,
    .display,
    .compteur {
      font-size: 1.1em;
      margin: 10px 0;
    }
    input,
    button,
    select,
    textarea {
      padding: 6px 12px;
      font-size: 1em;
      margin: 5px;
    }
    .ticket {
      border: 1px solid #aaa;
      padding: 8px;
      margin: 5px 0;
      width: fit-content;
    }
    .winning {
      background-color: #cfc;
    }
    #chanceDisplay {
      font-weight: bold;
      margin: 10px 0;
    }
    #resultat {
      border: 2px solid gold;
      padding: 10px;
      margin: 10px 0;
    }
    #statsContainer {
      margin-top: 20px;
    }
    #statsContainer ul {
      list-style: none;
      padding: 0;
    }
    #statsContainer li {
      margin: 5px 0;
    }
    #multichanceAndMyMillonContainer {
      display: flex;
      align-items: center;
    }
    .info-icon {
      display: inline-block;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background-color: #ccc;
      text-align: center;
      line-height: 16px;
      font-size: 12px;
      margin-left: 5px;
      cursor: help;
    }
    #speedControlGroup {
      display: flex;
      align-items: center;
      justify-content: flex-start;
      gap: 10px;
      margin: 10px 0;
    }
    #speedValueLabel {
      color: gray;
    }
    #fireworksContainer {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 9999;
    }
    .firework {
      position: absolute;
      width: 4px;
      height: 4px;
      background: radial-gradient(circle, var(--color) 0%, var(--color-dark) 70%);
      border-radius: 50%;
      opacity: 1;
      animation: firework 2.0s ease-out forwards;
      box-shadow: 0 0 15px var(--color);
    }
    @keyframes firework {
      0% { transform: scale(1); opacity: 1; }
      50% { opacity: 1; }
      100% { transform: translate(var(--tx), var(--ty)) scale(3); opacity: 0; }
    }
    .sound-toggle {
      cursor: pointer;
      margin-left: 10px;
      font-size: 24px;
    }
    .sound-toggle span {
      display: inline-block;
    }
    #stopMyMillonWinGroup {
      margin-left: 22px;
      margin-top: 0;
      font-size: 0.95em;
      display: none;
    }
  </style>
</head>
<body>
  <div class="main-container">
    <div class="left-column">
      <h1>
        Simulation Euro Millions
        <span id="soundToggle" class="sound-toggle">
          <span id="soundOnIcon" style="display: none;">&#128266;</span>
          <span id="soundOffIcon" style="display: inline-block;">&#128263;</span>
        </span>
      </h1>
      <div class="section">
        <div class="form-group">
          <label for="modeSelect">Mode :</label>
          <select id="modeSelect">
            <option value="flash" selected>Flash (tickets aléatoires)</option>
            <option value="custom">Personnalisé (définir mes propres grilles)</option>
          </select>
        </div>
        <div class="form-group" id="flashSettings">
          <label for="ticketNumbersCount">Nombre de numéros (min 5, max 50) :</label>
          <input type="number" id="ticketNumbersCount" value="5" min="5" max="50"><br>
          <label for="ticketStarsCount">Nombre d'étoiles (min 2, max 12) :</label>
          <input type="number" id="ticketStarsCount" value="2" min="2" max="12">
        </div>
        <div class="form-group" id="customSettings" style="display:none;">
          <label for="customGrids">
            Mes grilles personnalisées :<br>
            Entrez une grille par ligne au format "num1,num2,... ; star1,star2,..."<br>
            Exemple: <em>3,15,22,37,42 ; 1,9</em>
          </label>
          <br>
          <textarea id="customGrids" rows="4" cols="50" placeholder="Une grille par ligne"></textarea>
        </div>
        <div class="form-group" id="ticketsCountGroup">
          <label for="numTickets">Nombre de tickets par tirage :</label>
          <input type="number" id="numTickets" value="1" min="1">
        </div>
        <div class="form-group">
          <label for="stopNumbers">Stopper si au moins X numéros corrects :</label>
          <input type="number" id="stopNumbers" value="5" min="0" max="5">
        </div>
        <div class="form-group">
          <label for="stopStars">Stopper si au moins Y étoiles correctes :</label>
          <input type="number" id="stopStars" value="2" min="0" max="2">
        </div>
        <div class="form-group">
          <input type="checkbox" id="stopNegativeGainCheckbox">
          <label for="stopNegativeGainCheckbox">Stopper si le gain net est négatif à :</label>
          <input type="number" id="stopNegativeGainThreshold" value="10000" step="0.01" style="width:100px;">
        </div>
        <div class="form-group">
          <input type="checkbox" id="stopAfterYearsCheckbox">
          <label for="stopAfterYearsCheckbox">Stopper si on dépasse X années :</label>
          <input type="number" id="stopAfterYearsInput" value="50" min="1" style="width:80px;">
        </div>
        <div class="form-group" id="speedControlGroup">
          <label for="speedSlider">Vitesse :</label>
          <input type="range" id="speedSlider" min="1" max="100" value="50" list="tickmarks">
          <datalist id="tickmarks">
            <option value="50" label="50%"></option>
          </datalist>
          <span id="speedValueLabel">(Tirage = 1, Délai = 1000 ms)</span>
        </div>
        <div class="form-group" id="multichanceAndMyMillonContainer">
          <div id="myMillonGroup" style="display: inline-block; margin-right: 20px;">
            <input type="checkbox" id="myMillonCheckbox" checked>
            <label for="myMillonCheckbox">
              My Millon
              <span class="info-icon"
                    title="L'option My Millon : Chaque mardi en France, environ 4 millions de grilles sont jouées, et 8 millions le vendredi.
À chaque tirage, un numéro aléatoire est attribué parmi l'ensemble des grilles jouées.
Le gagnant dont le numéro correspond exactement à celui du tirage remporte 1 000 000 € !"
                    onclick="event.stopPropagation(); event.preventDefault();"
                    onmousedown="event.stopPropagation(); event.preventDefault();">
                i
              </span>
            </label>
          </div>
          <div id="multichanceGroup" style="display: inline-block;">
            <input type="checkbox" id="multichanceCheckbox">
            <label for="multichanceCheckbox">
              Multichance
              <span class="info-icon"
                    title="L'option Multichance : Il permet de réduire votre mise en répartissant votre investissement sur plusieurs parts.
Cela diminue le coût par ticket, mais réduit également les gains proportionnellement au nombre de parts détenues.
Cette option est utilisée seulement avec une dizaine de grilles multiples.
Exemple : 10 grilles multiples (7 numéros, 4 étoiles), 1 à 10 parts sur 420"
                    onclick="event.stopPropagation(); event.preventDefault();"
                    onmousedown="event.stopPropagation(); event.preventDefault();">
                i
              </span>
            </label>
          </div>
        </div>
        <!-- Case à cocher "stopper si on gagne le my million", visible seulement si My Million est coché -->
        <div class="form-group" id="stopMyMillonWinGroup" style="display:none;">
          <input type="checkbox" id="stopMyMillonWinCheckbox">
          <label for="stopMyMillonWinCheckbox">Stopper si on gagne le my million</label>
        </div>
        <div class="form-group" id="multichancePartsContainer" style="display:none; margin-left:20px;">
          <label for="totalParts">Total de parts :</label>
          <input type="number" id="totalParts" value="420" min="1"><br>
          <label for="yourParts">Votre nombre de parts :</label>
          <input type="number" id="yourParts" value="1" min="1">
        </div>
        <div style="display: inline-flex; gap: 10px;">
          <button id="startBtn">Démarrer la simulation</button>
          <button id="stopBtn">Stop</button>
          <button id="resetBtn">Reset</button>
        </div>
      </div>
    </div>
    <div class="right-column">
      <div id="chanceDisplay"></div>
      <div class="section display" id="resultat">
        <strong>Tirage :</strong><br>
        Numéros : --<br>
        Étoiles : --<br>
      </div>
      <div class="compteur" id="counter">Tirages : 0</div>
      <div class="compteur" id="timePassed">Temps écoulé : 0 jour</div>
      <div class="compteur" id="grillesPlayed">Grilles jouées : 0</div>
      <div class="compteur" id="gainDisplay">Gain net : 0 €</div>
      <div class="section display" id="ticketsContainer"></div>
      <div class="section display" id="statsContainer">
        <h3>Statistiques de résultats</h3>
        <ul>
          <li id="stats_myMillion" style="display: list-item;">
            My Million : <span id="stats_myMillion_value">0</span>
            <span id="stats_myMillion_pct"></span>
            <span id="stats_myMillion_gain"></span>
          </li>
          <li>5 n° + 2 ★ : <span id="stats_5_2">0</span></li>
          <li>5 n° + 1 ★ : <span id="stats_5_1">0</span></li>
          <li>5 n° + 0 ★ : <span id="stats_5_0">0</span></li>
          <li>4 n° + 2 ★ : <span id="stats_4_2">0</span></li>
          <li>4 n° + 1 ★ : <span id="stats_4_1">0</span></li>
          <li>4 n° + 0 ★ : <span id="stats_4_0">0</span></li>
          <li>3 n° + 2 ★ : <span id="stats_3_2">0</span></li>
          <li>3 n° + 1 ★ : <span id="stats_3_1">0</span></li>
          <li>3 n° + 0 ★ : <span id="stats_3_0">0</span></li>
          <li>2 n° + 2 ★ : <span id="stats_2_2">0</span></li>
          <li>2 n° + 1 ★ : <span id="stats_2_1">0</span></li>
          <li>2 n° + 0 ★ : <span id="stats_2_0">0</span></li>
          <li>1 n° + 2 ★ : <span id="stats_1_2">0</span></li>
          <li>1 n° + 1 ★ : <span id="stats_1_1">0</span></li>
          <li>1 n° + 0 ★ : <span id="stats_1_0">0</span></li>
          <li>0 n° + 2 ★ : <span id="stats_0_2">0</span></li>
          <li>0 n° + 1 ★ : <span id="stats_0_1">0</span></li>
          <li>0 n° + 0 ★ : <span id="stats_0_0">0</span></li>
        </ul>
      </div>
    </div>
  </div>
  <div id="fireworksContainer"></div>
  <script>
    // --- Nouveau : gestion du son ---
    let soundEnabled = false; // Désactivé par défaut
    function toggleSound() {
      soundEnabled = !soundEnabled;
      document.getElementById('soundOnIcon').style.display = soundEnabled ? 'inline-block' : 'none';
      document.getElementById('soundOffIcon').style.display = soundEnabled ? 'none' : 'inline-block';
    }
    document.getElementById('soundToggle').addEventListener('click', toggleSound);

    function playSound(soundFile) {
      if (!soundEnabled) return;
      new Audio(soundFile).play();
    }
    // --- FIN gestion du son ---

    // --- VARIABLES GLOBALES ---
    let stats = {
      "5_2": 0, "5_1": 0, "5_0": 0,
      "4_2": 0, "4_1": 0, "4_0": 0,
      "3_2": 0, "3_1": 0, "3_0": 0,
      "2_2": 0, "2_1": 0, "2_0": 0,
      "1_2": 0, "1_1": 0, "1_0": 0,
      "0_2": 0, "0_1": 0, "0_0": 0
    };

    let myMillionWinCount = 0;
    let myMillionTotalGain = 0;

    let statsGain = {
      "5_2": 0, "5_1": 0, "5_0": 0,
      "4_2": 0, "4_1": 0, "4_0": 0,
      "3_2": 0, "3_1": 0, "3_0": 0,
      "2_2": 0, "2_1": 0, "2_0": 0,
      "1_2": 0, "1_1": 0, "1_0": 0,
      "0_2": 0, "0_1": 0, "0_0": 0
    };

    let count = 0;
    let stopFlag = false;
    let loopTimeout;
    let balance = 0;
    const ticketCost = 2.5;
    let totalGrillesJouees = 0;

    let simulationActive = false; // Indique si la simulation est en cours

    const prizeMapping = {
      "5_2": 45000000,
      "5_1": 400000,
      "5_0": 50000,
      "4_2": 1500,
      "4_1": 150,
      "4_0": 55,
      "3_2": 75,
      "3_1": 14,
      "3_0": 11,
      "2_2": 15,
      "2_1": 8,
      "2_0": 4,
      "1_2": 7,
      "1_1": 0,
      "1_0": 0,
      "0_2": 0,
      "0_1": 0,
      "0_0": 0
    };

    const speedPresets = [
      { batchSize: 1,     speed: 1000 },
      { batchSize: 10,    speed: 500 },
      { batchSize: 100,   speed: 100 },
      { batchSize: 500,   speed: 50 },
      { batchSize: 1000,  speed: 10 },
      { batchSize: 2000,  speed: 5 },
      { batchSize: 5000,  speed: 2 },
      { batchSize: 10000, speed: 1 },
      { batchSize: 50000, speed: 0 },
      { batchSize: 100000,speed: 0 }
    ];

    let currentBatchSize = speedPresets[4].batchSize;
    let currentSpeed = speedPresets[4].speed;

    function combination(n, r) {
      if (r > n) return 0;
      let num = 1, den = 1;
      for (let i = 0; i < r; i++) {
        num *= (n - i);
        den *= (i + 1);
      }
      return num / den;
    }

    function costOfTicket(ticket) {
      const n = ticket.numbers.length;
      const s = ticket.stars.length;
      return combination(n, 5) * combination(s, 2) * ticketCost;
    }

    function generateNumbers(count, max) {
      let numbers = [];
      while (numbers.length < count) {
        const num = Math.floor(Math.random() * max) + 1;
        if (!numbers.includes(num)) {
          numbers.push(num);
        }
      }
      return numbers.sort((a, b) => a - b);
    }
	
	// Renvoie toutes les combinaisons de k éléments dans arr
	function getCombinations(arr, k) {
	  const results = [];
	  function combine(start, combo) {
		if (combo.length === k) {
		  results.push(combo.slice());
		  return;
		}
		for (let i = start; i < arr.length; i++) {
		  combo.push(arr[i]);
		  combine(i + 1, combo);
		  combo.pop();
		}
	  }
	  combine(0, []);
	  return results;
	}


	function generateTicket(numCount, starCount) {
	  // Clamp les valeurs pour garantir les bornes
	  numCount = Math.max(5, Math.min(50, numCount));
	  starCount = Math.max(2, Math.min(12, starCount));

	  const ticketNumbers = generateNumbers(numCount, 50);
	  const ticketStars = generateNumbers(starCount, 12);
	  return { numbers: ticketNumbers, stars: ticketStars };
	}

    function generateDraw() {
      return { numbers: generateNumbers(5, 50), stars: generateNumbers(2, 12) };
    }

    function countMatches(arr1, arr2) {
      return arr1.filter(x => arr2.includes(x)).length;
    }

    function parseCustomInput(str) {
      return str.split(',')
                .map(s => parseInt(s.trim()))
                .filter(n => !isNaN(n));
    }

    function parseCustomGrids(str) {
      const lines = str.split('\n').filter(line => line.trim() !== '');
      const tickets = [];
      lines.forEach(line => {
        const parts = line.split(';');
        if (parts.length === 2) {
          const numbers = parseCustomInput(parts[0]);
          const stars = parseCustomInput(parts[1]);
          if (numbers.length > 0 && stars.length > 0) {
            tickets.push({ numbers: numbers.sort((a, b) => a - b), stars: stars.sort((a, b) => a - b) });
          }
        }
      });
      return tickets;
    }

    function highlightMatches(ticketValues, drawValues) {
      return ticketValues.map(val =>
        drawValues.includes(val)
          ? "<span style='color: green; font-weight: bold;'>" + val + "</span>"
          : val
      ).join(", ");
    }

    function launchFireworks() {
      const container = document.getElementById('fireworksContainer');
      let count = 0;
      const total = 80;
      const interval = setInterval(() => {
        if (count >= total) {
          clearInterval(interval);
          return;
        }
        const firework = document.createElement('div');
        firework.classList.add('firework');
        const x = Math.random() * window.innerWidth;
        firework.style.left = x + 'px';
        firework.style.top = '0px';
        const tx = (Math.random() - 0.5) * 300;
        const ty = Math.random() * 500;
        firework.style.setProperty('--tx', tx + 'px');
        firework.style.setProperty('--ty', ty + 'px');
        const colors = [
          { light: '#ffcc00', dark: '#ff9900' },
          { light: '#ff3366', dark: '#cc0033' },
          { light: '#66ccff', dark: '#3399ff' },
          { light: '#99ff99', dark: '#33cc33' }
        ];
        const chosen = colors[Math.floor(Math.random() * colors.length)];
        firework.style.setProperty('--color', chosen.light);
        firework.style.setProperty('--color-dark', chosen.dark);
        container.appendChild(firework);
        firework.addEventListener('animationend', () => {
          firework.remove();
        });
        count++;
      }, 25);
    }

    function removeLooseImages() {
      const container = document.querySelector('#looseImageContainer');
      if (container) {
        container.innerHTML = "";
      }
    }

    function addLooseImage(filename) {
      const container = document.querySelector('#looseImageContainer');
      if (!container) return;
      const img = document.createElement('img');
      img.src = filename;
      img.style.width = "1.5em";
      img.style.height = "1.5em";
      img.style.verticalAlign = "middle";
      img.style.marginLeft = "8px";
      container.appendChild(img);
    }

    // --- Affichage de la stat My Million avec % et couleur dynamique ---
    function updateStatsDisplay() {
      let total = 0;
      for (let combo in stats) total += stats[combo];

      // My Million
      const elemMyMillion = document.getElementById("stats_myMillion");
      const valMyMillion = document.getElementById("stats_myMillion_value");
      const pctMyMillion = document.getElementById("stats_myMillion_pct");
      const gainMyMillion = document.getElementById("stats_myMillion_gain");

      if (!document.getElementById("myMillonCheckbox").checked) {
        elemMyMillion.style.display = "none";
      } else {
        elemMyMillion.style.display = "list-item";
        let percent = count > 0 ? (myMillionWinCount / count * 100) : 0;
        // Seulement en rouge si la simulation est active ET qu'on est à 0
        if (myMillionWinCount === 0 && simulationActive && count > 0) {
          valMyMillion.innerHTML = `<span style='color: red;'>0</span>`;
        } else {
          valMyMillion.innerHTML = myMillionWinCount.toLocaleString('de-DE');
        }
        pctMyMillion.innerHTML = ` <span style='color: gray;'>(${percent.toFixed(2)}%)</span>`;
        if (myMillionTotalGain > 0) {
          gainMyMillion.innerHTML = ` <span style='color: green;'>+${myMillionTotalGain.toLocaleString('de-DE', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
          })}€</span>`;
        } else {
          gainMyMillion.innerHTML = '';
        }
      }
      // Autres stats
      for (let combo in stats) {
        const elem = document.getElementById("stats_" + combo);
        if (elem) {
          const countValue = stats[combo];
          let pct = total > 0 ? (countValue / total * 100) : 0;
          const totalPrize = statsGain[combo];
          const totalPrizeFormatted = totalPrize.toLocaleString('de-DE', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
          });
          const prizeDisplay = totalPrize === 0 ? "" : `<span style='color: green;'>+${totalPrizeFormatted}€</span>`;
			if (countValue === 0) {
			  elem.innerHTML =
				`<span style='color: ${simulationActive ? 'red' : 'black'};'>${countValue.toLocaleString('de-DE')}</span>
				 <span style='color: gray;'>(${pct.toFixed(2)}%)</span>
				 ${prizeDisplay}`;
			} else {
			  elem.innerHTML =
				`${countValue.toLocaleString('de-DE')}
				 <span style='color: gray;'>(${pct.toFixed(2)}%)</span>
				 ${prizeDisplay}`;
			}
        }
      }
    }

    function updateChanceDisplay() {
      const mode = document.getElementById("modeSelect").value;
      let numCount, starCount;
      if (mode === "flash") {
        numCount = parseInt(document.getElementById("ticketNumbersCount").value) || 5;
        starCount = parseInt(document.getElementById("ticketStarsCount").value) || 2;
      } else {
        const customGridsText = document.getElementById("customGrids").value;
        const grids = parseCustomGrids(customGridsText);
        if (grids.length > 0) {
          numCount = grids[0].numbers.length;
          starCount = grids[0].stars.length;
        } else {
          numCount = 5;
          starCount = 2;
        }
      }
	  numCount = Math.max(5, Math.min(50, numCount));
      starCount = Math.max(2, Math.min(12, starCount));
      const numTickets = mode === "flash" ? (parseInt(document.getElementById("numTickets").value) || 1) : 1;
      const stopNumbers = parseInt(document.getElementById("stopNumbers").value) ?? 5;
      const stopStars = parseInt(document.getElementById("stopStars").value) ?? 2;

      function computeChance(numCount, starCount, stopNumbers, stopStars) {
        let probNum = 0;
        for (let k = stopNumbers; k <= Math.min(numCount, 5); k++) {
          probNum += combination(numCount, k) * combination(50 - numCount, 5 - k) / combination(50, 5);
        }
        let probStars = 0;
        for (let l = stopStars; l <= Math.min(starCount, 2); l++) {
          probStars += combination(starCount, l) * combination(12 - starCount, 2 - l) / combination(12, 2);
        }
        return probNum * probStars;
      }

      const pTicket = computeChance(numCount, starCount, stopNumbers, stopStars);
      const pGlobal = 1 - Math.pow(1 - pTicket, numTickets);
      const percent = (pGlobal * 100).toFixed(8);
      const reciprocalFormatted = pGlobal > 0
        ? (1 / pGlobal).toLocaleString('de-DE', { maximumFractionDigits: 0 })
        : "∞";
      document.getElementById("chanceDisplay").innerHTML =
        `Taux de chance (pour au moins ${stopNumbers} n° et ${stopStars} ★) : ${percent}%<br>
         1 chance sur ${reciprocalFormatted}`;
    }

    function formatTimeInDays(totalDays) {
      const joursTotal = Math.floor(totalDays);
      let centuries = Math.floor(joursTotal / 36500);
      let reste = joursTotal % 36500;
      let years = Math.floor(reste / 365);
      reste = reste % 365;
      let months = Math.floor(reste / 30.4375);
      reste = Math.floor(reste % 30.4375);
      let weeks = Math.floor(reste / 7);
      let days = reste % 7;
      const parts = [];
      if (centuries > 0) parts.push(centuries + " " + (centuries === 1 ? "siècle" : "siècles"));
      if (years > 0) parts.push(years + " " + (years === 1 ? "an" : "ans"));
      if (months > 0) parts.push(months + " mois");
      if (weeks > 0) parts.push(weeks + " " + (weeks === 1 ? "semaine" : "semaines"));
      if (days > 0) parts.push(days + " " + (days === 1 ? "jour" : "jours"));
      return parts.length === 0 ? "0 jour" : parts.join(", ");
    }

    function updateTimePassed(drawCount) {
      const days = drawCount * 3.5;
      const formatted = formatTimeInDays(days);
      document.getElementById("timePassed").textContent = "Temps écoulé : " + formatted;
    }

    function updateGainDisplay() {
      const formatted = balance.toLocaleString('de-DE', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
      const gainElem = document.getElementById("gainDisplay");
      let imageContainer = document.getElementById("looseImageContainer");
      if (!imageContainer) {
        imageContainer = document.createElement("span");
        imageContainer.id = "looseImageContainer";
      }
      if (balance >= 0) {
        gainElem.innerHTML = `Gain net : <span style='color: green;'>${formatted} €</span>`;
      } else {
        gainElem.innerHTML = `Gain net : <span style='color: red;'>${formatted} €</span>`;
      }
      gainElem.appendChild(imageContainer);
    }

    document.querySelectorAll("#ticketNumbersCount, #ticketStarsCount, #numTickets, #stopNumbers, #stopStars, #customGrids, #stopAfterYearsInput, #stopAfterYearsCheckbox")
      .forEach(input => {
        input.addEventListener("input", updateChanceDisplay);
      });
    updateChanceDisplay();
    document.getElementById("stopBtn").style.display = "none";

    document.getElementById("multichanceCheckbox").addEventListener("change", function() {
      const partsContainer = document.getElementById("multichancePartsContainer");
      partsContainer.style.display = this.checked ? "block" : "none";
    });

    document.getElementById("myMillonCheckbox").addEventListener("change", function() {
      document.getElementById("stopMyMillonWinGroup").style.display = this.checked ? "block" : "none";
      updateStatsDisplay();
    });

    document.getElementById("modeSelect").addEventListener("change", function() {
      const mode = this.value;
      if (mode === "flash") {
        document.getElementById("flashSettings").style.display = "block";
        document.getElementById("customSettings").style.display = "none";
        document.getElementById("ticketsCountGroup").style.display = "block";
        document.getElementById("multichanceGroup").style.display = "block";
        document.getElementById("multichancePartsContainer").style.display =
          document.getElementById("multichanceCheckbox").checked ? "block" : "none";
      } else {
        document.getElementById("flashSettings").style.display = "none";
        document.getElementById("customSettings").style.display = "block";
        document.getElementById("ticketsCountGroup").style.display = "none";
        document.getElementById("multichanceGroup").style.display = "none";
        document.getElementById("multichancePartsContainer").style.display = "none";
      }
      updateChanceDisplay();
    });

    const speedSlider = document.getElementById("speedSlider");
    const speedValueLabel = document.getElementById("speedValueLabel");

    function updateSpeedFromSlider(value) {
      const sliderVal = parseInt(value, 10);
      if (sliderVal <= 50) {
        currentBatchSize = 1;
        currentSpeed = Math.round(1000 - (sliderVal - 1) * (999 / 49));
      } else if (sliderVal <= 70) {
        let ratio = (sliderVal - 50) / 20;
        currentBatchSize = Math.round(1 + ratio * (200 - 1));
        currentSpeed = 1;
      } else {
        let ratio = (sliderVal - 70) / 30;
        currentBatchSize = Math.round(200 + ratio * (2000 - 200));
        currentSpeed = Math.round(1 - ratio * 1);
      }
      speedValueLabel.textContent = `(Tirage = ${currentBatchSize}, Délai = ${currentSpeed} ms)`;
    }

    updateSpeedFromSlider(speedSlider.value);
    speedSlider.addEventListener("input", function() {
      updateSpeedFromSlider(this.value);
    });

    function runLoop() {
      removeLooseImages();
      if (stopFlag) return;
      simulationActive = true;

      const mode = document.getElementById("modeSelect").value;
      let multichanceRatio = 1;
      if (mode === "flash" && document.getElementById("multichanceCheckbox").checked) {
        const totalParts = parseInt(document.getElementById("totalParts").value) || 0;
        const yourParts = parseInt(document.getElementById("yourParts").value) || 0;
        if (yourParts > totalParts) {
          alert("Erreur : Votre nombre de parts ne peut pas dépasser le total de parts (" + totalParts + ").");
          stopFlag = true;
          document.getElementById("startBtn").style.display = "block";
          simulationActive = false;
          return;
        }
        multichanceRatio = yourParts / totalParts;
      }
      let tickets = [];
      let draw = null;
      let customTickets = [];
      if (mode === "custom") {
        const customGridsText = document.getElementById("customGrids").value;
        customTickets = parseCustomGrids(customGridsText);
      }
      const numCount = mode === "flash"
        ? (parseInt(document.getElementById("ticketNumbersCount").value) || 5)
        : (customTickets.length > 0 ? customTickets[0].numbers.length : 5);
      const starCount = mode === "flash"
        ? (parseInt(document.getElementById("ticketStarsCount").value) || 2)
        : (customTickets.length > 0 ? customTickets[0].stars.length : 2);
      const numTickets = mode === "flash"
        ? (parseInt(document.getElementById("numTickets").value) || 1)
        : (customTickets.length > 0 ? customTickets.length : 1);

	const simpleGridsPerTicket = combination(
	  Math.max(5, Math.min(50, numCount)),
		5
      ) * combination(
      Math.max(2, Math.min(12, starCount)),
		2
      );
      const stopNumbers = parseInt(document.getElementById("stopNumbers").value) || 0;
      const stopStars = parseInt(document.getElementById("stopStars").value) || 0;
      const stopAfterYearsChecked = document.getElementById("stopAfterYearsCheckbox").checked;
      const stopAfterYearsValue = parseInt(document.getElementById("stopAfterYearsInput").value) || 100;
      const batchSize = currentBatchSize;
      const speed = currentSpeed;

      const stopMyMillonWin = document.getElementById("stopMyMillonWinCheckbox").checked;

      for (let i = 0; i < batchSize; i++) {
        count++;
        totalGrillesJouees += numTickets * simpleGridsPerTicket;
        tickets = [];
        for (let j = 0; j < numTickets; j++) {
          if (mode === "flash") {
            tickets.push(generateTicket(numCount, starCount));
          } else {
            if (customTickets.length > 0) {
              tickets.push(customTickets[j % customTickets.length]);
            }
          }
        }
        if (mode === "flash") {
          let costPerTicket = simpleGridsPerTicket * ticketCost;
          if (document.getElementById("multichanceCheckbox").checked) {
            costPerTicket *= multichanceRatio;
          }
          balance -= numTickets * costPerTicket;
        } else {
          tickets.forEach(ticket => {
            balance -= costOfTicket(ticket);
          });
        }
        draw = generateDraw();

        // Gestion de l'option My Millon
        let myMillionJustWon = false;
        if (document.getElementById("myMillonCheckbox").checked) {
          let possibilities = (count % 2 === 0) ? 4000000 : 8000000;
          let assignedRanges = [];
          tickets.forEach(ticket => {
            let n = ticket.numbers.length;
            let s = ticket.stars.length;
            let numGrilles = combination(n, 5) * combination(s, 2);
            if (numGrilles > 1) {
              let baseNumber;
              let attempt = 0;
              const maxAttempts = 100;
              do {
                baseNumber = Math.floor(Math.random() * (possibilities - numGrilles + 1)) + 1;
                attempt++;
                var conflict = assignedRanges.some(range =>
                  baseNumber <= range.end && (baseNumber + numGrilles - 1) >= range.start
                );
              } while (conflict && attempt < maxAttempts);
              let rangeEnd = baseNumber + numGrilles - 1;
              assignedRanges.push({ start: baseNumber, end: rangeEnd });
              ticket.myMillon = baseNumber + " à " + rangeEnd;
            } else {
              let candidate;
              let attempt = 0;
              const maxAttempts = 100;
              do {
                candidate = Math.floor(Math.random() * possibilities) + 1;
                attempt++;
                var conflict = assignedRanges.some(range =>
                  candidate >= range.start && candidate <= range.end
                );
              } while (conflict && attempt < maxAttempts);
              assignedRanges.push({ start: candidate, end: candidate });
              ticket.myMillon = candidate;
            }
          });
          draw.myMillon = Math.floor(Math.random() * possibilities) + 1;

          let myMillonWin = tickets.some(ticket => {
            if (typeof ticket.myMillon === "string" && ticket.myMillon.includes(" à ")) {
              let [start, end] = ticket.myMillon.split(" à ").map(Number);
              return draw.myMillon >= start && draw.myMillon <= end;
            } else {
              return ticket.myMillon === draw.myMillon;
            }
          });

          if (myMillonWin) {
            myMillionWinCount++;
            let myMillonPrize = 1000000;
            if (document.getElementById("multichanceCheckbox").checked) {
              const totalParts = parseInt(document.getElementById("totalParts").value) || 1;
              const yourParts = parseInt(document.getElementById("yourParts").value) || 1;
              myMillonPrize = 1000000 * (yourParts / totalParts);
            }
            balance += myMillonPrize;
            myMillionTotalGain += myMillonPrize;
            updateStatsDisplay();

            myMillionJustWon = true;
            if (stopMyMillonWin) {
              alert("Option My Millon gagnée !\nTirage My Million : " + draw.myMillon + "\nGain : " + myMillonPrize.toLocaleString('de-DE', { maximumFractionDigits: 0 }) + " €");

              if (balance >= 1) {
                playSound("win.mp3");
              } else if (balance <= -1000000) {
                playSound("bigloose.mp3");
                addLooseImage("bigloose.jpeg");
              } else {
                playSound("loose.mp3");
                addLooseImage("loose.png");
              }

              stopFlag = true;
              simulationActive = false;
              document.getElementById("startBtn").style.display = "block";
              document.getElementById("ticketsContainer").innerHTML = "";
              tickets.forEach((ticket, index) => {
                const div = document.createElement("div");
                let isWinning = false;
                if (typeof ticket.myMillon === "string" && ticket.myMillon.includes(" à ")) {
                  let [start, end] = ticket.myMillon.split(" à ").map(Number);
                  if (draw.myMillon >= start && draw.myMillon <= end) {
                    isWinning = true;
                  }
                } else if (ticket.myMillon === draw.myMillon) {
                  isWinning = true;
                }
                div.className = "ticket" + (isWinning ? " winning" : "");
                const highlightedNums = highlightMatches(ticket.numbers, draw.numbers);
                const highlightedStars = highlightMatches(ticket.stars, draw.stars);
                let myMillionDisplay = ticket.myMillon;
                if (isWinning) {
                  myMillionDisplay = `<span style="color: green; font-weight: bold;">${ticket.myMillon}</span>`;
                }
                div.innerHTML = `<strong>Ticket ${index + 1} :</strong><br>
                                 Numéros : ${highlightedNums}<br>
                                 Étoiles : ${highlightedStars}<br>
                                 My Million : ${myMillionDisplay}`;
                document.getElementById("ticketsContainer").appendChild(div);
              });
              document.getElementById("resultat").innerHTML =
                `<strong>Tirage :</strong><br>
                 Numéros : ${draw.numbers.join(", ")}<br>
                 Étoiles : ${draw.stars.join(", ")}<br>
                 My Million : ${draw.myMillon}`;
              document.getElementById("counter").textContent = "Tirages : " + count.toLocaleString('de-DE');
              document.getElementById("grillesPlayed").textContent = "Grilles jouées : " + totalGrillesJouees.toLocaleString('de-DE');
              updateTimePassed(count);
              updateStatsDisplay();
              updateGainDisplay();
              return;
            }
          }
        }
        // --- (le reste du code runLoop inchangé) ---

        // Check arrêt par années
        if (stopAfterYearsChecked) {
          const currentYears = (count * 3.5) / 365;
          if (currentYears >= stopAfterYearsValue) {
            document.getElementById("ticketsContainer").innerHTML = "";
            document.getElementById("resultat").innerHTML =
              `<strong>Tirage :</strong><br>
               Numéros : ${draw.numbers.join(", ")}<br>
               Étoiles : ${draw.stars.join(", ")}${document.getElementById("myMillonCheckbox").checked ? "<br>My Million : " + draw.myMillon : ""}`;
            document.getElementById("counter").textContent = "Tirages : " + count.toLocaleString('de-DE');
            document.getElementById("grillesPlayed").textContent = "Grilles jouées : " + totalGrillesJouees.toLocaleString('de-DE');
            updateTimePassed(count);
            updateStatsDisplay();
            updateGainDisplay();
            alert("On a dépassé les " + stopAfterYearsValue + " ans de simulation !\n(Nombre de tirages : " + count.toLocaleString('de-DE') + ")");

            if (balance >= 1) {
              playSound("win.mp3");
            } else if (balance <= -1000000) {
              playSound("bigloose.mp3");
              addLooseImage("bigloose.jpeg");
            } else {
              playSound("loose.mp3");
              addLooseImage("loose.png");
            }

            stopFlag = true;
            simulationActive = false;
            document.getElementById("startBtn").style.display = "block";
            return;
          }
        }

	let foundWinningTicket = false;
	let winningTicket = null;
	tickets.forEach(ticket => {
	  const n = ticket.numbers.length;
	  const s = ticket.stars.length;

	  const numGood = countMatches(ticket.numbers, draw.numbers);
	  const numBad = n - numGood;
	  const starGood = countMatches(ticket.stars, draw.stars);
	  const starBad = s - starGood;

	  // Pour chaque possibilité de bons numéros (0 à 5) et étoiles (0 à 2)
	  for (let nb = 0; nb <= Math.min(5, n); nb++) {
		for (let sb = 0; sb <= Math.min(2, s); sb++) {
		  // Combien de grilles simples (dans la grille multiple) font nb bons numéros et sb bonnes étoiles
		  const waysNum = combination(numGood, nb) * combination(numBad, 5 - nb);
		  const waysStar = combination(starGood, sb) * combination(starBad, 2 - sb);
		  const countGrilles = waysNum * waysStar;
		  if (countGrilles > 0) {
			const key = nb + "_" + sb;
			if (stats.hasOwnProperty(key)) stats[key] += countGrilles;
			let prize = prizeMapping[key] || 0;
			if (document.getElementById("multichanceCheckbox").checked) {
			  prize *= multichanceRatio;
			}
			balance += prize * countGrilles;
			statsGain[key] += prize * countGrilles;

			// Si au moins UNE des grilles simples franchit le seuil d'arrêt, on considère le ticket "gagnant" (pour l'affichage, l'alerte, etc)
			if (!foundWinningTicket && nb >= stopNumbers && sb >= stopStars && countGrilles > 0) {
			  foundWinningTicket = true;
			  winningTicket = ticket;
			}
		  }
		}
	  }
	});


        if (foundWinningTicket) {
          document.getElementById("ticketsContainer").innerHTML = "";
          tickets.forEach((ticket, index) => {
            const div = document.createElement("div");
            div.className = "ticket";
            const highlightedNums = highlightMatches(ticket.numbers, draw.numbers);
            const highlightedStars = highlightMatches(ticket.stars, draw.stars);
            div.innerHTML = `<strong>Ticket ${index + 1} :</strong><br>
                             Numéros : ${highlightedNums}<br>
                             Étoiles : ${highlightedStars}${document.getElementById("myMillonCheckbox").checked ? "<br>My Million : " + ticket.myMillon : ""}`;
            if (ticket === winningTicket) {
              div.classList.add("winning");
            }
            document.getElementById("ticketsContainer").appendChild(div);
          });
          document.getElementById("resultat").innerHTML =
            `<strong>Tirage :</strong><br>
             Numéros : ${draw.numbers.join(", ")}<br>
             Étoiles : ${draw.stars.join(", ")}${document.getElementById("myMillonCheckbox").checked ? "<br>My Million : " + draw.myMillon : ""}`;
          document.getElementById("counter").textContent = "Tirages : " + count.toLocaleString('de-DE');
          document.getElementById("grillesPlayed").textContent = "Grilles jouées : " + totalGrillesJouees.toLocaleString('de-DE');
          updateTimePassed(count);
          updateStatsDisplay();
          updateGainDisplay();

          const winningMatchNumbers = countMatches(winningTicket.numbers, draw.numbers);
          const winningMatchStars = countMatches(winningTicket.stars, draw.stars);
          const winningKey = winningMatchNumbers + "_" + winningMatchStars;
          let winningGain = prizeMapping[winningKey] || 0;
          if (document.getElementById("multichanceCheckbox").checked) {
            winningGain *= multichanceRatio;
          }
          if (winningMatchNumbers === 5 && winningMatchStars === 2) {
            launchFireworks();
          }
          alert("Seuil atteint !\n" +
                "Ticket gagnant : " + winningTicket.numbers.join(", ") + " | " + winningTicket.stars.join(", ") + "\n" +
                "Tirage : " + draw.numbers.join(", ") + " | " + draw.stars.join(", ") + "\n" +
                "Nombre de tirages : " + count.toLocaleString('de-DE') + "\n" +
                "Gain : " + winningGain.toLocaleString('de-DE', { maximumFractionDigits: 0 }) + " €");

          if (balance >= 1) {
            playSound("win.mp3");
            } else if (balance <= -1000000) {
              playSound("bigloose.mp3");
              addLooseImage("bigloose.jpeg");
            } else {
              playSound("loose.mp3");
              addLooseImage("loose.png");
            }

          stopFlag = true;
          simulationActive = false;
          document.getElementById("startBtn").style.display = "block";
          return;
        }

        if (document.getElementById("stopNegativeGainCheckbox").checked) {
          const negThreshold = parseFloat(document.getElementById("stopNegativeGainThreshold").value) || 0;
          if (balance < -negThreshold) {
            document.getElementById("ticketsContainer").innerHTML = "";
            document.getElementById("resultat").innerHTML =
              `<strong>Tirage :</strong><br>
               Numéros : ${draw.numbers.join(", ")}<br>
               Étoiles : ${draw.stars.join(", ")}${document.getElementById("myMillonCheckbox").checked ? "<br>My Million : " + draw.myMillon : ""}`;
            document.getElementById("counter").textContent = "Tirages : " + count.toLocaleString('de-DE');
            document.getElementById("grillesPlayed").textContent = "Grilles jouées : " + totalGrillesJouees.toLocaleString('de-DE');
            updateTimePassed(count);
            updateStatsDisplay();
            updateGainDisplay();
            alert("Le gain net est inférieur au seuil défini (-" + negThreshold + " €). La simulation est arrêtée.");

            if (balance >= 1) {
              playSound("win.mp3");
            } else if (balance <= -1000000) {
              playSound("bigloose.mp3");
              addLooseImage("bigloose.jpeg");
            } else {
              playSound("loose.mp3");
              addLooseImage("loose.png");
            }

            stopFlag = true;
            simulationActive = false;
            document.getElementById("startBtn").style.display = "block";
            return;
          }
        }
      }

      document.getElementById("ticketsContainer").innerHTML = "";
      tickets.forEach((ticket, index) => {
        const div = document.createElement("div");
        div.className = "ticket";
        const highlightedNums = highlightMatches(ticket.numbers, draw.numbers);
        const highlightedStars = highlightMatches(ticket.stars, draw.stars);
        div.innerHTML = `<strong>Ticket ${index + 1} :</strong><br>
                         Numéros : ${highlightedNums}<br>
                         Étoiles : ${highlightedStars}${document.getElementById("myMillonCheckbox").checked ? "<br>My Million : " + ticket.myMillon : ""}`;
        document.getElementById("ticketsContainer").appendChild(div);
      });
      document.getElementById("resultat").innerHTML =
        `<strong>Tirage :</strong><br>
         Numéros : ${draw.numbers.join(", ")}<br>
         Étoiles : ${draw.stars.join(", ")}${document.getElementById("myMillonCheckbox").checked ? "<br>My Million : " + draw.myMillon : ""}`;
      document.getElementById("counter").textContent = "Tirages : " + count.toLocaleString('de-DE');
      document.getElementById("grillesPlayed").textContent = "Grilles jouées : " + totalGrillesJouees.toLocaleString('de-DE');
      updateTimePassed(count);
      updateStatsDisplay();
      updateGainDisplay();

      loopTimeout = setTimeout(runLoop, speed);
    }

    function startDrawing() {
      if (document.getElementById("modeSelect").value === "flash" && document.getElementById("multichanceCheckbox").checked) {
        const totalParts = parseInt(document.getElementById("totalParts").value) || 0;
        const yourParts = parseInt(document.getElementById("yourParts").value) || 0;
        if (yourParts > totalParts) {
          alert("Erreur : Votre nombre de parts (" + yourParts + ") ne peut pas dépasser le total de parts (" + totalParts + ").");
          return;
        }
      }
      clearTimeout(loopTimeout);
      count = 0;
      stopFlag = false;
      balance = 0;
      totalGrillesJouees = 0;
      for (let combo in stats) {
        stats[combo] = 0;
        statsGain[combo] = 0;
      }
      myMillionWinCount = 0;
      myMillionTotalGain = 0;
      simulationActive = true;
      document.getElementById("counter").textContent = "Tirages : 0";
      document.getElementById("grillesPlayed").textContent = "Grilles jouées : 0";
      document.getElementById("timePassed").textContent = "Temps écoulé : 0 jour";
      document.getElementById("gainDisplay").innerHTML = "<span style='color: green;'>Gain net : 0,00 €</span>";
      document.getElementById("ticketsContainer").innerHTML = "";
      document.getElementById("resultat").innerHTML = `<strong>Tirage :</strong><br>Numéros : --<br>Étoiles : --`;
      document.getElementById("stopBtn").textContent = "Stop";
      updateStatsDisplay();
      updateTimePassed(0);
      updateGainDisplay();
      removeLooseImages();
      document.getElementById("startBtn").style.display = "none";
      document.getElementById("stopBtn").style.display = "inline-block";
      runLoop();
    }

    document.getElementById("myMillonCheckbox").checked = true;
    document.getElementById("stopMyMillonWinCheckbox").checked = false;
    document.getElementById("stopMyMillonWinGroup").style.display = "block";

    document.getElementById("startBtn").addEventListener("click", startDrawing);
    document.getElementById("stopBtn").addEventListener("click", function() {
      if (!stopFlag) {
        stopFlag = true;
        simulationActive = false;
        clearTimeout(loopTimeout);
        this.textContent = "Continuer";
      } else {
        stopFlag = false;
        simulationActive = true;
        this.textContent = "Stop";
        runLoop();
      }
      updateStatsDisplay();
    });
    document.getElementById("resetBtn").addEventListener("click", function() {
      stopFlag = true;
      clearTimeout(loopTimeout);
      count = 0;
      totalGrillesJouees = 0;
      for (let combo in stats) {
        stats[combo] = 0;
        statsGain[combo] = 0;
      }
      myMillionWinCount = 0;
      myMillionTotalGain = 0;
      simulationActive = false;
      updateStatsDisplay();
      document.getElementById("counter").textContent = "Tirages : 0";
      document.getElementById("grillesPlayed").textContent = "Grilles jouées : 0";
      document.getElementById("timePassed").textContent = "Temps écoulé : 0 jour";
      document.getElementById("gainDisplay").innerHTML = "<span style='color: green;'>Gain net : 0,00 €</span>";
      document.getElementById("ticketsContainer").innerHTML = "";
      document.getElementById("resultat").innerHTML = `<strong>Tirage :</strong><br>Numéros : --<br>Étoiles : --`;
      document.getElementById("stopBtn").textContent = "Stop";
      document.getElementById("startBtn").style.display = "block";
      document.getElementById("stopBtn").style.display = "none";
      removeLooseImages();
    });

    // Initialisation pour cacher/montrer la ligne au chargement
    updateStatsDisplay();
	
	document.getElementById("ticketStarsCount").addEventListener("blur", function() {
	  let v = parseInt(this.value) || 2;
	  if (v < 2) v = 2;
	  if (v > 12) v = 12;
	  this.value = v;
	});
	document.getElementById("ticketNumbersCount").addEventListener("blur", function() {
	  let v = parseInt(this.value) || 5;
	  if (v < 5) v = 5;
	  if (v > 50) v = 50;
	  this.value = v;
	});
  </script>
</body>
</html>
