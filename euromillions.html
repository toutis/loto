<!DOCTYPE html>
<html lang="fr">

<head>
	<!-- Projet sous licence MIT – Voir fichier LICENSE.
	Simulation pédagogique et indépendante, sans affiliation ni approbation de la Française des Jeux (FDJ).
	Aucune mise réelle, aucun gain, aucune collecte de données personnelles. -->
	<meta charset="UTF-8">
	<title>Simulateur Euro Millions</title>
	<meta name="description"
		content="Simulateur pédagogique Euro Millions : générez des grilles aléatoires ou personnalisées, suivez vos statistiques de tirage et visualisez vos gains sans enjeu réel.">
	<script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
	<link rel="shortcut icon" type="image/x-icon" href="favicon.ico">
	<style>
		body {
			font-family: Arial, sans-serif;
			margin: 0px;
			padding-left: 30px;
			padding-right: 30px;
		}

		.main-container {
			max-width: 1200px;
			margin: 0 auto;
			display: flex;
			justify-content: space-between;
			align-items: flex-start;
			flex-wrap: wrap;
			gap: 10px;
		}

		.left-column {
			flex: 1;
			max-width: 45%;
			text-align: left;
		}

		.right-column {
			flex: 1;
			max-width: 45%;
			text-align: left;
		}

		.form-group,
		.display,
		.compteur {
			font-size: 1.1em;
			margin: 10px 0;
		}

		input,
		button,
		select,
		textarea {
			padding: 6px 12px;
			font-size: 1em;
			margin: 5px;
		}

		.ticket {
			border: 1px solid #aaa;
			padding: 8px;
			margin: 5px 0;
			width: fit-content;
		}

		.winning {
			background-color: #cfc;
		}

		#chanceDisplay {
			font-weight: bold;
			margin: 10px 0;
		}

		#resultat {
			border: 2px solid gold;
			padding: 10px;
			margin: 10px 0;
		}

		#statsContainer {
			margin-top: 20px;
		}

		#statsContainer ul {
			list-style: none;
			padding: 0;
		}

		#statsContainer li {
			margin: 5px 0;
		}

		#multichanceAndMyMillonContainer {
			display: flex;
			align-items: center;
		}

		.info-icon {
			display: inline-block;
			width: 16px;
			height: 16px;
			border-radius: 50%;
			background-color: #ccc;
			text-align: center;
			line-height: 16px;
			font-size: 12px;
			margin-left: 5px;
			cursor: help;
		}

		#speedControlGroup {
			display: flex;
			align-items: center;
			justify-content: flex-start;
			gap: 10px;
			margin: 10px 0;
		}

		#speedValueLabel {
			color: gray;
		}

		#fireworksContainer {
			position: fixed;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			pointer-events: none;
			z-index: 9999;
		}

		.firework {
			position: absolute;
			width: 4px;
			height: 4px;
			background: radial-gradient(circle, var(--color) 0%, var(--color-dark) 70%);
			border-radius: 50%;
			opacity: 1;
			animation: firework 2.0s ease-out forwards;
			box-shadow: 0 0 15px var(--color);
		}

		@keyframes firework {
			0% {
				transform: scale(1);
				opacity: 1;
			}

			50% {
				opacity: 1;
			}

			100% {
				transform: translate(var(--tx), var(--ty)) scale(3);
				opacity: 0;
			}
		}

		.sound-toggle {
			cursor: pointer;
			margin-left: 0px;
			font-size: 24px;
			vertical-align: middle;
		}

		.sound-toggle span {
			display: inline-block;
		}

		.icons-bar {
			display: inline-flex;
			align-items: center;
			gap: 4px;
		}

		#stopMyMillonWinGroup {
			margin-left: 22px;
			margin-top: 0;
			font-size: 0.95em;
			display: none;
		}

		.number-ball,
		.star-ball {
			display: inline-flex;
			justify-content: center;
			align-items: center;
			width: 30px;
			height: 30px;
			margin: 2px 0px;
			font-size: .85em;
			font-weight: bold;
			color: #fff;
			position: relative;
			vertical-align: middle;
			user-select: none;
		}

		.number-ball {
			background: #047dff;
			border-radius: 50%;
		}

		.star-ball {
			display: inline-flex;
			justify-content: center;
			align-items: center;
			width: 36px;
			height: 36px;
			font-size: .85em !important;
			font-family: Arial, sans-serif !important;
			font-weight: bold !important;
			position: relative;
			z-index: 1;
		}

		.star-ball::before {
			content: "";
			position: absolute;
			left: 0;
			top: 0;
			right: 0;
			bottom: 0;
			background: #f5c518;
			z-index: -1;
			clip-path: polygon(50% 5%, 62% 34%, 98% 36%, 69% 57%,
					79% 92%, 50% 74%, 21% 92%, 31% 57%,
					2% 36%, 38% 34%);
		}

		.match {
			opacity: 1 !important;
		}

		.semi {
			opacity: 0.45;
		}

		#ticketsContainer {}

		#ticketsContainer .ticket {
			display: inline-block;
			margin: 6px 0;
			box-sizing: border-box;
		}

		#ticketsContainer.cols-2 {
			display: grid;
			grid-template-columns: repeat(2, minmax(320px, 1fr));
			gap: 12px;
		}

		#ticketsContainer.cols-2 .ticket {
			display: block;
			width: 100%;
			margin: 0;
		}

		.display-toggle {
			cursor: pointer;
			margin-left: 0px;
			font-size: 24px;
			user-select: none;
			vertical-align: middle;
		}

		body.plain-display .number-ball,
		body.plain-display .star-ball {
			background: none !important;
			color: #111 !important;
			font-family: inherit !important;
			font-size: inherit !important;
			font-weight: normal !important;
			letter-spacing: 0 !important;
			border-radius: 0 !important;
			box-shadow: none !important;
			width: auto !important;
			height: auto !important;
			padding: 0 2px !important;
			margin: 0 2px !important;
			opacity: 1 !important;
			vertical-align: baseline !important;
		}

		body.plain-display .number-ball.semi,
		body.plain-display .star-ball.semi {
			color: #111 !important;
			opacity: 1 !important;
		}

		body.plain-display .number-ball.match,
		body.plain-display .star-ball.match {
			color: #159f13 !important;
			font-weight: bold !important;
			opacity: 1 !important;
		}

		body.plain-display .star-ball::before {
			display: none !important;
		}

		body.plain-display .number-ball,
		body.plain-display .star-ball {
			font-family: inherit !important;
			font-size: inherit !important;
			margin-right: 0 !important;
			word-spacing: 0 !important;
		}

		body.plain-display .number-ball,
		body.plain-display .star-ball {
			display: inline-block !important;
		}

		body.plain-display .number-ball,
		body.plain-display .star-ball {
			letter-spacing: 0 !important;
		}

		body.plain-display .ticket span {
			font-family: inherit !important;
			font-size: inherit !important;
		}

		body.plain-display .ticket {
			font-family: inherit;
			font-size: inherit;
			word-spacing: 0 !important;
		}

		body.plain-display .number-ball.match,
		body.plain-display .star-ball.match,
		body.plain-display .match {
			color: #159f13 !important;
			font-weight: bold !important;
			opacity: 1 !important;
		}

		.compteur {
			white-space: nowrap;
		}

		@media (max-width: 785px) {
			.main-container {
				flex-direction: column;
			}

			.left-column,
			.right-column {
				max-width: 100%;
			}
		}

		#prizesForm {
			display: grid;
			grid-template-columns: repeat(2, 1fr);
			gap: 10px 20px;
			max-height: 80vh;
			overflow-y: auto;
		}

		#prizesForm div {
			display: flex;
			justify-content: space-between;
			align-items: center;
			gap: 10px;
		}

		#prizesForm label {
			flex: 1;
			text-align: right;
			white-space: nowrap;
		}

		#prizesForm input {
			flex: 0 0 100px;
		}

		#examplesModal {
			display: none;
			position: fixed;
			top: 50%;
			left: 50%;
			transform: translate(-50%, -50%);
			background: #fff;
			padding: 20px;
			border: 2px solid #444;
			box-shadow: 0 0 20px rgba(0, 0, 0, .3);
			z-index: 10000;
			width: 500px;
			max-height: none;
			overflow-y: auto;
		}

		#examplesModal ul li {
			margin-bottom: 0.7em;
		}

		#examplesModal ul {
			list-style: none;
			padding-left: 0;
		}
	</style>
</head>

<body>
	<div class="main-container">
		<div class="left-column">
			<h1>
				Simulation Euro Millions
				<span class="icons-bar">
					<span id="soundToggle" class="sound-toggle">

					</span>

					<span id="displayToggle" class="display-toggle"
						title="Basculer l’affichage des boules / affichage texte">

					</span>
				</span>
			</h1>

			<div class="section">
				<div class="form-group">
					<label for="modeSelect">Mode :</label>
					<select id="modeSelect">
						<option value="flash" selected>Flash (tickets aléatoires)</option>
						<option value="custom">Personnalisé (définir mes propres grilles)</option>
					</select>
				</div>
				<div class="form-group" id="flashSettings">
					<label for="ticketNumbersCount">Nombre de numéros (min 5, max 50) :</label>
					<input type="number" id="ticketNumbersCount" value="5" min="5" max="50"><br>
					<label for="ticketStarsCount">Nombre d'étoiles (min 2, max 12) :</label>
					<input type="number" id="ticketStarsCount" value="2" min="2" max="12">
				</div>
				<div class="form-group" id="customSettings" style="display:none;">
					<label for="customGrids">
						Mes grilles personnalisées :<br>
						• Grille complète : <em>1,2,3,4,5 ; 1,2</em><br>
						• Ou bien : identifiant unique, ex. <em>12345678</em>
					</label>
					<br>
					<textarea id="customGrids" rows="4" cols="42" placeholder="Une grille par ligne"></textarea>
					<div
						style="margin-top: 2px; display: flex; align-items: center; gap: 4px; font-size: 1em; padding-bottom: 6px;">
						<label for="nbGrillesAuto">Générer x grilles :</label>
						<input type="number" id="nbGrillesAuto" value="3" min="1" max="100"
							style="width: 50px; padding: 3px 6px; font-size: 1em;">
						<button id="generateGridsBtn" style="padding: 4px 10px; font-size: 0.9em;">Générer</button>
						<button id="clearCustomGridsBtn" style="padding: 4px 10px; font-size: 0.9em;">Clear</button>
					</div>
				</div>
				<div class="form-group" id="ticketsCountGroup" style="display: flex; align-items: center; gap: 12px;">
				  <label for="numTickets">Nombre de tickets par tirage :</label>
				  <input type="number" id="numTickets" value="1" min="1" style="width: 60px;">
				  <span id="priceDisplay" style="color: gray; font-weight: normal;">Prix : -- €</span>
				</div>
				<div class="form-group" style="align-items: center; gap: 8px;">
					<label for="stopNumbers" style="margin-right: 6px;">
						Stopper si au moins&nbsp;X numéros corrects&nbsp;:
					</label>
					<input type="number" id="stopNumbers" value="5" min="0" max="5" style="width: 37px;">
					<input type="number" id="stopStars" value="2" min="0" max="2" style="width: 37px;">
				</div>
				<div class="form-group">
					<input type="checkbox" id="stopAfterYearsCheckbox">
					<label for="stopAfterYearsCheckbox">Stopper si on dépasse X années :</label>
					<input type="number" id="stopAfterYearsInput" value="50" min="1" style="width:80px;">
				</div>
				<div class="form-group">
				  <input type="checkbox" id="stopNegativeGainCheckbox">
				  <label for="stopNegativeGainCheckbox">Stopper si le solde est à :</label>
				  <input
					type="number"
					id="stopNegativeGainThreshold"
					value="-10000"
					step="0.01"
					style="width:100px;"
					title="Pour un seuil positif, saisir +1000 ou 1000 ; pour un seuil négatif, saisir -10000">
				</div>
				<div class="form-group" id="speedControlGroup">
					<label for="speedSlider">Vitesse :</label>
					<input type="range" id="speedSlider" min="1" max="100" value="50" list="tickmarks">
					<datalist id="tickmarks">
						<option value="50" label="50%"></option>
					</datalist>
					<span id="speedValueLabel">(Tirage = 1, Délai = 1000 ms)</span>
				</div>

				<div style="display: flex; align-items: center; gap: 20px; margin-bottom: 10px;">
					<div>
						<input type="checkbox" id="myMillonCheckbox" checked>
						<label for="myMillonCheckbox">
							My Million <span class="info-icon" title="L'option My Millon : Chaque mardi en France, environ 4 millions de grilles sont jouées, et 6 millions le vendredi.
À chaque tirage, un numéro aléatoire est attribué parmi l'ensemble des grilles jouées.

Le gagnant dont le numéro correspond exactement à celui du tirage remporte 1 000 000 € !">i</span>
						</label>
					</div>

					<div>
						<input type="checkbox" id="multichanceCheckbox">
						<label for="multichanceCheckbox">
							Multichance <span class="info-icon" title="L'option MultiÉtoiles : Il permet de réduire votre mise en répartissant votre investissement sur plusieurs parts.
Cela diminue le coût par ticket, mais réduit également les gains proportionnellement au nombre de parts détenues.
Cette option est utilisée seulement avec une dizaine de grilles multiples.

Exemple : 10 grilles multiples (7 numéros, 4 étoiles), 1 à 10 parts sur 420">i</span>
						</label>
					</div>

					<div>
						<input type="checkbox" id="smartDrawCheckbox">
						<label for="smartDrawCheckbox">
							Grille optimisée
							<span class="info-icon" title="Active une stratégie de sélection basée sur la rareté.

Les numéros et étoiles les moins souvent tirés au cours des 70 derniers tirages 
sont privilégiés, dans l’espoir qu’ils soient « en retard ». Cela repose sur 
l’idée de compenser une sous-fréquence apparente.

⚠️ En réalité, chaque tirage est totalement indépendant des précédents, 
et tous les numéros ont toujours exactement la même probabilité de sortir.
Cette méthode n'augmente donc pas objectivement vos chances.">i</span>

						</label>

					</div>
				</div>

				<div style="margin-top:8px;">
					<input type="checkbox" id="showCombinationNumber">
					<label for="showCombinationNumber">
						Identifiant unique
						<span class="info-icon" title="Afficher pour chaque grille ou tirage son identifiant unique.
Permet d’identifier précisément une combinaison parmi les 139 838 161 possibles à l'euro millions.

Utile pour analyser, comparer, et réaliser le nombre immense de combinaisons possibles.">
							i
						</span>
						</span>
					</label>
				</div>

				<div class="form-group" id="stopMyMillonWinGroup"
					style="margin-left: 0px; margin-bottom: 0px; margin-top: 5px;">
					<input type="checkbox" id="stopMyMillonWinCheckbox">
					<label for="stopMyMillonWinCheckbox">Stopper si on gagne le my million</label>
				</div>

				<div id="smartDrawSettings" style="margin-left: 22px; margin-top: 0px; display: none;">
					<label for="rareNumbersCount">Nb de numéros rares (0 à 5) :</label>
					<input type="number" id="rareNumbersCount" value="3" min="0" max="5" style="width: 60px;"><br>
					<label for="rareStarsCount">Nb d'étoiles rares (0 à 2) :</label>
					<input type="number" id="rareStarsCount" value="1" min="0" max="2" style="width: 60px;">
				</div>

				<div class="form-group" id="multichancePartsContainer" style="display:none; margin-left:20px;">
					<label for="totalParts">Total de parts :</label>
					<input type="number" id="totalParts" value="420" min="1"><br>
					<label for="yourParts">Votre nombre de parts :</label>
					<input type="number" id="yourParts" value="1" min="1">
				</div>
				<div style="display: inline-flex; gap: 10px; margin-top: 10px;">
					<button id="startBtn">Démarrer la simulation</button>
					<button id="stopBtn">Stop</button>
					<button id="resetBtn">Reset</button>
				</div>
			</div>
		</div>
		<div class="right-column">
			<div id="chanceDisplay"></div>
			<div class="section display" id="resultat">
				<strong>Tirage :</strong><br>
				Numéros : --<br>
				Étoiles : --<br>
			</div>
			<div class="compteur" id="counter">Tirages : 0</div>
			<div class="compteur" id="timePassed">Temps écoulé : 0 jour</div>
			<div class="compteur" id="grillesPlayed">Grilles jouées : 0</div>
			<div class="compteur" id="gainDisplay">Solde : 0 €</div>
			<div class="section display" id="ticketsContainer"></div>
			<canvas id="gainChart" height="150"></canvas>
			<div class="section display" id="statsContainer">
				<h3 style="margin-bottom: 0;">
					Statistiques de résultats
					<span class="info-icon" title="Les gains par rang sont fixes et déterminés à l’avance dans cette simulation. 
Il n’y a pas de partage avec d’autres joueurs, ni de cumul de jackpots etc.">i</span>
				</h3>
					<a href="#" id="editPrizesLink" style="color: #187ad2; font-size: 0.95em;">Modifier les gains par rang</a> | 
					<a href="#" id="showDetails" style="color: #187ad2; font-size: 0.95em;">voir plus de détails</a>
				<ul>
					<div id="gainLossSummary" style="margin:12px 0 8px 0;">
						<div>
							<span style="color:#222; font-weight:normal; margin-right:4px;">Bilan&nbsp;:</span>
							<span id="spentValue"></span>
							<span style="margin:0 4px; color:#888;">/</span>
							<span id="gainValue"></span>
							<span id="percentValue" style="margin-left:4px;"></span>
						</div>
						<div style="height:7px;"></div>
					</div>
					<li id="stats_myMillion" style="display: list-item;">
						My Million : <span id="stats_myMillion_value">0</span>
						<span id="stats_myMillion_pct"></span>
						<span id="stats_myMillion_gain"></span>
					</li>
					<li>5 n° + 2 ★ : <span id="stats_5_2">0</span></li>
					<li>5 n° + 1 ★ : <span id="stats_5_1">0</span></li>
					<li>5 n° + 0 ★ : <span id="stats_5_0">0</span></li>
					<li>4 n° + 2 ★ : <span id="stats_4_2">0</span></li>
					<li>4 n° + 1 ★ : <span id="stats_4_1">0</span></li>
					<li>4 n° + 0 ★ : <span id="stats_4_0">0</span></li>
					<li>3 n° + 2 ★ : <span id="stats_3_2">0</span></li>
					<li>3 n° + 1 ★ : <span id="stats_3_1">0</span></li>
					<li>3 n° + 0 ★ : <span id="stats_3_0">0</span></li>
					<li>2 n° + 2 ★ : <span id="stats_2_2">0</span></li>
					<li>2 n° + 1 ★ : <span id="stats_2_1">0</span></li>
					<li>2 n° + 0 ★ : <span id="stats_2_0">0</span></li>
					<li>1 n° + 2 ★ : <span id="stats_1_2">0</span></li>
					<li>1 n° + 1 ★ : <span id="stats_1_1">0</span></li>
					<li>1 n° + 0 ★ : <span id="stats_1_0">0</span></li>
					<li>0 n° + 2 ★ : <span id="stats_0_2">0</span></li>
					<li>0 n° + 1 ★ : <span id="stats_0_1">0</span></li>
					<li>0 n° + 0 ★ : <span id="stats_0_0">0</span></li>
				</ul>
			</div>
		</div>
	</div>
	<div id="fireworksContainer"></div>
	<div id="prizesModal" style="display:none; position: fixed; top: 50%; left: 50%;
	transform: translate(-50%, -50%); background: white; padding: 20px;
	border: 2px solid #444; z-index: 10000; width: 640px; max-height: none;
	overflow-y: visible; box-shadow: 0 0 20px rgba(0,0,0,0.3);">
		<h3>Modifier les gains par rang</h3>
		<form id="prizesForm"></form>
		<div style="margin-top: 10px;">
			<button id="closePrizesBtn" type="button">❌ Fermer</button>
			<button id="resetPrizesBtn" type="button">🔄 Reset</button>
		</div>
	</div>
	<div id="modalOverlay"
		style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.5); z-index: 9999;">
	</div>
	<div id="examplesModal">
		<div id="examplesContent"></div>

		<div style="margin-top:10px">
			<button id="closeExamplesBtn" type="button">❌ Fermer</button>
		</div>
	  </div> 
  <div id="detailsModal" style="display:none; position:fixed; top:50%; left:50%;
       transform:translate(-50%,-50%); background:#fff; padding:20px;
       border:2px solid #444; box-shadow:0 0 20px rgba(0,0,0,0.3); z-index:10001; width:400px; max-height:80vh; overflow-y:auto;">
    <h3>Détails des paliers obtenus</h3>
    <ul id="detailsList" style="padding-left:1em;"></ul>
    <button id="closeDetailsBtn" style="margin-top:10px;">❌ Fermer</button>
  </div>
  <div id="modalOverlayDetails" style="display:none; position:fixed; top:0; left:0;
       width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:10000;"></div>
		<script>
				
		  function updatePrix() {
			const n   = parseInt(document.getElementById("ticketNumbersCount").value) || 5;
			const s   = parseInt(document.getElementById("ticketStarsCount").value) || 1;
			const nbT = parseInt(document.getElementById("numTickets").value) || 1;

			const ticketFictif = {
			  numbers: Array(n).fill(0),
			  stars:   Array(s).fill(0)
			};
			const prixUnitaire = costOfTicket(ticketFictif);
			let prixTotal     = prixUnitaire * nbT;

			const multichanceChecked = document.getElementById("multichanceCheckbox").checked;
			if (multichanceChecked) {
			  const totalParts = parseInt(document.getElementById("totalParts").value) || 1;
			  const yourParts  = parseInt(document.getElementById("yourParts").value)  || 0;
			  if (yourParts > 0 && yourParts <= totalParts) {
				const ratio = yourParts / totalParts;
				prixTotal = prixTotal * ratio;
			  }
			}

			const affichage = prixTotal.toLocaleString("fr-FR", {
			  minimumFractionDigits: 2,
			  maximumFractionDigits: 2
			});
			document.getElementById("priceDisplay").textContent = `Prix : ${affichage} €`;
		  }

		  window.addEventListener("DOMContentLoaded", function() {
			updatePrix();
		  });

		  document.getElementById("ticketNumbersCount").addEventListener("input", updatePrix);
		  document.getElementById("ticketStarsCount").addEventListener("input", updatePrix);
		  document.getElementById("numTickets").addEventListener("input", updatePrix);

		  document.getElementById("multichanceCheckbox").addEventListener("change", updatePrix);
		  document.getElementById("totalParts").addEventListener("input", updatePrix);
		  document.getElementById("yourParts").addEventListener("input", updatePrix);


			function simpleGrids(n, s) {
				return combination(n, 5) * combination(s, 2);
			}

			let gainChart = null;
			let lastY;
			let lastOdds = Infinity;
			  let firstOccurrence = {};
			  let lastDetailsModalState = "";
			  
			function updateDetailsModalIfOpen() {
			  const modal = document.getElementById('detailsModal');
			  if (modal.style.display !== 'block') return;

			  const allPaliers = [
				  {n: 5, s: 2}, {n: 5, s: 1}, {n: 5, s: 0},
				  {n: 4, s: 2}, {n: 4, s: 1}, {n: 4, s: 0},
				  {n: 3, s: 2}, {n: 3, s: 1}, {n: 3, s: 0},
				  {n: 2, s: 2}, {n: 2, s: 1}, {n: 2, s: 0},
				  {n: 1, s: 2}, {n: 1, s: 1}, {n: 1, s: 0},
				  {n: 0, s: 2}, {n: 0, s: 1}, {n: 0, s: 0}
			  ];
			  const state = allPaliers.map(({n, s}) => firstOccurrence[`${n}_${s}`] || 0);

			  const currentState = JSON.stringify(state);
			  if (currentState === lastDetailsModalState) return;
			  lastDetailsModalState = currentState;

			  const list = document.getElementById('detailsList');
			  list.innerHTML = '';
			  allPaliers.forEach(({n, s}) => {
				const key = `${n}_${s}`;
				const label = `${n} n° + ${s} ◉`;
				const li = document.createElement('li');
				if (firstOccurrence[key]) {
				  const days = firstOccurrence[key] * (7/3);
				  const when = formatTimeInDays(days, { skipSmallUnitsIfYearOrCentury: true });
				  li.textContent = `${label} : obtenu en ${when}`;
				} else {
				  li.innerHTML = `<span style="color:gray">${label} : jamais obtenu</span>`;
				}
				list.appendChild(li);
			  });
			}

			function combinationIndex(numbers, stars) {
				if (!Array.isArray(numbers) || numbers.length !== 5) return null;
				if (!Array.isArray(stars) || stars.length !== 2) return null;

				let idxNum = 0;
				let prev = 0;
				for (let i = 0; i < 5; i++) {
					for (let n = prev + 1; n < numbers[i]; n++) {
						idxNum += combination(50 - n, 5 - (i + 1));
					}
					prev = numbers[i];
				}

				let idxStar = 0;
				for (let a = 1, count = 0; a <= 12; a++) {
					for (let b = a + 1; b <= 12; b++, count++) {
						if (a === stars[0] && b === stars[1]) {
							idxStar = count;
							break;
						}
					}
					if (a === stars[0]) break;
				}

				return idxNum * combination(12, 2) + idxStar + 1;
			}


			function isValidCombinationIndex(idx) {
				return Number.isInteger(idx) && idx >= 1 && idx <= combination(50, 5) * combination(12, 2);
			}

			function combinationIndexToTicket(idx) {
				const numMax = 50, starMax = 12;
				idx--;
				const STAR_COMBOS = combination(starMax, 2);
				const pairIndexToStars = (i) => {
					let count = 0;
					for (let a = 1; a <= starMax; a++) {
						for (let b = a + 1; b <= starMax; b++) {
							if (count === i) return [a, b];
							count++;
						}
					}
					throw new Error("Invalid pair index");
				};

				const pairIdx = idx % STAR_COMBOS;
				let rank = Math.floor(idx / STAR_COMBOS);

				const nums = [];
				let prev = 0;
				for (let k = 5; k >= 1; k--) {
					let n = prev + 1;
					while (combination(numMax - n, k - 1) <= rank) {
						rank -= combination(numMax - n, k - 1);
						n++;
					}
					nums.push(n);
					prev = n;
				}
				return {
					numbers: nums,
					stars: pairIndexToStars(pairIdx)
				};
			}

			function combinationFromIndex(idx, numMax = 49, starMax = 10) {
				if (idx < 1 || idx > combination(numMax, 5) * starMax)
					throw new RangeError("Index hors bornes");

				idx--;
				const star = (idx % starMax) + 1;
				let rank = Math.floor(idx / starMax);

				const nums = [];
				let prev = 0;
				for (let k = 5; k >= 1; k--) {
					let n = prev + 1;
					while (combination(numMax - n, k - 1) <= rank) {
						rank -= combination(numMax - n, k - 1);
						n++;
					}
					nums.push(n);
					prev = n;
				}
				return { numbers: nums, stars: [star] };
			}

			function generateProbabilityExamples(N) {
				if (!Number.isFinite(N) || N <= 0) return [];

				const F = new Intl.NumberFormat("fr-FR");
				const examples = [];

				const seconds = N;
				if (seconds >= 60) {
					const minutes = seconds / 60;
					if (minutes < 60) {
						examples.push(`⏱️ C’est comme choisir 1 seconde dans ${F.format(Math.round(minutes))} ${minutes < 2 ? "minute" : "minutes"}`);
					} else {
						const hours = minutes / 60;
						if (hours < 24) {
							examples.push(`⏱️ C’est comme choisir 1 seconde dans ${F.format(Math.round(hours))} ${hours < 2 ? "heure" : "heures"}`);
						} else {
							const days = hours / 24;
							if (days < 365) {
								examples.push(`⏱️ C’est comme choisir 1 seconde dans ${F.format(Math.round(days))} ${days < 2 ? "jour" : "jours"}`);
							} else {
								const years = days / 365;
								examples.push(`⏱️ C’est comme choisir 1 seconde dans ${F.format(years.toFixed(1))} ans`);
							}
						}
					}
				}

				const flips = Math.round(Math.log2(N));
				if (flips > 1) {
					examples.push(`🪙 Réussir ${flips} lancers de pile ou face d’affilée`);
				}

				const km = N / 100_000;
				if (km >= 1) {
					examples.push(`📏 Retrouver un centimètre précis sur une route de ${F.format(Math.round(km))} km`);
				} else {
					const m = N / 100;
					if (m >= 1) {
						examples.push(`📏 Retrouver un centimètre précis sur une règle de ${F.format(Math.round(m))} m`);
					}
				}

				const BOOKS_PER_LIBRARY = 100_000;
				if (N >= 10_000 && N < BOOKS_PER_LIBRARY * 2) {
					examples.push(`📚 Piocher au hasard le bon livre parmi ${F.format(Math.round(N))} ouvrages`);
				} else if (N >= BOOKS_PER_LIBRARY * 2) {
					const libraries = Math.round(N / BOOKS_PER_LIBRARY);
					examples.push(`📚 Trouver le bon livre parmi ${libraries} bibliothèques de ${F.format(BOOKS_PER_LIBRARY)} ouvrages`);
				} else if (N >= 100) {
					examples.push(`🎱 Tirer la seule bille rouge parmi ${F.format(Math.round(N))} billes blanches`);
				}

				const stadiumCap = 80_000;
				if (N >= stadiumCap / 2 && N < stadiumCap * 2) {
					examples.push(`🏟️ Être tiré au sort parmi ${F.format(Math.round(N))} personnes`);
				} else if (N >= stadiumCap * 2 && N < 10_000_000) {
					const stades = Math.round(N / stadiumCap);
					examples.push(`🏟️ Être tiré au sort parmi ${stades} stades de ${stadiumCap.toLocaleString("fr-FR")} personnes`);
				}

				const screenPix = 2_000 * 1_000;
				if (N >= screenPix / 2 && N < BOOKS_PER_LIBRARY) {
					const ecrans = Math.round(N / screenPix);
					examples.push(`🖥️ Allumer au hasard le bon pixel parmi ${ecrans} écrans Full HD`);
				}

				const dropPerLitre = 20_000;
				if (N >= dropPerLitre * 500 && N < 1e9) {
					const litres = Math.round(N / dropPerLitre);
					examples.push(`💧 Identifier une goutte d’eau précise dans ${litres.toLocaleString("fr-FR")} litres`);
				}

				const tiragesParAn = 104;
				const daysPerDraw = 365.25 / tiragesParAn;
				const totalDays = N * daysPerDraw;
				const temps = formatTimeInDays(totalDays);
				examples.push(`⏳&nbsp;En jouant à chaque tirage, il faudrait en moyenne :<br><strong style="margin-left: 1.5em;">${temps}</strong>`);

				return examples;
			}

		  function openExamplesModal(N) {
			const modal = document.getElementById("examplesModal");
			const overlay = document.getElementById("modalOverlay");
			const content = document.getElementById("examplesContent");

			const listHTML = generateProbabilityExamples(N)
			  .map(t => `<li>${t}</li>`)
			  .join("");

			const entier = Math.round(N);
			content.innerHTML =
			  `<p style="font-size:1.3em; font-weight:bold; margin-top:5px; margin-bottom:16px;">
				<span id="chanceDisplayText">1 chance sur ${entier.toLocaleString("fr-FR")}</span>
				<span id="editOddsIcon" title="Modifier" style="cursor:pointer; margin-left:8px; vertical-align:middle;">
				  <svg width="18" height="18" fill="gray" viewBox="0 0 24 24">
					<path d="M3 17.25V21h3.75l11.02-11.02-3.75-3.75L3 17.25zM20.71 
					  7.04a1.003 1.003 0 0 0 0-1.42l-2.34-2.34a1.003 1.003 0 0 0-1.42 0l-1.83 
					  1.83 3.75 3.75 1.84-1.82z"/>
				  </svg>
				</span>
			  </p>
			  <ul>${listHTML}</ul>`;
			modal.style.display = "block";
			overlay.style.display = "block";
			
			const editIcon = document.getElementById('editOddsIcon');
			editIcon.onclick = function () {
			  const span = document.getElementById('chanceDisplayText');
			  const prevVal = span.textContent.match(/\d[\d\s]*$/);
			  const val = prevVal ? prevVal[0].replace(/\s/g, '') : '117';
			  const currentOdds = N;
			  span.innerHTML = `
				1 chance sur 
				<input id="editOddsInput" type="number" min="1" value="${val}" 
				  style="font-size:0.8em;width:150px;text-align:center;">
				<button id="editOddsOk" style="margin-left:2px;font-size:0.6em;">✔</button>
				<button id="editOddsCancel" style="margin-left:2px;font-size:0.6em;">✖</button>
			  `;

			  document.getElementById('editOddsIcon').style.display = 'none';

			  const inputField = document.getElementById('editOddsInput');
				inputField.focus();
				inputField.addEventListener('keydown', function (e) {
					if (e.key === 'Enter') {
						e.preventDefault();
						document.getElementById('editOddsOk').click();
					} else if (e.key === 'Escape') {
						e.preventDefault();
						document.getElementById('editOddsCancel').click();
					}
				});

			  document.getElementById('editOddsOk').onclick = function () {
				const nv = parseInt(document.getElementById('editOddsInput').value) || 1;
				// Remet le crayon visible
				document.getElementById('editOddsIcon').style.display = '';
				openExamplesModal(nv);
			  };
			  document.getElementById('editOddsCancel').onclick = function () {
				document.getElementById('editOddsIcon').style.display = '';
				openExamplesModal(currentOdds);
			  };
			};
		  }


			document.getElementById("closeExamplesBtn").addEventListener("click", () => {
				document.getElementById("examplesModal").style.display = "none";
				document.getElementById("modalOverlay").style.display = "none";
			});

			document.getElementById("modalOverlay").addEventListener("click", function () {
				document.getElementById("examplesModal").style.display = "none";
			});

			function savePrizeFormData() {
				const form = document.getElementById("prizesForm");
				const inputs = form.querySelectorAll("input");
				inputs.forEach(input => {
					const val = parseFloat(input.value);
					if (!isNaN(val) && val >= 0) {
						prizeMappingEditable[input.name] = val;
					}
				});

				for (const key in prizeMappingEditable) {
					prizeMapping[key] = prizeMappingEditable[key];
				}
				prizeTableModified = true;
			}

			function generateRandomGridString() {
				const numbers = generateNumbers(5, 50);
				const chance = generateNumbers(2, 12);
				return `${numbers.join(",")} ; ${chance.join(",")}`;
			}

			document.getElementById("generateGridsBtn").addEventListener("click", () => {
				const nb = parseInt(document.getElementById("nbGrillesAuto").value, 10);
				if (isNaN(nb) || nb < 1) return;
				let result = "";
				for (let i = 0; i < nb; i++) {
					result += generateRandomGridString() + "\n";
				}
				document.getElementById("customGrids").value = result.trim();
				updateChanceDisplay();
			});
			document.getElementById("clearCustomGridsBtn").addEventListener("click", () => {
				document.getElementById("customGrids").value = "";
				updateChanceDisplay();
			});

			function initGainChart() {
				const ctx = document.getElementById("gainChart").getContext("2d");

				gainChart = new Chart(ctx, {
					type: "line",
					data: {
						datasets: [{
							label: "Solde (€)",
							data: [],
							fill: false,
							borderWidth: 2,
							pointRadius: 0,
							tension: 0,
							segment: {
								borderColor: ctx => ctx.p1.parsed.y >= 0 ? "#43a047" : "#e53935"
							}
						}]
					},
					options: {
						animation: false,
						parsing: false,
						spanGaps: true,
						elements: {
							line: {
								borderCapStyle: 'round',
								borderJoinStyle: 'round'
							},
							point: {
								radius: 0
							}
						},
						plugins: {
							legend: { display: false },
							decimation: {
								enabled: true,
								algorithm: 'min-max',
								samples: 40000
							}
						},
						scales: {
							x: { type: "linear", title: { display: true, text: "Tirages" } },
							y: { title: { display: false, text: "€" } }
						}
					}
				});
			}

			let GAIN_SEUIL = 20000;
			let prizeTableModified = false;

			function updateGainChart() {
				if (!gainChart) return;

				const gainNet = balance;
				let addPoint = false;

				switch (true) {
					case (count <= 50):
						addPoint = true;
						break;
					case (count <= 200):
						addPoint = (count % 10 === 0);
						break;
					case (count <= 5000):
						addPoint = (count % 30 === 0);
						break;
					case (count <= 10000):
						addPoint = (count % 100 === 0);
						break;
					case (count <= 100000):
						addPoint = (count % 2000 === 0);
						break;
					case (count <= 1000000):
						addPoint = (count % 5000 === 0);
						break;
					case (count <= 5000000):
						addPoint = (count % 10000 === 0);
						break;
					case (count <= 20000000):
						addPoint = (count % 150000 === 0);
						break;
					case (count <= 80000000):
						addPoint = (count % 500000 === 0);
						break;
					default:
						addPoint = (count % 1000000 === 0);
						break;
				}

				if (!prizeTableModified && gainNet > 0 && lastY !== undefined && Math.abs(gainNet - lastY) >= GAIN_SEUIL) {
					addPoint = true;
				}

				if (addPoint) {
					gainChart.data.datasets[0].data.push({ x: count, y: gainNet });
					gainChart.update();
					lastY = gainNet;
				}
			}


			function resetGainChart() {
				if (!gainChart) return;
				gainChart.data.datasets[0].data = [];
				gainChart.update();
				lastY = undefined;
			}

			initGainChart();

			function indexToMyMillionCode(n) {
				const zeroBased = n - 1;
				const BLOCK_SIZE = 20000;
				const blockNumber = Math.floor(zeroBased / BLOCK_SIZE);

				const scramble = (blockNumber * 7919 + 104729) % 676;
				const firstLetter = String.fromCharCode(65 + Math.floor(scramble / 26));
				const secondLetter = String.fromCharCode(65 + (scramble % 26));

				const digits = String(zeroBased).padStart(7, "0");

				return `${firstLetter}${secondLetter} ${digits.slice(0, 3)} ${digits.slice(3)}`;
			}

			function formatMyMillion(val) {
				if (typeof val === "number") return indexToMyMillionCode(val);
				if (typeof val === "string" && val.includes(" à ")) {
					const [start, end] = val.split(" à ").map(Number);
					return `${indexToMyMillionCode(start)} à ${indexToMyMillionCode(end)}`;
				}
				return val;
			}

			let fancyDisplay = true;
			function toggleDisplayStyle() {
				fancyDisplay = !fancyDisplay;
				document.getElementById('displayFancyIcon').style.display = fancyDisplay ? 'inline-block' : 'none';
				document.getElementById('displayPlainIcon').style.display = fancyDisplay ? 'none' : 'inline-block';
				document.body.classList.toggle('plain-display', !fancyDisplay);

				refreshTicketsDisplay();
			}

			document.getElementById('displayToggle').addEventListener('click', toggleDisplayStyle);

			function simpleTextList(arr) {
				return arr.join(', ');
			}

			function adjustTicketColumns(tickets) {
				const container = document.getElementById('ticketsContainer');
				const bigTicket = tickets.some(t =>
					t.numbers.length > 15 || t.stars.length > 10
				);
				const twoCols = tickets.length > 1 && !bigTicket;
				container.classList.toggle('cols-2', twoCols);
			}

			let soundEnabled = false;
			let currentAudio = null;

			function toggleSound() {
				soundEnabled = !soundEnabled;
				document.getElementById('soundOnIcon').style.display = soundEnabled ? 'inline-block' : 'none';
				document.getElementById('soundOffIcon').style.display = soundEnabled ? 'none' : 'inline-block';
			}

			document.getElementById('soundToggle').addEventListener('click', toggleSound);

			function playSound(soundFile) {
				if (!soundEnabled) return;
				if (currentAudio) {
					currentAudio.pause();
					currentAudio = null;
				}
				currentAudio = new Audio(soundFile);
				currentAudio.play().catch((err) => {
					console.warn('Erreur de lecture audio :', err);
				});
			}

			let stats = {
				"5_2": 0, "5_1": 0, "5_0": 0,
				"4_2": 0, "4_1": 0, "4_0": 0,
				"3_2": 0, "3_1": 0, "3_0": 0,
				"2_2": 0, "2_1": 0, "2_0": 0,
				"1_2": 0, "1_1": 0, "1_0": 0,
				"0_2": 0, "0_1": 0, "0_0": 0
			};

			let myMillionWinCount = 0;
			let myMillionTotalGain = 0;

			let statsGain = {
				"5_2": 0, "5_1": 0, "5_0": 0,
				"4_2": 0, "4_1": 0, "4_0": 0,
				"3_2": 0, "3_1": 0, "3_0": 0,
				"2_2": 0, "2_1": 0, "2_0": 0,
				"1_2": 0, "1_1": 0, "1_0": 0,
				"0_2": 0, "0_1": 0, "0_0": 0
			};

			let count = 0;
			let stopFlag = false;
			let loopTimeout;
			let balance = 0;
			const ticketCost = 2.5;
			let totalGrillesJouees = 0;

			let simulationActive = false;
			let simulationHasStarted = false;

			const prizeMapping = {
				"5_2": 45000000,
				"5_1": 400000,
				"5_0": 50000,
				"4_2": 1500,
				"4_1": 150,
				"4_0": 55,
				"3_2": 75,
				"3_1": 14,
				"3_0": 11,
				"2_2": 15,
				"2_1": 8,
				"2_0": 4,
				"1_2": 7,
				"1_1": 0,
				"1_0": 0,
				"0_2": 0,
				"0_1": 0,
				"0_0": 0
			};

			const speedPresets = [
				{ batchSize: 1, speed: 1000 },
				{ batchSize: 10, speed: 500 },
				{ batchSize: 100, speed: 100 },
				{ batchSize: 500, speed: 50 },
				{ batchSize: 1000, speed: 10 },
				{ batchSize: 2000, speed: 5 },
				{ batchSize: 5000, speed: 2 },
				{ batchSize: 10000, speed: 1 },
				{ batchSize: 50000, speed: 0 },
				{ batchSize: 100000, speed: 0 },
			];

			let currentBatchSize = speedPresets[4].batchSize;
			let currentSpeed = speedPresets[4].speed;

			function combination(n, r) {
				if (r > n) return 0;
				let num = 1, den = 1;
				for (let i = 0; i < r; i++) {
					num *= (n - i);
					den *= (i + 1);
				}
				return num / den;
			}

			function costOfTicket(ticket) {
				const n = ticket.numbers.length;
				const s = ticket.stars.length;
				return combination(n, 5) * combination(s, 2) * ticketCost;
			}

			function generateNumbers(count, max) {
				let numbers = [];
				while (numbers.length < count) {
					const num = Math.floor(Math.random() * max) + 1;
					if (!numbers.includes(num)) {
						numbers.push(num);
					}
				}
				return numbers.sort((a, b) => a - b);
			}

			function getCombinations(arr, k) {
				const results = [];
				function combine(start, combo) {
					if (combo.length === k) {
						results.push(combo.slice());
						return;
					}
					for (let i = start; i < arr.length; i++) {
						combo.push(arr[i]);
						combine(i + 1, combo);
						combo.pop();
					}
				}
				combine(0, []);
				return results;
			}

			function generateTicket(numCount, starCount) {
				numCount = Math.max(5, Math.min(50, numCount));
				starCount = Math.max(2, Math.min(12, starCount));

				const ticketNumbers = generateNumbers(numCount, 50);
				const ticketStars = generateNumbers(starCount, 12);
				return { numbers: ticketNumbers, stars: ticketStars };
			}

			const freqNum = Array(51).fill(0);
			const freqStar = Array(13).fill(0);
			const MAX_RECENT_DRAWS = 70;
			const recentDraws = [];


			function pickUnique(pool, k) {
				const sac = [...pool];
				const set = new Set();
				while (set.size < k && sac.length) {
					const idx = Math.floor(Math.random() * sac.length);
					const val = sac.splice(idx, 1)[0];
					set.add(val);
				}
				return [...set].sort((a, b) => a - b);
			}

			function buildCommonRareSet(numCount = 5, starCount = 2) {
				const rareNumWanted = Math.min(
					parseInt(document.getElementById("rareNumbersCount")?.value) || 0,
					numCount, 5
				);
				const rareStarWanted = Math.min(
					parseInt(document.getElementById("rareStarsCount")?.value) || 0,
					starCount, 2
				);

				const numsByRarity = [...Array(50).keys()].map(i => i + 1)
					.sort((a, b) => freqNum[a] - freqNum[b]);
				const starsByRarity = [...Array(12).keys()].map(i => i + 1)
					.sort((a, b) => freqStar[a] - freqStar[b]);
				const minFreqNum = freqNum[numsByRarity[0]];
				const minFreqStar = freqStar[starsByRarity[0]];
				const rareNumsPool = numsByRarity.slice(0, rareNumWanted);
				const rareStarsPool = starsByRarity.slice(0, rareStarWanted);

				shuffle(rareNumsPool);
				shuffle(rareStarsPool);

				return {
					rareNums: rareNumsPool.slice(0, rareNumWanted),
					rareStars: rareStarsPool.slice(0, rareStarWanted)
				};
			}

			function generateSmartTicket(numCount = 5, starCount = 2, lotRares = null) {

				const chosenNums = lotRares ? [...lotRares.rareNums] : [];
				const chosenStars = lotRares ? [...lotRares.rareStars] : [];
				while (chosenNums.length < numCount) {
					const n = 1 + Math.floor(Math.random() * 50);
					if (!chosenNums.includes(n)) chosenNums.push(n);
				}
				while (chosenStars.length < starCount) {
					const s = 1 + Math.floor(Math.random() * 12);
					if (!chosenStars.includes(s)) chosenStars.push(s);
				}

				return {
					numbers: chosenNums.sort((a, b) => a - b),
					stars: chosenStars.sort((a, b) => a - b)
				};
			}

			function shuffle(arr) {
				for (let i = arr.length - 1; i > 0; i--) {
					const j = Math.floor(Math.random() * (i + 1));
					[arr[i], arr[j]] = [arr[j], arr[i]];
				}
			}

			function generateDraw() {
				const draw = {
					numbers: generateNumbers(5, 50),
					stars: generateNumbers(2, 12)
				};

				draw.numbers.forEach(n => freqNum[n]++);
				draw.stars.forEach(s => freqStar[s]++);

				recentDraws.push(draw);

				if (recentDraws.length > MAX_RECENT_DRAWS) {
					const old = recentDraws.shift();
					old.numbers.forEach(n => freqNum[n]--);
					old.stars.forEach(s => freqStar[s]--);
				}

				return draw;
			}

			function countMatches(arr1, arr2) {
				return arr1.filter(x => arr2.includes(x)).length;
			}

			function parseCustomInput(str) {
				return str.split(',')
					.map(s => parseInt(s.trim()))
					.filter(n => !isNaN(n));
			}

			function parseCustomGrids(str) {
				const lines = str.split('\n').filter(line => line.trim() !== '');
				const tickets = [];
				lines.forEach(line => {
					const raw = line.trim();
					if (/^\d+$/.test(raw)) {
						const idx = parseInt(raw, 10);
						if (isValidCombinationIndex(idx)) {
							const comb = combinationIndexToTicket(idx);
							tickets.push(comb);
							return;
						}
					}
					const parts = raw.split(';');
					if (parts.length === 2) {
						const numbers = parseCustomInput(parts[0]);
						const stars = parseCustomInput(parts[1]);
						if (numbers.length > 0 && stars.length > 0) {
							tickets.push({ numbers: numbers.sort((a, b) => a - b), stars: stars.sort((a, b) => a - b) });
						}
					}
				});
				return tickets;
			}


			function ballHTML(value, type) {
				const cls = type === "star" ? "star-ball" : "number-ball";
				return `<span class="${cls}">${value}</span>`;
			}

			function combinationBallHTML(val) {
				return `<span class="number-ball" style="margin-left:6px; background:#047dff; color:white; font-size:0.88em; min-width:36px;" title="Numéro unique">${val.toLocaleString('fr-FR')}</span>`;
			}

			function refreshTicketsDisplay() {
				if (!window._lastTicketsData) return;

				const { tickets, draw, myMillion } = window._lastTicketsData;

				document.getElementById("ticketsContainer").innerHTML = "";

				tickets.forEach((ticket, index) => {
					const div = document.createElement("div");
					div.className = "ticket";
					const highlightedNums = highlightMatches(ticket.numbers, draw.numbers, "number");
					const highlightedStars = highlightMatches(ticket.stars, draw.stars, "star");
					div.innerHTML = `<strong>Ticket ${index + 1} :</strong><br>
						 Numéros : ${highlightedNums}<br>
						 Étoiles : ${highlightedStars}${myMillion ? `<br>My Million : ${formatMyMillion(ticket.myMillon)}` : ""}`;
					document.getElementById("ticketsContainer").appendChild(div);
				});
			}

			function highlightMatches(values, drawValues, type) {
				const isPlain = typeof fancyDisplay !== "undefined" && !fancyDisplay;

				if (isPlain) {
					return values.map((v, i) => {
						const isMatch = drawValues.includes(v);
						let str = isMatch
							? `<span class="match">${v}</span>`
							: v;
						if (i < values.length - 1) str += ', ';
						return str;
					}).join('');
				} else {
					return values.map(v => {
						const cls = drawValues.includes(v) ? 'match' : 'semi';
						const base = ballHTML(v, type);
						return base.replace('class="', `class="${cls} `);
					}).join(' ');
				}
			}

			function balls(values, type) {
				return values.map(v => ballHTML(v, type)).join(" ");
			}

			function launchFireworks() {
				const container = document.getElementById('fireworksContainer');
				let count = 0;
				const total = 80;
				const interval = setInterval(() => {
					if (count >= total) {
						clearInterval(interval);
						return;
					}
					const firework = document.createElement('div');
					firework.classList.add('firework');
					const x = Math.random() * window.innerWidth;
					firework.style.left = x + 'px';
					firework.style.top = '0px';
					const tx = (Math.random() - 0.5) * 300;
					const ty = Math.random() * 500;
					firework.style.setProperty('--tx', tx + 'px');
					firework.style.setProperty('--ty', ty + 'px');
					const colors = [
						{ light: '#ffcc00', dark: '#ff9900' },
						{ light: '#ff3366', dark: '#cc0033' },
						{ light: '#66ccff', dark: '#3399ff' },
						{ light: '#99ff99', dark: '#33cc33' }
					];
					const chosen = colors[Math.floor(Math.random() * colors.length)];
					firework.style.setProperty('--color', chosen.light);
					firework.style.setProperty('--color-dark', chosen.dark);
					container.appendChild(firework);
					firework.addEventListener('animationend', () => {
						firework.remove();
					});
					count++;
				}, 25);
			}

			function removeLooseImages() {
				const container = document.querySelector('#looseImageContainer');
				if (container) {
					container.innerHTML = "";
				}
			}

			function addLooseImage(filename) {
				const container = document.querySelector('#looseImageContainer');
				if (!container) return;
				const img = document.createElement('img');
				img.src = filename;
				img.style.width = "1.5em";
				img.style.height = "1.5em";
				img.style.verticalAlign = "middle";
				img.style.marginLeft = "8px";
				container.appendChild(img);
			}

			function updateStatsDisplay() {
				let total = 0;
				for (let combo in stats) total += stats[combo];

				const elemMyMillion = document.getElementById("stats_myMillion");
				const valMyMillion = document.getElementById("stats_myMillion_value");
				const pctMyMillion = document.getElementById("stats_myMillion_pct");
				const gainMyMillion = document.getElementById("stats_myMillion_gain");

				if (!document.getElementById("myMillonCheckbox").checked) {
					elemMyMillion.style.display = "none";
				} else {
					elemMyMillion.style.display = "list-item";
					let percent = count > 0 ? (myMillionWinCount / count * 100) : 0;
					if (myMillionWinCount === 0 && simulationHasStarted && count > 0) {
						valMyMillion.innerHTML = `<span style='color: red;'>0</span>`;
					} else {
						valMyMillion.innerHTML = myMillionWinCount.toLocaleString('de-DE');
					}
					pctMyMillion.innerHTML = `<span style='color: gray;'>(${percent.toFixed(2)}%)</span>`;
					if (myMillionTotalGain > 0) {
						gainMyMillion.innerHTML = `<span style='color: green;'>+${myMillionTotalGain.toLocaleString('de-DE', {
							minimumFractionDigits: 2,
							maximumFractionDigits: 2
						})}€</span>`;
					} else {
						gainMyMillion.innerHTML = '';
					}
				}

				for (let combo in stats) {
					const elem = document.getElementById("stats_" + combo);
					if (elem) {
						const countValue = stats[combo];
						let pct = total > 0 ? (countValue / total * 100) : 0;
						const totalPrize = statsGain[combo];
						const totalPrizeFormatted = totalPrize.toLocaleString('de-DE', {
							minimumFractionDigits: 2,
							maximumFractionDigits: 2
						});
						const prizeDisplay = totalPrize === 0 ? "" : `<span style='color: green;'>+${totalPrizeFormatted}€</span>`;
						if (countValue === 0) {
							elem.innerHTML =
								`<span style='color: ${simulationHasStarted ? 'red' : 'black'};'>${countValue.toLocaleString('de-DE')}</span>
               <span style='color: gray;'>(${pct.toFixed(2)}%)</span>
               ${prizeDisplay}`;
						} else {
							elem.innerHTML =
								`${countValue.toLocaleString('de-DE')}
               <span style='color: gray;'>(${pct.toFixed(2)}%)</span>
               ${prizeDisplay}`;
						}
					}
				}
				let totalGain = 0;
				for (let combo in statsGain) totalGain += statsGain[combo];
				totalGain += myMillionTotalGain;

				let solde = balance;
				let totalSpent = totalGain - solde;

				let losses = -Math.abs(totalSpent);
				let gains = Math.abs(totalGain);

				document.getElementById('spentValue').innerHTML =
					`<span style="color:red;">${losses.toLocaleString('fr-FR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}&nbsp;€</span>`;
				document.getElementById('gainValue').innerHTML =
					`<span style="color:green;">+${gains.toLocaleString('fr-FR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}&nbsp;€</span>`;

				let percentLossVal = (totalSpent > 0)
					? ((totalGain / totalSpent - 1) * 100)
					: 0;
				let percentString = `(${percentLossVal >= 0 ? "+" : ""}${percentLossVal.toFixed(2)}%)`;
				document.getElementById('percentValue').innerHTML =
					`<span style="color:#888;">${percentString}</span>`;
			}

			function updateChanceDisplay() {
				const mode = document.getElementById("modeSelect").value;
				let numCount, starCount;
				if (mode === "flash") {
					numCount = parseInt(document.getElementById("ticketNumbersCount").value) || 5;
					starCount = parseInt(document.getElementById("ticketStarsCount").value) || 2;
				} else {
					const customGridsText = document.getElementById("customGrids").value;
					const grids = parseCustomGrids(customGridsText);
					if (grids.length > 0) {
						numCount = grids[0].numbers.length;
						starCount = grids[0].stars.length;
					} else {
						numCount = 5;
						starCount = 2;
					}
				}
				numCount = Math.max(5, Math.min(50, numCount));
				starCount = Math.max(2, Math.min(12, starCount));
				const numTickets = mode === "flash" ? (parseInt(document.getElementById("numTickets").value) || 1) : 1;
				const stopNumbers = parseInt(document.getElementById("stopNumbers").value) ?? 5;
				const stopStars = parseInt(document.getElementById("stopStars").value) ?? 2;

				function computeChance(numCount, starCount, stopNumbers, stopStars) {
					let probNum = 0;
					for (let k = stopNumbers; k <= Math.min(numCount, 5); k++) {
						probNum += combination(numCount, k) * combination(50 - numCount, 5 - k) / combination(50, 5);
					}
					let probStars = 0;
					for (let l = stopStars; l <= Math.min(starCount, 2); l++) {
						probStars += combination(starCount, l) * combination(12 - starCount, 2 - l) / combination(12, 2);
					}
					return probNum * probStars;
				}

				let pGlobal = 0;

				if (mode === "flash") {
					const pTicket = computeChance(numCount, starCount, stopNumbers, stopStars);
					pGlobal = 1 - Math.pow(1 - pTicket, numTickets);
				} else {
					const customGridsText = document.getElementById("customGrids").value;
					const grids = parseCustomGrids(customGridsText);
					for (let g of grids) {
						const pTicket = computeChance(g.numbers.length, g.stars.length, stopNumbers, stopStars);
						pGlobal += pTicket;
					}
				}
				const percent = (pGlobal * 100).toFixed(8);
				const reciprocalFormatted = pGlobal > 0
					? Math.floor(1 / pGlobal).toLocaleString('fr-FR')
					: "∞";
				lastOdds = pGlobal > 0 ? 1 / pGlobal : Infinity;
				const POSSIBILITIES = 5_000_000;

				let totalSimpleGrids = 0;
				if (mode === "flash") {
					totalSimpleGrids = simpleGrids(numCount, starCount) * numTickets;
				} else {
					parseCustomGrids(document.getElementById("customGrids").value)
						.forEach(g => totalSimpleGrids += simpleGrids(g.numbers.length, g.stars.length));
				}

				const pMy = 1 - Math.pow(1 - 1 / POSSIBILITIES, totalSimpleGrids);
				const pctMy = (pMy * 100).toFixed(8);
				const invMy = pMy > 0
					? (1 / pMy).toLocaleString('de-DE', { maximumFractionDigits: 0 })
					: "∞";

				const lignes = [
					`Taux de chance (pour au moins ${stopNumbers} n° et ${stopStars} ★) : ${percent}%`
				];

				const probLine =
					`1 chance sur ${reciprocalFormatted} - `
					+ (isFinite(lastOdds)
						? ` <a id="examplesLink" href="#" style="color:#187ad2;">Exemples concrets</a>`
						: "");

				lignes.push(probLine);

				if (document.getElementById("myMillonCheckbox").checked) {
					lignes.push(
						`1 chance sur ${invMy} (My&nbsp;Million)
			 <span class="info-icon"
				            title="Estimation approximative : 
Varie selon le nombre réel de grilles jouées à chaque tirage.">i</span>`
					);
				}

				document.getElementById("chanceDisplay").innerHTML = lignes.join("<br>");
				const link = document.getElementById("examplesLink");
				if (link) {
					link.addEventListener("click", function (e) {
						e.preventDefault();
						openExamplesModal(lastOdds);
					});
				}

			}
			
				function formatTimeInDays(totalDays, options = {}) {
	  const { skipSmallUnitsIfYearOrCentury = false } = options;
	  const joursTotal = Math.floor(totalDays);
	  let centuries = Math.floor(joursTotal / 36500);
	  let reste = joursTotal % 36500;
	  let years = Math.floor(reste / 365);
	  reste = reste % 365;
	  let months = Math.floor(reste / 30.4375);
	  reste = Math.floor(reste % 30.4375);
	  let weeks = Math.floor(reste / 7);
	  let days = reste % 7;

	  const w = typeof window !== "undefined" ? window.innerWidth : 1200;
	  const parts = [];

	  if (centuries > 0) parts.push(centuries + ' ' + (centuries === 1 ? 'siècle' : 'siècles'));
	  if (years > 0) parts.push(years + ' ' + (years === 1 ? 'an' : 'ans'));
	  if (months > 0) parts.push(months + ' mois');

	  const hasBigUnit = centuries > 0 || years > 0;
	  let showWeeks = true, showDays = true;
	  if (skipSmallUnitsIfYearOrCentury && hasBigUnit) {
		showWeeks = false;
		showDays = false;
	  } else {
		if (w > 785 && w < 1000 && centuries > 0) showWeeks = false;
		if (w > 785 && ((w < 1000 && centuries > 0) || (w < 1200 && years > 0))) showDays = false;
	  }

	  if (weeks > 0 && showWeeks) parts.push(weeks + ' ' + (weeks === 1 ? 'semaine' : 'semaines'));
	  if (days > 0 && showDays) parts.push(days + ' ' + (days === 1 ? 'jour' : 'jours'));

	  return parts.length === 0 ? "0 jour" : parts.join(", ");
	}

			function updateTimePassed(drawCount) {
				const days = drawCount * (7 / 2);
				const formatted = formatTimeInDays(days);
				document.getElementById("timePassed").textContent = "Temps écoulé : " + formatted;
			}

			window.addEventListener("resize", () => updateTimePassed(count));

			function updateGainDisplay() {
				const formatted = balance.toLocaleString('de-DE', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
				const gainElem = document.getElementById("gainDisplay");
				let imageContainer = document.getElementById("looseImageContainer");
				if (!imageContainer) {
					imageContainer = document.createElement("span");
					imageContainer.id = "looseImageContainer";
				}
				if (balance >= 0) {
					gainElem.innerHTML = `Solde : <span style='color: green;'>${formatted} €</span>`;
				} else {
					gainElem.innerHTML = `Solde : <span style='color: red;'>${formatted} €</span>`;
				}
				gainElem.appendChild(imageContainer);
				updateGainChart();
			}

			document.querySelectorAll("#ticketNumbersCount, #ticketStarsCount, #numTickets, #stopNumbers, #stopStars, #customGrids, #stopAfterYearsInput, #stopAfterYearsCheckbox")
				.forEach(input => {
					input.addEventListener("input", updateChanceDisplay);
				});
			updateChanceDisplay();
			document.getElementById("stopBtn").style.display = "none";

			document.getElementById("multichanceCheckbox").addEventListener("change", function () {
				const partsContainer = document.getElementById("multichancePartsContainer");
				partsContainer.style.display = this.checked ? "block" : "none";
			});

			document.getElementById("myMillonCheckbox").addEventListener("change", function () {
				document.getElementById("stopMyMillonWinGroup").style.display = this.checked ? "block" : "none";
				updateStatsDisplay();
				updateChanceDisplay();
			});

			document.getElementById("smartDrawCheckbox").addEventListener("change", function () {
				const block = document.getElementById("smartDrawSettings");
				block.style.display = this.checked ? "block" : "none";
			});


			document.getElementById("modeSelect").addEventListener("change", function () {
				const mode = this.value;
				const flash = document.getElementById("flashSettings");
				const custom = document.getElementById("customSettings");
				const ticketsGrp = document.getElementById("ticketsCountGroup");
				const multiGrp = document.getElementById("multichanceCheckbox").parentNode;
				const multiParts = document.getElementById("multichancePartsContainer");
				const smartChk = document.getElementById("smartDrawCheckbox").parentNode;
				const smartSet = document.getElementById("smartDrawSettings");

				if (mode === "flash") {
					flash.style.display = "block";
					custom.style.display = "none";
					ticketsGrp.style.display = "block";
					multiGrp.style.display = "block";
					multiParts.style.display = document.getElementById("multichanceCheckbox").checked
						? "block" : "none";
					smartChk.style.display = "block";
					smartSet.style.display = document.getElementById("smartDrawCheckbox").checked
						? "block" : "none";
				} else {
					flash.style.display = "none";
					custom.style.display = "block";
					ticketsGrp.style.display = "none";
					multiGrp.style.display = "none";
					multiParts.style.display = "none";
					smartChk.style.display = "none";
					smartSet.style.display = "none";
				}
				updateChanceDisplay();
			});



			const speedSlider = document.getElementById("speedSlider");
			const speedValueLabel = document.getElementById("speedValueLabel");

			function updateSpeedFromSlider(value) {
				const sliderVal = parseInt(value, 10);
				if (sliderVal <= 50) {
					currentBatchSize = 1;
					currentSpeed = Math.round(1000 - (sliderVal - 1) * (999 / 49));
				} else if (sliderVal <= 70) {
					let ratio = (sliderVal - 50) / 20;
					currentBatchSize = Math.round(1 + ratio * (200 - 1));
					currentSpeed = 1;
				} else {
					let ratio = (sliderVal - 70) / 30;
					currentBatchSize = Math.round(200 + ratio * (2000 - 200));
					currentSpeed = Math.round(1 - ratio * 1);
				}
				speedValueLabel.textContent = `(Tirage = ${currentBatchSize}, Délai = ${currentSpeed} ms)`;
			}

			updateSpeedFromSlider(speedSlider.value);
			speedSlider.addEventListener("input", function () {
				updateSpeedFromSlider(this.value);
			});

			function runLoop() {
				removeLooseImages();
				if (stopFlag) return;
				simulationActive = true;

				const mode = document.getElementById("modeSelect").value;
				let multichanceRatio = 1;
				if (mode === "flash" && document.getElementById("multichanceCheckbox").checked) {
					const totalParts = parseInt(document.getElementById("totalParts").value) || 0;
					const yourParts = parseInt(document.getElementById("yourParts").value) || 0;
					if (yourParts > totalParts) {
						alert("Erreur : Votre nombre de parts ne peut pas dépasser le total de parts (" + totalParts + ").");
						stopFlag = true;
						document.getElementById("startBtn").style.display = "block";
						simulationActive = false;
						return;
					}
					multichanceRatio = yourParts / totalParts;
				}
				let tickets = [];
				let draw = null;
				let customTickets = [];
				if (mode === "custom") {
					const customGridsText = document.getElementById("customGrids").value;
					customTickets = parseCustomGrids(customGridsText);
				}
				const numCount = mode === "flash"
					? (parseInt(document.getElementById("ticketNumbersCount").value) || 5)
					: (customTickets.length > 0 ? customTickets[0].numbers.length : 5);
				const starCount = mode === "flash"
					? (parseInt(document.getElementById("ticketStarsCount").value) || 2)
					: (customTickets.length > 0 ? customTickets[0].stars.length : 2);
				const numTickets = mode === "flash"
					? (parseInt(document.getElementById("numTickets").value) || 1)
					: (customTickets.length > 0 ? customTickets.length : 1);
				let lotRares = null;
				if (document.getElementById("smartDrawCheckbox").checked) {
					lotRares = buildCommonRareSet(numCount, starCount);
				}

				const simpleGridsPerTicket = combination(
					Math.max(5, Math.min(50, numCount)),
					5
				) * combination(
					Math.max(2, Math.min(12, starCount)),
					2
				);
				const stopNumbers = parseInt(document.getElementById("stopNumbers").value) || 0;
				const stopStars = parseInt(document.getElementById("stopStars").value) || 0;
				const stopAfterYearsChecked = document.getElementById("stopAfterYearsCheckbox").checked;
				const stopAfterYearsValue = parseInt(document.getElementById("stopAfterYearsInput").value) || 100;
				const batchSize = currentBatchSize;
				const speed = currentSpeed;

				const stopMyMillonWin = document.getElementById("stopMyMillonWinCheckbox").checked;

				for (let i = 0; i < batchSize; i++) {
					count++;
					totalGrillesJouees += numTickets * simpleGridsPerTicket;
					tickets = [];
					for (let j = 0; j < numTickets; j++) {
						if (mode === "flash") {
							if (document.getElementById("smartDrawCheckbox").checked) {
								tickets.push(generateSmartTicket(numCount, starCount, lotRares));
							} else {
								tickets.push(generateTicket(numCount, starCount));
							}
						} else {
							if (customTickets.length > 0) {
								tickets.push(customTickets[j % customTickets.length]);
							}
						}
					}
					if (mode === "flash") {
						let costPerTicket = simpleGridsPerTicket * ticketCost;
						if (document.getElementById("multichanceCheckbox").checked) {
							costPerTicket *= multichanceRatio;
						}
						balance -= numTickets * costPerTicket;
					} else {
						tickets.forEach(ticket => {
							balance -= costOfTicket(ticket);
						});
					}
					draw = generateDraw();

					let myMillionJustWon = false;
					if (document.getElementById("myMillonCheckbox").checked) {
						let possibilities = (count % 2 === 0) ? 4000000 : 6000000;
						let assignedRanges = [];
						tickets.forEach(ticket => {
							let n = ticket.numbers.length;
							let s = ticket.stars.length;
							let numGrilles = combination(n, 5) * combination(s, 2);
							if (numGrilles > 1) {
								let baseNumber;
								let attempt = 0;
								const maxAttempts = 100;
								do {
									baseNumber = Math.floor(Math.random() * (possibilities - numGrilles + 1)) + 1;
									attempt++;
									var conflict = assignedRanges.some(range =>
										baseNumber <= range.end && (baseNumber + numGrilles - 1) >= range.start
									);
								} while (conflict && attempt < maxAttempts);
								let rangeEnd = baseNumber + numGrilles;
								assignedRanges.push({ start: baseNumber, end: rangeEnd });
								ticket.myMillon = baseNumber + " à " + rangeEnd;
							} else {
								let candidate;
								let attempt = 0;
								const maxAttempts = 100;
								do {
									candidate = Math.floor(Math.random() * possibilities) + 1;
									attempt++;
									var conflict = assignedRanges.some(range =>
										candidate >= range.start && candidate <= range.end
									);
								} while (conflict && attempt < maxAttempts);
								assignedRanges.push({ start: candidate, end: candidate });
								ticket.myMillon = candidate;
							}
						});
						draw.myMillon = Math.floor(Math.random() * possibilities) + 1;

						let myMillonWin = tickets.some(ticket => {
							if (typeof ticket.myMillon === "string" && ticket.myMillon.includes(" à ")) {
								let [start, end] = ticket.myMillon.split(" à ").map(Number);
								return draw.myMillon >= start && draw.myMillon <= end;
							} else {
								return ticket.myMillon === draw.myMillon;
							}
						});

						if (myMillonWin) {
							myMillionWinCount++;
							let myMillonPrize = 1000000;
							if (document.getElementById("multichanceCheckbox").checked) {
								const totalParts = parseInt(document.getElementById("totalParts").value) || 1;
								const yourParts = parseInt(document.getElementById("yourParts").value) || 1;
								myMillonPrize = 1000000 * (yourParts / totalParts);
							}
							balance += myMillonPrize;
							myMillionTotalGain += myMillonPrize;
							updateStatsDisplay();

							myMillionJustWon = true;
							if (stopMyMillonWin) {
								const tempsEcoule = formatTimeInDays(count * (7 / 2));
								alert("Option My Millon gagnée !\n" + "Temps écoulé : " + tempsEcoule + "\n" + "My Million : " + formatMyMillion(draw.myMillon) + "\nGain : " + myMillonPrize.toLocaleString('de-DE', { maximumFractionDigits: 0 }) + " €");

								if (balance >= 1) {
									playSound("win.mp3");
								} else if (balance <= -1000000) {
									playSound("bigloose.mp3");
									addLooseImage("bigloose.jpeg");
								}

								if (gainChart) {
									gainChart.data.datasets[0].data.push({ x: count, y: balance });
									gainChart.update();
								}

								stopFlag = true;
								simulationActive = false;
								document.getElementById("startBtn").style.display = "inline-block";
								document.getElementById("startBtn").textContent = "Nouvelle simulation";
								document.getElementById("stopBtn").style.display = "inline-block";
								document.getElementById("stopBtn").textContent = "Continuer";

								document.getElementById("ticketsContainer").innerHTML = "";

								tickets.forEach((ticket, index) => {
									const div = document.createElement("div");
									let isWinning = false;
									if (typeof ticket.myMillon === "string" && ticket.myMillon.includes(" à ")) {
										let [start, end] = ticket.myMillon.split(" à ").map(Number);
										if (draw.myMillon >= start && draw.myMillon <= end) {
											isWinning = true;
										}
									} else if (ticket.myMillon === draw.myMillon) {
										isWinning = true;
									}
									div.className = "ticket" + (isWinning ? " winning" : "");
									const highlightedNums = highlightMatches(ticket.numbers, draw.numbers, "number");
									const highlightedStars = highlightMatches(ticket.stars, draw.stars, "star");
									let myMillionDisplay = formatMyMillion(ticket.myMillon);
									if (isWinning) {
										myMillionDisplay = `<span style="color: green; font-weight: bold;">${formatMyMillion(ticket.myMillon)}</span>`;
									}
									let ticketIndexHTML = "";
									if (
										ticket.numbers?.length === 5 &&
										ticket.stars?.length === 2 &&
										document.getElementById("showCombinationNumber")?.checked
									) {
										const idxUnikTicket = combinationIndex(ticket.numbers, ticket.stars);
										ticketIndexHTML = ` <span style="color:gray; font-size:0.95em; font-weight:normal;">
								 (${idxUnikTicket.toLocaleString('fr-FR')})
							   </span>`;
									}

									div.innerHTML = `
			<strong>Ticket ${index + 1}${ticketIndexHTML} :</strong><br>
			Numéros : ${highlightedNums}<br>
			Étoiles  : ${highlightedStars}<br>
			My Million : ${myMillionDisplay}`;

									document.getElementById("ticketsContainer").appendChild(div);
								});

								const isPlain = typeof fancyDisplay !== "undefined" && !fancyDisplay;
								document.getElementById("resultat").innerHTML =
									`<strong>
				  Tirage${(draw.numbers?.length === 5 && draw.stars?.length === 2 && document.getElementById("showCombinationNumber")?.checked)
										? ` <span style="color:gray; font-size:0.95em; font-weight:normal;">(${combinationIndex(draw.numbers, draw.stars).toLocaleString('fr-FR')})</span>`
										: ""} :
			   </strong><br>
	   Numéros : ${isPlain ? simpleTextList(draw.numbers) : balls(draw.numbers, "number")}<br>
	   Étoiles : ${isPlain ? simpleTextList(draw.stars) : balls(draw.stars, "star")}<br>
	   My Million : ${formatMyMillion(draw.myMillon)}`;
								document.getElementById("counter").textContent = "Tirages : " + count.toLocaleString('de-DE');
								document.getElementById("grillesPlayed").textContent = "Grilles jouées : " + totalGrillesJouees.toLocaleString('de-DE');
								updateTimePassed(count);
								updateStatsDisplay();
								updateGainDisplay();
								return;
							}
						}
					}
					updateGainChart();

					if (stopAfterYearsChecked) {
						const currentYears = (count * 3.5) / 365;
						if (currentYears >= stopAfterYearsValue) {
							document.getElementById("ticketsContainer").innerHTML = "";
							const isPlain = typeof fancyDisplay !== "undefined" && !fancyDisplay;
							document.getElementById("resultat").innerHTML =
								`<strong>
				  Tirage${(draw.numbers?.length === 5 && draw.stars?.length === 2 && document.getElementById("showCombinationNumber")?.checked)
									? ` <span style="color:gray; font-size:0.95em; font-weight:normal;">(${combinationIndex(draw.numbers, draw.stars).toLocaleString('fr-FR')})</span>`
									: ""} :
			   </strong><br>
			   Numéros : ${isPlain ? simpleTextList(draw.numbers) : balls(draw.numbers, "number")}<br>
			   Étoiles : ${isPlain ? simpleTextList(draw.stars) : balls(draw.stars, "star")}${document.getElementById("myMillonCheckbox").checked ? "<br>My Million : " + formatMyMillion(draw.myMillon) : ""}`;

							document.getElementById("counter").textContent = "Tirages : " + count.toLocaleString('de-DE');
							document.getElementById("grillesPlayed").textContent = "Grilles jouées : " + totalGrillesJouees.toLocaleString('de-DE');
							updateTimePassed(count);
							updateStatsDisplay();
							updateGainDisplay();
							alert("On a dépassé les " + stopAfterYearsValue + " ans de simulation !\n(Nombre de tirages : " + count.toLocaleString('de-DE') + ")");

							if (balance >= 1) {
								playSound("win.mp3");
							} else if (balance <= -1000000) {
								playSound("bigloose.mp3");
								addLooseImage("bigloose.jpeg");
							}

							if (gainChart) {
								gainChart.data.datasets[0].data.push({ x: count, y: balance });
								gainChart.update();
								lastY = balance;
							}

							stopFlag = true;
							simulationActive = false;
							document.getElementById("startBtn").style.display = "inline-block";
							document.getElementById("startBtn").textContent = "Nouvelle simulation";
							document.getElementById("stopBtn").style.display = "inline-block";
							document.getElementById("stopBtn").textContent = "Continuer";
							return;
						}
					}

					let foundWinningTicket = false;
					let winningTicket = null;
					tickets.forEach(ticket => {
						const n = ticket.numbers.length;
						const s = ticket.stars.length;

						const numGood = countMatches(ticket.numbers, draw.numbers);
						const numBad = n - numGood;
						const starGood = countMatches(ticket.stars, draw.stars);
						const starBad = s - starGood;

						for (let nb = 0; nb <= Math.min(5, n); nb++) {
							for (let sb = 0; sb <= Math.min(2, s); sb++) {
								const waysNum = combination(numGood, nb) * combination(numBad, 5 - nb);
								const waysStar = combination(starGood, sb) * combination(starBad, 2 - sb);
								const countGrilles = waysNum * waysStar;
								if (countGrilles > 0) {
									const key = nb + "_" + sb;
									if (stats.hasOwnProperty(key)) {
									  const prevCount = stats[key];
									  stats[key] += countGrilles;
									  if (prevCount === 0 && countGrilles > 0) {
										firstOccurrence[key] = count;
										updateDetailsModalIfOpen();
									  }
									}
									let prize = prizeMapping[key] || 0;
									if (document.getElementById("multichanceCheckbox").checked) {
										prize *= multichanceRatio;
									}
									balance += prize * countGrilles;
									statsGain[key] += prize * countGrilles;

									if (!foundWinningTicket && nb >= stopNumbers && sb >= stopStars && countGrilles > 0) {
										foundWinningTicket = true;
										winningTicket = ticket;
									}
								}
							}
						}
					});


					if (foundWinningTicket) {
						document.getElementById("ticketsContainer").innerHTML = "";
						adjustTicketColumns(tickets);
						tickets.forEach((ticket, index) => {
							const div = document.createElement("div");
							div.className = "ticket";
							const highlightedNums = highlightMatches(ticket.numbers, draw.numbers, "number");
							const highlightedStars = highlightMatches(ticket.stars, draw.stars, "star");
							let ticketLabel = `<strong>Ticket ${index + 1}</strong>`;
							const showIdx = document.getElementById("showCombinationNumber")?.checked;
							if (showIdx && ticket.stars.length === 2 && ticket.numbers.length === 5) {
								const combIdx = combinationIndex(ticket.numbers, ticket.stars);
								ticketLabel += ` <span style="color:gray; font-size:0.95em; font-weight:normal;">(${combIdx.toLocaleString('fr-FR')})</span>`;
							}
							div.innerHTML = `${ticketLabel} :<br>
						 Numéros : ${highlightedNums}<br>
						 Étoiles : ${highlightedStars}${document.getElementById("myMillonCheckbox").checked ? "<br>Code Loto : " + formatMyMillion(ticket.myMillon) : ""}`;
							document.getElementById("ticketsContainer").appendChild(div);
							if (ticket === winningTicket) {
								div.classList.add("winning");
							}
							document.getElementById("ticketsContainer").appendChild(div);
						});

						let tirageLabel = `<strong>Tirage</strong>`;
						if (
							document.getElementById("showCombinationNumber")?.checked
							&& draw.numbers.length === 5
							&& draw.stars.length === 2
						) {
							const idx = combinationIndex(draw.numbers, draw.stars);
							tirageLabel += ` <span style="color:gray; font-size:0.95em; font-weight:normal;">(${idx.toLocaleString('fr-FR')})</span>`;
						}

						const isPlain = typeof fancyDisplay !== "undefined" && !fancyDisplay;
						document.getElementById("resultat").innerHTML =
							`${tirageLabel} :<br>` +
							`Numéros : ${isPlain ? simpleTextList(draw.numbers) : balls(draw.numbers, "number")}<br>` +
							`Étoiles : ${isPlain ? simpleTextList(draw.stars) : balls(draw.stars, "star")}` +
							(document.getElementById("myMillonCheckbox").checked
								? `<br>My Million : ${formatMyMillion(draw.myMillon)}`
								: "");


						document.getElementById("counter").textContent = "Tirages : " + count.toLocaleString('de-DE');
						document.getElementById("grillesPlayed").textContent = "Grilles jouées : " + totalGrillesJouees.toLocaleString('de-DE');
						updateTimePassed(count);
						updateStatsDisplay();
						updateGainDisplay();

						const winningMatchNumbers = countMatches(winningTicket.numbers, draw.numbers);
						const winningMatchStars = countMatches(winningTicket.stars, draw.stars);
						const winningKey = winningMatchNumbers + "_" + winningMatchStars;
						let winningGain = prizeMapping[winningKey] || 0;
						if (document.getElementById("multichanceCheckbox").checked) {
							winningGain *= multichanceRatio;
						}
						if (winningMatchNumbers === 5 && winningMatchStars === 2) {
							launchFireworks();
						}
						const tempsEcoule = formatTimeInDays(count * (7 / 2));
						alert("Seuil atteint !\n" +
							"Ticket gagnant : " + winningTicket.numbers.join(", ") + " | " + winningTicket.stars.join(", ") + "\n" +
							"Tirage : " + draw.numbers.join(", ") + " | " + draw.stars.join(", ") + "\n" +
							"Nombre de tirages : " + count.toLocaleString('de-DE') + "\n" +
							"Temps écoulé : " + tempsEcoule + "\n" +
							"Gain : " + winningGain.toLocaleString('de-DE', { maximumFractionDigits: 0 }) + " €");

						if (balance >= 1) {
							playSound("win.mp3");
						} else if (balance <= -1000000) {
							playSound("bigloose.mp3");
							addLooseImage("bigloose.jpeg");
						}

						if (gainChart) {
							gainChart.data.datasets[0].data.push({ x: count, y: balance });
							gainChart.update();
							lastY = balance;
						}

						stopFlag = true;
						simulationActive = false;
						document.getElementById("startBtn").style.display = "inline-block";
						document.getElementById("startBtn").textContent = "Nouvelle simulation";
						document.getElementById("stopBtn").style.display = "inline-block";
						document.getElementById("stopBtn").textContent = "Continuer";

						return;
					}

					if (document.getElementById("stopNegativeGainCheckbox").checked) {
						const seuil = parseFloat(document.getElementById("stopNegativeGainThreshold").value) || 0;

						if (seuil < 0) {
							if (balance < seuil) {
								document.getElementById("ticketsContainer").innerHTML = "";
								adjustTicketColumns(tickets);
								const isPlain = typeof fancyDisplay !== "undefined" && !fancyDisplay;
								document.getElementById("resultat").innerHTML =
									`<strong>Tirage :</strong><br>
					 Numéros : ${isPlain ? simpleTextList(draw.numbers) : balls(draw.numbers, "number")}<br>
					 Étoiles : ${isPlain ? simpleTextList(draw.stars) : balls(draw.stars, "star")}${document.getElementById("myMillonCheckbox").checked ? "<br>Code Loto : " + formatMyMillion(draw.myMillon) : ""}`;

								document.getElementById("counter").textContent = "Tirages : " + count.toLocaleString('de-DE');
								document.getElementById("grillesPlayed").textContent = "Grilles jouées : " + totalGrillesJouees.toLocaleString('de-DE');
								updateTimePassed(count);
								updateStatsDisplay();
								updateGainDisplay();
								alert("Le solde est passé en dessous du seuil défini (" + seuil + " €). La simulation est arrêtée.");

								if (balance >= 1) {
									playSound("win.mp3");
								} else if (balance <= -1000000) {
									playSound("bigloose.mp3");
									addLooseImage("bigloose.jpeg");
								}
								stopFlag = true;
								simulationActive = false;
								document.getElementById("startBtn").style.display = "inline-block";
								document.getElementById("startBtn").textContent = "Nouvelle simulation";
								document.getElementById("stopBtn").style.display = "inline-block";
								document.getElementById("stopBtn").textContent = "Continuer";
								return;
							}
						} else {
							if (balance > seuil) {
								document.getElementById("ticketsContainer").innerHTML = "";
								adjustTicketColumns(tickets);
								const isPlain = typeof fancyDisplay !== "undefined" && !fancyDisplay;
								document.getElementById("resultat").innerHTML =
									`<strong>Tirage :</strong><br>
					 Numéros : ${isPlain ? simpleTextList(draw.numbers) : balls(draw.numbers, "number")}<br>
					 Étoiles : ${isPlain ? simpleTextList(draw.stars) : balls(draw.stars, "star")}${document.getElementById("myMillonCheckbox").checked ? "<br>Code Loto : " + formatMyMillion(draw.myMillon) : ""}`;

								document.getElementById("counter").textContent = "Tirages : " + count.toLocaleString('de-DE');
								document.getElementById("grillesPlayed").textContent = "Grilles jouées : " + totalGrillesJouees.toLocaleString('de-DE');
								updateTimePassed(count);
								updateStatsDisplay();
								updateGainDisplay();
								alert("Le solde a dépassé le seuil défini (" + seuil + " €). La simulation est arrêtée.");

								if (balance >= 1) {
									playSound("win.mp3");
								} else if (balance <= -1000000) {
									playSound("bigloose.mp3");
									addLooseImage("bigloose.jpeg");
								}
								stopFlag = true;
								simulationActive = false;
								document.getElementById("startBtn").style.display = "inline-block";
								document.getElementById("startBtn").textContent = "Nouvelle simulation";
								document.getElementById("stopBtn").style.display = "inline-block";
								document.getElementById("stopBtn").textContent = "Continuer";
								return;
							}
						}
					}

				}

				document.getElementById("ticketsContainer").innerHTML = "";
				adjustTicketColumns(tickets);
				tickets.forEach((ticket, index) => {
					const div = document.createElement("div");
					div.className = "ticket";

					const highlightedNums = highlightMatches(ticket.numbers, draw.numbers, "number");
					const highlightedStars = highlightMatches(ticket.stars, draw.stars, "star");

					let ticketIndexHTML = "";
					if (
						ticket.numbers?.length === 5 &&
						ticket.stars?.length === 2 &&
						document.getElementById("showCombinationNumber")?.checked
					) {

						const idxUnikTicket = combinationIndex(ticket.numbers, ticket.stars);
						ticketIndexHTML = ` <span style="color:gray; font-size:0.95em; font-weight:normal;">
								 (${idxUnikTicket.toLocaleString('fr-FR')})
							   </span>`;
					}

					div.innerHTML = `
			<strong>Ticket ${index + 1}${ticketIndexHTML} :</strong><br>
			Numéros : ${highlightedNums}<br>
			Étoiles  : ${highlightedStars}
			${document.getElementById("myMillonCheckbox").checked
							? `<br>My Million : ${formatMyMillion(ticket.myMillon)}`
							: ""}
		  `;

					document.getElementById("ticketsContainer").appendChild(div);
				});

				window._lastTicketsData = {
					tickets: tickets,
					draw: draw,
					myMillion: document.getElementById("myMillonCheckbox").checked
				};

				const isPlain = typeof fancyDisplay !== "undefined" && !fancyDisplay;
				document.getElementById("resultat").innerHTML =
					`<strong>
      Tirage${(draw.numbers?.length === 5 && draw.stars?.length === 2 && document.getElementById("showCombinationNumber")?.checked)
						? ` <span style="color:gray; font-size:0.95em; font-weight:normal;">(${combinationIndex(draw.numbers, draw.stars).toLocaleString('fr-FR')})</span>`
						: ""} :
   </strong><br>
	   Numéros : ${isPlain ? simpleTextList(draw.numbers) : balls(draw.numbers, "number")}<br>
	   Étoiles : ${isPlain ? simpleTextList(draw.stars) : balls(draw.stars, "star")}${document.getElementById("myMillonCheckbox").checked ? "<br>My Million : " + formatMyMillion(draw.myMillon) : ""}`;

				document.getElementById("counter").textContent = "Tirages : " + count.toLocaleString('de-DE');
				document.getElementById("grillesPlayed").textContent = "Grilles jouées : " + totalGrillesJouees.toLocaleString('de-DE');
				updateTimePassed(count);
				updateStatsDisplay();
				updateGainDisplay();

				loopTimeout = setTimeout(runLoop, speed);
			}

			function startDrawing() {
				simulationHasStarted = true;
				resetGainChart();

				if (document.getElementById("modeSelect").value === "flash" && document.getElementById("multichanceCheckbox").checked) {
					const totalParts = parseInt(document.getElementById("totalParts").value) || 0;
					const yourParts = parseInt(document.getElementById("yourParts").value) || 0;
					if (yourParts > totalParts) {
						alert("Erreur : Votre nombre de parts (" + yourParts + ") ne peut pas dépasser le total de parts (" + totalParts + ").");
						return;
					}
				}
				clearTimeout(loopTimeout);
				count = 0;
				stopFlag = false;
				balance = 0;
				totalGrillesJouees = 0;
				for (let combo in stats) {
					stats[combo] = 0;
					statsGain[combo] = 0;
				}
				firstOccurrence = {};
				myMillionWinCount = 0;
				myMillionTotalGain = 0;
				simulationActive = true;
				document.getElementById("counter").textContent = "Tirages : 0";
				document.getElementById("grillesPlayed").textContent = "Grilles jouées : 0";
				document.getElementById("timePassed").textContent = "Temps écoulé : 0 jour";
				document.getElementById("gainDisplay").innerHTML = "<span style='color: green;'>Solde : 0,00 €</span>";
				document.getElementById("ticketsContainer").innerHTML = "";
				document.getElementById("resultat").innerHTML = `<strong>Tirage :</strong><br>Numéros : --<br>Étoiles : --`;
				document.getElementById("stopBtn").textContent = "Stop";
				updateStatsDisplay();
				updateTimePassed(0);
				updateGainDisplay();
				removeLooseImages();
				document.getElementById("startBtn").style.display = "none";
				document.getElementById("stopBtn").style.display = "inline-block";
				runLoop();
			}

			document.getElementById("myMillonCheckbox").checked = true;
			document.getElementById("stopMyMillonWinCheckbox").checked = false;
			document.getElementById("stopMyMillonWinGroup").style.display = "block";

			document.getElementById("startBtn").addEventListener("click", startDrawing);
			document.getElementById("stopBtn").addEventListener("click", function () {
				if (!stopFlag) {
					stopFlag = true;
					simulationActive = false;
					clearTimeout(loopTimeout);
					this.textContent = "Continuer";
				} else {
					stopFlag = false;
					simulationActive = true;
					this.textContent = "Stop";
					runLoop();
					if (simulationActive) {
						document.getElementById("startBtn").style.display = "none";
					}
				}
				updateStatsDisplay();
			});
			document.getElementById("resetBtn").addEventListener("click", function () {
				stopFlag = true;
				simulationHasStarted = false;
				clearTimeout(loopTimeout);
				count = 0;
				totalGrillesJouees = 0;
				for (let combo in stats) {
					stats[combo] = 0;
					statsGain[combo] = 0;
				}
				myMillionWinCount = 0;
				myMillionTotalGain = 0;
				simulationActive = false;
				updateStatsDisplay();
				document.getElementById("counter").textContent = "Tirages : 0";
				document.getElementById("grillesPlayed").textContent = "Grilles jouées : 0";
				document.getElementById("timePassed").textContent = "Temps écoulé : 0 jour";
				document.getElementById("gainDisplay").innerHTML = "<span style='color: green;'>Solde : 0,00 €</span>";
				document.getElementById("ticketsContainer").innerHTML = "";
				document.getElementById("resultat").innerHTML = `<strong>Tirage :</strong><br>Numéros : --<br>Étoiles : --`;
				document.getElementById("startBtn").textContent = "Démarrer la simulation";
				document.getElementById("startBtn").style.display = "inline-block";
				document.getElementById("stopBtn").style.display = "none";
				removeLooseImages();
				resetGainChart();
			});

			updateStatsDisplay();

			document.getElementById("ticketStarsCount").addEventListener("blur", function () {
				let v = parseInt(this.value) || 2;
				if (v < 2) v = 2;
				if (v > 12) v = 12;
				this.value = v;
			});
			document.getElementById("ticketNumbersCount").addEventListener("blur", function () {
				let v = parseInt(this.value) || 5;
				if (v < 5) v = 5;
				if (v > 50) v = 50;
				this.value = v;
			});

			const prizeMappingEditable = { ...prizeMapping };

			document.getElementById("editPrizesLink").addEventListener("click", function (e) {
				e.preventDefault();
				const form = document.getElementById("prizesForm");
				form.innerHTML = "";
				form.style.display = "flex";
				form.style.flexWrap = "wrap";
				form.style.justifyContent = "center";
				form.style.gap = "20px";

				const keys = Object.keys(prizeMappingEditable);
				const mid = Math.ceil(keys.length / 2);
				const leftKeys = keys.slice(0, mid);
				const rightKeys = keys.slice(mid);

				const reorderedKeys = [];
				for (let i = 0; i < mid; i++) {
					if (leftKeys[i]) reorderedKeys.push(leftKeys[i]);
					if (rightKeys[i]) reorderedKeys.push(rightKeys[i]);
				}

				reorderedKeys.forEach(key => {
					const label = document.createElement("label");
					label.textContent = `${key.replace("_", " n° + ")} ★ :`;

					const input = document.createElement("input");
					input.type = "number";
					input.step = "1.0";
					input.min = "0";
					input.name = key;
					input.value = prizeMappingEditable[key];
					input.style.width = "120px";

					const div = document.createElement("div");
					div.style.display = "flex";
					div.style.justifyContent = "space-between";
					div.style.alignItems = "center";
					div.style.gap = "10px";

					div.appendChild(label);
					div.appendChild(input);
					form.appendChild(div);
				});


				document.getElementById("prizesModal").style.display = "block";
				document.getElementById("modalOverlay").style.display = "block";
			});

			document.getElementById("closePrizesBtn").addEventListener("click", function () {
				savePrizeFormData();
				document.getElementById("prizesModal").style.display = "none";
				document.getElementById("modalOverlay").style.display = "none";
			});
			document.getElementById("resetPrizesBtn").addEventListener("click", function () {
				const defaultPrizes = {
					"5_2": 45000000,
					"5_1": 400000,
					"5_0": 50000,
					"4_2": 1500,
					"4_1": 150,
					"4_0": 55,
					"3_2": 75,
					"3_1": 14,
					"3_0": 11,
					"2_2": 15,
					"2_1": 8,
					"2_0": 4,
					"1_2": 7,
					"1_1": 0,
					"1_0": 0,
					"0_2": 0,
					"0_1": 0,
					"0_0": 0
				};

				for (const key in defaultPrizes) {
					prizeMappingEditable[key] = defaultPrizes[key];
					prizeMapping[key] = defaultPrizes[key];
				}

				const form = document.getElementById("prizesForm");
				const inputs = form.querySelectorAll("input");
				inputs.forEach(input => {
					if (defaultPrizes.hasOwnProperty(input.name)) {
						input.value = defaultPrizes[input.name];
					}
				});
				prizeTableModified = false;
			});

			document.getElementById("modalOverlay").addEventListener("click", function () {
				savePrizeFormData();
				document.getElementById("prizesModal").style.display = "none";
				this.style.display = "none";
				document.body.style.overflow = "";
			});

			const link = document.getElementById("examplesLink");
			if (link) {
				link.addEventListener("click", function (e) {
					e.preventDefault();
					openExamplesModal(lastOdds);
				});
			}
		document.getElementById('showDetails').addEventListener('click', e => {
		  e.preventDefault();
		  const list = document.getElementById('detailsList');
		  list.innerHTML = '';

		const allPaliers = [
		  {n: 5, s: 2}, {n: 5, s: 1}, {n: 5, s: 0},
		  {n: 4, s: 2}, {n: 4, s: 1}, {n: 4, s: 0},
		  {n: 3, s: 2}, {n: 3, s: 1}, {n: 3, s: 0},
		  {n: 2, s: 2}, {n: 2, s: 1}, {n: 2, s: 0},
		  {n: 1, s: 2}, {n: 1, s: 1}, {n: 1, s: 0},
		  {n: 0, s: 2}, {n: 0, s: 1}, {n: 0, s: 0}
		];

		allPaliers.forEach(({n, s}) => {
		  const key = `${n}_${s}`;
		  const label = `${n} n° + ${s} ◉`;
		  const li = document.createElement('li');
		  if (firstOccurrence[key]) {
			const days = firstOccurrence[key] * (7/2);
			const when = formatTimeInDays(days, { skipSmallUnitsIfYearOrCentury: true });
			li.textContent = `${label} : obtenu en ${when}`;
		  } else {
			li.innerHTML = `<span style="color:gray">${label} : jamais obtenu</span>`;
		  }
		  list.appendChild(li);
		});


		  document.getElementById('modalOverlayDetails').style.display = 'block';
		  document.getElementById('detailsModal').style.display = 'block';
		});

		document.getElementById('closeDetailsBtn').addEventListener('click', () => {
		  document.getElementById('detailsModal').style.display = 'none';
		  document.getElementById('modalOverlayDetails').style.display = 'none';
		});
		document.getElementById('modalOverlayDetails').addEventListener('click', () => {
		  document.getElementById('detailsModal').style.display = 'none';
		  document.getElementById('modalOverlayDetails').style.display = 'none';
		});
		</script>
</body>

</html>